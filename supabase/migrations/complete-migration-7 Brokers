-- ============================================================================
-- FINOTAUR - Multi-Broker Integration Database Schema
-- Version: 3.0.0 - SMART MIGRATION (Compatible with existing schema)
-- ============================================================================
-- 
-- This migration intelligently handles:
-- ‚úÖ Existing broker_connections table with 'broker' text column
-- ‚úÖ Creates new tables only if they don't exist
-- ‚úÖ Adds missing columns without breaking existing data
-- ‚úÖ Fixes constraints to support all brokers
-- ‚úÖ Safe to run multiple times (idempotent)
--
-- ============================================================================

-- ============================================================================
-- STEP 0: FIX CRITICAL CONSTRAINTS ON TRADES TABLE FIRST
-- ============================================================================

-- Add 'tradovate' and all other brokers to broker constraint
ALTER TABLE trades DROP CONSTRAINT IF EXISTS trades_broker_check;
ALTER TABLE trades ADD CONSTRAINT trades_broker_check 
  CHECK (broker = ANY (ARRAY[
    'manual'::text, 
    'interactive_brokers'::text, 
    'td_ameritrade'::text, 
    'alpaca'::text, 
    'tradingview'::text, 
    'mt4'::text, 
    'mt5'::text, 
    'ninja_trader'::text,
    'tradovate'::text,
    'rithmic'::text,
    'topstepx'::text,
    'tradelocker'::text,
    'bybit'::text,
    'binance'::text,
    'schwab'::text,
    'robinhood'::text,
    'snaptrade'::text,
    'sierra_chart'::text,
    'dxtrade'::text,
    'colmexpro'::text
  ]));

-- Add 'tradovate' and other sources to import_source constraint
ALTER TABLE trades DROP CONSTRAINT IF EXISTS check_import_source;
ALTER TABLE trades ADD CONSTRAINT check_import_source 
  CHECK (import_source = ANY (ARRAY[
    'manual'::text, 
    'snaptrade'::text, 
    'csv'::text, 
    'api'::text,
    'tradovate'::text,
    'broker_sync'::text,
    'webhook'::text,
    'rithmic'::text,
    'ninja_trader'::text
  ]));

-- ============================================================================
-- STEP 1: BROKER DEFINITIONS - Master list of all supported brokers
-- ============================================================================

CREATE TABLE IF NOT EXISTS broker_definitions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Basic Info
    name VARCHAR(100) NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    slug VARCHAR(50) NOT NULL,
    description TEXT,
    logo_url TEXT,
    website_url TEXT,
    
    -- Broker Type & Category
    broker_type VARCHAR(50) NOT NULL DEFAULT 'broker',
    -- Types: 'broker', 'prop_firm', 'exchange', 'platform', 'data_provider'
    
    asset_classes TEXT[] DEFAULT ARRAY['futures'],
    -- Options: 'futures', 'stocks', 'options', 'forex', 'crypto', 'cfd'
    
    -- Authentication Configuration
    auth_method VARCHAR(50) NOT NULL DEFAULT 'credentials',
    -- Methods: 'credentials', 'oauth2', 'api_key', 'csv_import', 'mt4_mt5'
    
    auth_config JSONB DEFAULT '{}',
    -- Stores auth-specific config like OAuth URLs, required fields, etc.
    
    -- API Configuration
    api_config JSONB DEFAULT '{}',
    -- Stores API endpoints, rate limits, etc.
    
    -- Features & Capabilities
    features JSONB DEFAULT '{}',
    
    -- Data Mapping Configuration
    data_mapping JSONB DEFAULT '{}',
    -- Maps broker-specific fields to our standard trade format
    
    -- Status & Availability
    is_active BOOLEAN DEFAULT true,
    is_beta BOOLEAN DEFAULT false,
    requires_subscription VARCHAR(20) DEFAULT 'FREE',
    -- Subscription levels: 'FREE', 'BASIC', 'PREMIUM'
    
    -- Regional Availability
    supported_regions TEXT[] DEFAULT ARRAY['US', 'EU', 'GLOBAL'],
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add unique constraints if they don't exist
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'broker_definitions_name_key') THEN
        ALTER TABLE broker_definitions ADD CONSTRAINT broker_definitions_name_key UNIQUE (name);
    END IF;
    IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'broker_definitions_slug_key') THEN
        ALTER TABLE broker_definitions ADD CONSTRAINT broker_definitions_slug_key UNIQUE (slug);
    END IF;
END $$;

-- Indexes for quick lookups
CREATE INDEX IF NOT EXISTS idx_broker_definitions_slug ON broker_definitions(slug);
CREATE INDEX IF NOT EXISTS idx_broker_definitions_active ON broker_definitions(is_active);
CREATE INDEX IF NOT EXISTS idx_broker_definitions_type ON broker_definitions(broker_type);

-- ============================================================================
-- STEP 2: UPDATE EXISTING BROKER_CONNECTIONS TABLE
-- ============================================================================
-- Your existing table has: id, user_id, broker (text), status, account_id, 
-- account_name, connected_at, last_sync_at, error_message, access_token,
-- refresh_token, expires_at, metadata, created_at, updated_at
--
-- We need to ADD missing columns without breaking existing functionality

-- Add broker_id reference to broker_definitions (optional, for new connections)
ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS broker_id UUID REFERENCES broker_definitions(id) ON DELETE SET NULL;

-- Add connection identification
ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS connection_name VARCHAR(100);

-- Add environment (demo/live/paper/simulated)
ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS environment VARCHAR(20) DEFAULT 'demo';

-- Add connection metadata (in addition to existing 'metadata' column)
ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS connection_data JSONB DEFAULT '{}';

-- Add status management columns
ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS status_message TEXT;

ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS last_error TEXT;

ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS last_error_at TIMESTAMPTZ;

ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS error_count INTEGER DEFAULT 0;

-- Add sync configuration
ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS auto_sync_enabled BOOLEAN DEFAULT true;

ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS sync_interval_minutes INTEGER DEFAULT 15;

ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS last_successful_sync_at TIMESTAMPTZ;

-- Add activity tracking
ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true;

ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS disconnected_at TIMESTAMPTZ;

-- Add encrypted credentials storage
ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS credentials_encrypted BYTEA;

ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS credentials_iv BYTEA;

-- Add token_expires_at if it doesn't exist (you might have expires_at)
ALTER TABLE broker_connections 
ADD COLUMN IF NOT EXISTS token_expires_at TIMESTAMPTZ;

-- Indexes for broker_connections
CREATE INDEX IF NOT EXISTS idx_broker_connections_user ON broker_connections(user_id);
CREATE INDEX IF NOT EXISTS idx_broker_connections_broker ON broker_connections(broker);
CREATE INDEX IF NOT EXISTS idx_broker_connections_broker_id ON broker_connections(broker_id);
CREATE INDEX IF NOT EXISTS idx_broker_connections_status ON broker_connections(status);
CREATE INDEX IF NOT EXISTS idx_broker_connections_active ON broker_connections(user_id, is_active);
CREATE INDEX IF NOT EXISTS idx_broker_connections_environment ON broker_connections(user_id, broker, environment);

-- ============================================================================
-- STEP 3: BROKER ACCOUNTS - Individual trading accounts within a connection
-- ============================================================================

CREATE TABLE IF NOT EXISTS broker_accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    connection_id UUID NOT NULL REFERENCES broker_connections(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    
    -- Account Identification
    broker_account_id VARCHAR(100) NOT NULL, -- ID from the broker
    account_name VARCHAR(100),
    account_number VARCHAR(100),
    
    -- Account Type
    account_type VARCHAR(50) DEFAULT 'individual',
    -- Options: 'individual', 'joint', 'ira', 'corporate', 'prop', 'funded', 'evaluation'
    
    account_subtype VARCHAR(50),
    -- Options: 'margin', 'cash', 'futures', 'options', etc.
    
    -- Currency & Base Info
    base_currency VARCHAR(10) DEFAULT 'USD',
    timezone VARCHAR(50) DEFAULT 'America/New_York',
    
    -- Account Status from Broker
    broker_status VARCHAR(50),
    -- Example: 'active', 'inactive', 'suspended', 'closed'
    
    -- Balance Snapshot (updated on sync)
    balance_snapshot JSONB DEFAULT '{}',
    -- Example: {
    --   "cash_balance": 50000.00,
    --   "buying_power": 100000.00,
    --   "equity": 52000.00,
    --   "margin_used": 5000.00,
    --   "margin_available": 45000.00,
    --   "open_pnl": 1500.00,
    --   "realized_pnl_today": 500.00,
    --   "updated_at": "2024-01-15T10:30:00Z"
    -- }
    
    -- Account Metadata
    account_data JSONB DEFAULT '{}',
    -- Stores additional broker-specific account info
    
    -- Selection & Display
    is_primary BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    display_order INTEGER DEFAULT 0,
    
    -- Sync Status
    last_sync_at TIMESTAMPTZ,
    sync_status VARCHAR(30) DEFAULT 'pending',
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add unique constraint if doesn't exist
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'broker_accounts_connection_id_broker_account_id_key') THEN
        ALTER TABLE broker_accounts ADD CONSTRAINT broker_accounts_connection_id_broker_account_id_key 
        UNIQUE(connection_id, broker_account_id);
    END IF;
END $$;

-- Indexes
CREATE INDEX IF NOT EXISTS idx_broker_accounts_connection ON broker_accounts(connection_id);
CREATE INDEX IF NOT EXISTS idx_broker_accounts_user ON broker_accounts(user_id);
CREATE INDEX IF NOT EXISTS idx_broker_accounts_primary ON broker_accounts(user_id, is_primary);
CREATE INDEX IF NOT EXISTS idx_broker_accounts_active ON broker_accounts(connection_id, is_active);

-- ============================================================================
-- STEP 4: BROKER SYNC LOGS - Detailed logging of sync operations
-- ============================================================================

CREATE TABLE IF NOT EXISTS broker_sync_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    connection_id UUID NOT NULL REFERENCES broker_connections(id) ON DELETE CASCADE,
    account_id UUID REFERENCES broker_accounts(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    
    -- Sync Operation Details
    sync_type VARCHAR(50) NOT NULL,
    -- Types: 'full', 'incremental', 'positions', 'orders', 'fills', 'balance', 'manual'
    
    sync_trigger VARCHAR(50) NOT NULL DEFAULT 'manual',
    -- Triggers: 'manual', 'scheduled', 'realtime', 'webhook', 'login'
    
    -- Time Range Synced
    sync_from_date TIMESTAMPTZ,
    sync_to_date TIMESTAMPTZ,
    
    -- Results
    status VARCHAR(30) NOT NULL DEFAULT 'started',
    -- Options: 'started', 'in_progress', 'completed', 'partial', 'failed', 'cancelled'
    
    -- Counts
    records_fetched INTEGER DEFAULT 0,
    records_created INTEGER DEFAULT 0,
    records_updated INTEGER DEFAULT 0,
    records_skipped INTEGER DEFAULT 0,
    records_failed INTEGER DEFAULT 0,
    
    -- Details
    sync_details JSONB DEFAULT '{}',
    -- Example: {
    --   "fills_synced": 15,
    --   "positions_synced": 3,
    --   "new_trades": 10,
    --   "updated_trades": 5
    -- }
    
    -- Error Information
    error_message TEXT,
    error_details JSONB,
    
    -- Timing
    started_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    duration_ms INTEGER,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_broker_sync_logs_connection ON broker_sync_logs(connection_id);
CREATE INDEX IF NOT EXISTS idx_broker_sync_logs_account ON broker_sync_logs(account_id);
CREATE INDEX IF NOT EXISTS idx_broker_sync_logs_user ON broker_sync_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_broker_sync_logs_status ON broker_sync_logs(status);
CREATE INDEX IF NOT EXISTS idx_broker_sync_logs_created ON broker_sync_logs(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_broker_sync_logs_type ON broker_sync_logs(sync_type);

-- ============================================================================
-- STEP 5: BROKER RAW DATA - Store raw data from brokers for debugging/replay
-- ============================================================================

CREATE TABLE IF NOT EXISTS broker_raw_data (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sync_log_id UUID REFERENCES broker_sync_logs(id) ON DELETE CASCADE,
    connection_id UUID NOT NULL REFERENCES broker_connections(id) ON DELETE CASCADE,
    
    -- Data Type
    data_type VARCHAR(50) NOT NULL,
    -- Types: 'fill', 'order', 'position', 'balance', 'margin', 'contract'
    
    -- Raw Data
    broker_record_id VARCHAR(100), -- Original ID from broker
    raw_data JSONB NOT NULL,
    
    -- Processing Status
    is_processed BOOLEAN DEFAULT false,
    processed_at TIMESTAMPTZ,
    processing_error TEXT,
    
    -- Link to Created Record
    created_trade_id UUID,
    
    -- Timestamps
    broker_timestamp TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_broker_raw_data_connection ON broker_raw_data(connection_id);
CREATE INDEX IF NOT EXISTS idx_broker_raw_data_sync_log ON broker_raw_data(sync_log_id);
CREATE INDEX IF NOT EXISTS idx_broker_raw_data_type ON broker_raw_data(data_type);
CREATE INDEX IF NOT EXISTS idx_broker_raw_data_processed ON broker_raw_data(is_processed);
CREATE INDEX IF NOT EXISTS idx_broker_raw_data_broker_id ON broker_raw_data(broker_record_id);
CREATE INDEX IF NOT EXISTS idx_broker_raw_data_created ON broker_raw_data(created_at DESC);

-- ============================================================================
-- STEP 6: ADD BROKER COLUMNS TO TRADES TABLE
-- ============================================================================

DO $$
BEGIN
    -- Broker Connection Reference
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'broker_connection_id') THEN
        ALTER TABLE trades ADD COLUMN broker_connection_id UUID REFERENCES broker_connections(id) ON DELETE SET NULL;
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'broker_account_id') THEN
        ALTER TABLE trades ADD COLUMN broker_account_id UUID REFERENCES broker_accounts(id) ON DELETE SET NULL;
    END IF;
    
    -- Broker Identification
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'broker_name') THEN
        ALTER TABLE trades ADD COLUMN broker_name VARCHAR(50);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'broker_trade_id') THEN
        ALTER TABLE trades ADD COLUMN broker_trade_id VARCHAR(100);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'broker_order_id') THEN
        ALTER TABLE trades ADD COLUMN broker_order_id VARCHAR(100);
    END IF;
    
    -- Contract Information (for Futures)
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'contract_id') THEN
        ALTER TABLE trades ADD COLUMN contract_id VARCHAR(100);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'contract_name') THEN
        ALTER TABLE trades ADD COLUMN contract_name VARCHAR(100);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'contract_month') THEN
        ALTER TABLE trades ADD COLUMN contract_month VARCHAR(20);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'underlying_symbol') THEN
        ALTER TABLE trades ADD COLUMN underlying_symbol VARCHAR(20);
    END IF;
    
    -- Instrument Details (check if they already exist)
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'tick_size') THEN
        ALTER TABLE trades ADD COLUMN tick_size DECIMAL(18, 8);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'tick_value') THEN
        ALTER TABLE trades ADD COLUMN tick_value DECIMAL(18, 4);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'point_value') THEN
        ALTER TABLE trades ADD COLUMN point_value DECIMAL(18, 4);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'contract_multiplier') THEN
        ALTER TABLE trades ADD COLUMN contract_multiplier DECIMAL(18, 4) DEFAULT 1;
    END IF;
    
    -- Execution Details
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'execution_id') THEN
        ALTER TABLE trades ADD COLUMN execution_id VARCHAR(100);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'order_type') THEN
        ALTER TABLE trades ADD COLUMN order_type VARCHAR(30);
    END IF;
    
    -- Sync Metadata
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'synced_at') THEN
        ALTER TABLE trades ADD COLUMN synced_at TIMESTAMPTZ;
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'sync_source') THEN
        ALTER TABLE trades ADD COLUMN sync_source VARCHAR(30);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                   WHERE table_name = 'trades' AND column_name = 'raw_data') THEN
        ALTER TABLE trades ADD COLUMN raw_data JSONB;
    END IF;
END $$;

-- Indexes for broker columns on trades
CREATE INDEX IF NOT EXISTS idx_trades_broker_connection ON trades(broker_connection_id);
CREATE INDEX IF NOT EXISTS idx_trades_broker_account ON trades(broker_account_id);
CREATE INDEX IF NOT EXISTS idx_trades_broker_name ON trades(broker_name) WHERE broker_name IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_trades_broker_trade_id ON trades(broker_trade_id) WHERE broker_trade_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_trades_synced_at ON trades(synced_at) WHERE synced_at IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_trades_external_id_broker ON trades(external_id) WHERE external_id IS NOT NULL;

-- ============================================================================
-- STEP 7: INSTRUMENT DEFINITIONS - Master list of tradeable instruments
-- ============================================================================

CREATE TABLE IF NOT EXISTS instrument_definitions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Identification
    symbol VARCHAR(50) NOT NULL,
    name VARCHAR(200),
    description TEXT,
    
    -- Classification
    asset_class VARCHAR(30) NOT NULL,
    -- Options: 'futures', 'stocks', 'options', 'forex', 'crypto', 'cfd', 'etf', 'index'
    
    instrument_type VARCHAR(50),
    -- Options: 'perpetual', 'quarterly', 'monthly', 'spot', 'forward'
    
    -- Exchange & Product
    exchange VARCHAR(50),
    exchange_symbol VARCHAR(50),
    product_code VARCHAR(20),
    
    -- Contract Specifications
    tick_size DECIMAL(18, 8),
    tick_value DECIMAL(18, 4),
    point_value DECIMAL(18, 4),
    contract_size DECIMAL(18, 4),
    
    -- Currency
    currency VARCHAR(10) DEFAULT 'USD',
    quote_currency VARCHAR(10),
    
    -- Trading Hours (stored as JSON)
    trading_hours JSONB,
    -- Example: {
    --   "timezone": "America/Chicago",
    --   "sessions": [
    --     {"day": "sunday", "open": "17:00", "close": "16:00"},
    --     {"day": "monday", "open": "17:00", "close": "16:00"}
    --   ]
    -- }
    
    -- Margin Requirements
    margin_requirements JSONB,
    -- Example: {
    --   "initial": 6600,
    --   "maintenance": 6000,
    --   "day_trade": 500
    -- }
    
    -- Status
    is_active BOOLEAN DEFAULT true,
    is_tradeable BOOLEAN DEFAULT true,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add unique constraint if doesn't exist
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'instrument_definitions_symbol_exchange_key') THEN
        ALTER TABLE instrument_definitions ADD CONSTRAINT instrument_definitions_symbol_exchange_key 
        UNIQUE(symbol, exchange);
    END IF;
END $$;

-- Indexes
CREATE INDEX IF NOT EXISTS idx_instrument_definitions_symbol ON instrument_definitions(symbol);
CREATE INDEX IF NOT EXISTS idx_instrument_definitions_asset_class ON instrument_definitions(asset_class);
CREATE INDEX IF NOT EXISTS idx_instrument_definitions_exchange ON instrument_definitions(exchange);
CREATE INDEX IF NOT EXISTS idx_instrument_definitions_active ON instrument_definitions(is_active);

-- ============================================================================
-- STEP 8: SEED DATA - Pre-populate broker definitions
-- ============================================================================

INSERT INTO broker_definitions (
    name, display_name, slug, description, broker_type, asset_classes,
    auth_method, auth_config, api_config, features, is_active, is_beta
) VALUES 
-- Tradovate
(
    'Tradovate',
    'Tradovate',
    'tradovate',
    'Commission-free futures trading platform',
    'broker',
    ARRAY['futures'],
    'credentials',
    '{
        "fields": ["username", "password", "device_id"],
        "optional_fields": ["cid", "sec"],
        "supports_mfa": true
    }'::jsonb,
    '{
        "demo_api_url": "https://demo.tradovateapi.com/v1",
        "live_api_url": "https://live.tradovateapi.com/v1",
        "demo_ws_url": "wss://demo.tradovateapi.com/v1/websocket",
        "live_ws_url": "wss://live.tradovateapi.com/v1/websocket",
        "rate_limit": 120,
        "rate_limit_window": 60
    }'::jsonb,
    '{
        "realtime_sync": true,
        "historical_sync": true,
        "positions": true,
        "orders": true,
        "account_balance": true,
        "margin_info": true,
        "trade_execution": false
    }'::jsonb,
    true,
    false
),

-- NinjaTrader
(
    'NinjaTrader',
    'NinjaTrader',
    'ninjatrader',
    'Advanced charting and trading platform for futures',
    'platform',
    ARRAY['futures'],
    'credentials',
    '{
        "fields": ["username", "password"],
        "connection_type": "rithmic"
    }'::jsonb,
    '{
        "connection_types": ["rithmic", "continuum"],
        "supports_demo": true
    }'::jsonb,
    '{
        "realtime_sync": true,
        "historical_sync": true,
        "positions": true,
        "orders": true,
        "account_balance": true,
        "margin_info": true
    }'::jsonb,
    true,
    true
),

-- Interactive Brokers
(
    'Interactive Brokers',
    'Interactive Brokers (IBKR)',
    'interactive-brokers',
    'Global electronic brokerage firm',
    'broker',
    ARRAY['stocks', 'options', 'futures', 'forex', 'crypto'],
    'oauth2',
    '{
        "oauth_url": "https://www.interactivebrokers.com/oauth",
        "client_portal_url": "https://localhost:5000",
        "gateway_required": true
    }'::jsonb,
    '{
        "api_type": "client_portal",
        "websocket_url": "wss://localhost:5000/v1/api/ws"
    }'::jsonb,
    '{
        "realtime_sync": true,
        "historical_sync": true,
        "positions": true,
        "orders": true,
        "account_balance": true,
        "margin_info": true,
        "trade_execution": true
    }'::jsonb,
    true,
    true
),

-- Rithmic
(
    'Rithmic',
    'Rithmic',
    'rithmic',
    'Professional trading infrastructure for futures',
    'data_provider',
    ARRAY['futures'],
    'credentials',
    '{
        "fields": ["username", "password", "server"],
        "servers": ["Rithmic Paper Trading", "Rithmic 01", "Rithmic 04"]
    }'::jsonb,
    '{
        "protocol": "rithmic_protocol_buffer"
    }'::jsonb,
    '{
        "realtime_sync": true,
        "historical_sync": true,
        "positions": true,
        "orders": true,
        "account_balance": true,
        "margin_info": true
    }'::jsonb,
    true,
    true
),

-- TopstepX
(
    'TopstepX',
    'TopstepX',
    'topstepx',
    'Funded trader program using Tradovate infrastructure',
    'prop_firm',
    ARRAY['futures'],
    'credentials',
    '{
        "fields": ["username", "password"],
        "uses_tradovate_api": true
    }'::jsonb,
    '{
        "base_broker": "tradovate",
        "api_url": "https://api.topstepx.com"
    }'::jsonb,
    '{
        "realtime_sync": true,
        "historical_sync": true,
        "positions": true,
        "orders": true,
        "account_balance": true
    }'::jsonb,
    true,
    true
),

-- MetaTrader 5
(
    'MetaTrader 5',
    'MetaTrader 5 (MT5)',
    'metatrader5',
    'Multi-asset trading platform',
    'platform',
    ARRAY['forex', 'stocks', 'futures', 'crypto', 'cfd'],
    'csv_import',
    '{
        "import_formats": ["mt5_history", "mt5_statement"],
        "fields": ["server", "login", "password"]
    }'::jsonb,
    '{
        "requires_terminal": true,
        "export_path": "~/AppData/Roaming/MetaQuotes/Terminal"
    }'::jsonb,
    '{
        "realtime_sync": false,
        "historical_sync": true,
        "csv_import": true,
        "positions": true
    }'::jsonb,
    true,
    true
),

-- TradeLocker
(
    'TradeLocker',
    'TradeLocker',
    'tradelocker',
    'Modern prop trading platform',
    'prop_firm',
    ARRAY['futures', 'forex', 'crypto'],
    'api_key',
    '{
        "fields": ["api_key", "api_secret"]
    }'::jsonb,
    '{
        "api_url": "https://api.tradelocker.com",
        "websocket_url": "wss://ws.tradelocker.com"
    }'::jsonb,
    '{
        "realtime_sync": true,
        "historical_sync": true,
        "positions": true,
        "orders": true,
        "account_balance": true
    }'::jsonb,
    true,
    true
),

-- Bybit
(
    'Bybit',
    'Bybit',
    'bybit',
    'Cryptocurrency derivatives exchange',
    'exchange',
    ARRAY['crypto'],
    'api_key',
    '{
        "fields": ["api_key", "api_secret"],
        "supports_subaccounts": true
    }'::jsonb,
    '{
        "api_url": "https://api.bybit.com",
        "testnet_url": "https://api-testnet.bybit.com",
        "websocket_url": "wss://stream.bybit.com/v5/private"
    }'::jsonb,
    '{
        "realtime_sync": true,
        "historical_sync": true,
        "positions": true,
        "orders": true,
        "account_balance": true,
        "trade_execution": true
    }'::jsonb,
    true,
    false
),

-- Binance
(
    'Binance',
    'Binance',
    'binance',
    'World''s largest cryptocurrency exchange',
    'exchange',
    ARRAY['crypto'],
    'api_key',
    '{
        "fields": ["api_key", "api_secret"],
        "supports_subaccounts": true
    }'::jsonb,
    '{
        "spot_url": "https://api.binance.com",
        "futures_url": "https://fapi.binance.com",
        "testnet_url": "https://testnet.binancefuture.com",
        "websocket_url": "wss://fstream.binance.com"
    }'::jsonb,
    '{
        "realtime_sync": true,
        "historical_sync": true,
        "positions": true,
        "orders": true,
        "account_balance": true,
        "trade_execution": true
    }'::jsonb,
    true,
    false
),

-- Sierra Chart
(
    'Sierra Chart',
    'Sierra Chart',
    'sierra-chart',
    'Professional trading platform with advanced charting',
    'platform',
    ARRAY['futures', 'stocks'],
    'csv_import',
    '{
        "import_formats": ["sierra_trade_log", "sierra_activity_log"],
        "data_feed_options": ["denali", "teton"]
    }'::jsonb,
    '{
        "export_path": "SierraChart/Data"
    }'::jsonb,
    '{
        "realtime_sync": false,
        "historical_sync": true,
        "csv_import": true
    }'::jsonb,
    true,
    true
),

-- TradingView
(
    'TradingView',
    'TradingView',
    'tradingview',
    'Popular charting platform with broker integrations',
    'platform',
    ARRAY['stocks', 'futures', 'forex', 'crypto'],
    'csv_import',
    '{
        "import_formats": ["tradingview_export"]
    }'::jsonb,
    '{
        "chart_url": "https://www.tradingview.com"
    }'::jsonb,
    '{
        "realtime_sync": false,
        "historical_sync": true,
        "csv_import": true
    }'::jsonb,
    true,
    true
),

-- Charles Schwab
(
    'Charles Schwab',
    'Charles Schwab',
    'charles-schwab',
    'Major US brokerage firm (includes TD Ameritrade)',
    'broker',
    ARRAY['stocks', 'options', 'futures', 'etf'],
    'oauth2',
    '{
        "oauth_url": "https://api.schwabapi.com/v1/oauth"
    }'::jsonb,
    '{
        "api_url": "https://api.schwabapi.com"
    }'::jsonb,
    '{
        "realtime_sync": true,
        "historical_sync": true,
        "positions": true,
        "orders": true,
        "account_balance": true
    }'::jsonb,
    true,
    true
),

-- Robinhood
(
    'Robinhood',
    'Robinhood',
    'robinhood',
    'Commission-free stock and crypto trading',
    'broker',
    ARRAY['stocks', 'options', 'crypto'],
    'csv_import',
    '{
        "import_formats": ["robinhood_export"],
        "notes": "API access limited, CSV import recommended"
    }'::jsonb,
    '{}',
    '{
        "realtime_sync": false,
        "historical_sync": true,
        "csv_import": true
    }'::jsonb,
    true,
    true
),

-- ColmexPro
(
    'ColmexPro',
    'ColmexPro',
    'colmexpro',
    'Prop trading and forex broker',
    'prop_firm',
    ARRAY['forex', 'cfd'],
    'credentials',
    '{
        "fields": ["username", "password"]
    }'::jsonb,
    '{
        "platform": "metatrader"
    }'::jsonb,
    '{
        "realtime_sync": false,
        "historical_sync": true,
        "csv_import": true
    }'::jsonb,
    true,
    true
),

-- DXtrade
(
    'DXtrade',
    'DXtrade',
    'dxtrade',
    'Multi-asset trading platform by Devexperts',
    'platform',
    ARRAY['forex', 'cfd', 'crypto'],
    'credentials',
    '{
        "fields": ["username", "password", "server"]
    }'::jsonb,
    '{}',
    '{
        "realtime_sync": true,
        "historical_sync": true,
        "positions": true
    }'::jsonb,
    true,
    true
)

ON CONFLICT (slug) DO UPDATE SET
    display_name = EXCLUDED.display_name,
    description = EXCLUDED.description,
    broker_type = EXCLUDED.broker_type,
    asset_classes = EXCLUDED.asset_classes,
    auth_method = EXCLUDED.auth_method,
    auth_config = EXCLUDED.auth_config,
    api_config = EXCLUDED.api_config,
    features = EXCLUDED.features,
    is_beta = EXCLUDED.is_beta,
    updated_at = NOW();

-- ============================================================================
-- STEP 9: SEED DATA - Common Futures Instruments
-- ============================================================================

INSERT INTO instrument_definitions (
    symbol, name, asset_class, instrument_type, exchange, product_code,
    tick_size, tick_value, point_value, contract_size, currency
) VALUES
-- CME E-mini Futures
('ES', 'E-mini S&P 500', 'futures', 'quarterly', 'CME', 'ES', 0.25, 12.50, 50.00, 50, 'USD'),
('NQ', 'E-mini Nasdaq 100', 'futures', 'quarterly', 'CME', 'NQ', 0.25, 5.00, 20.00, 20, 'USD'),
('RTY', 'E-mini Russell 2000', 'futures', 'quarterly', 'CME', 'RTY', 0.10, 5.00, 50.00, 50, 'USD'),
('YM', 'E-mini Dow', 'futures', 'quarterly', 'CBOT', 'YM', 1.00, 5.00, 5.00, 5, 'USD'),

-- Micro Futures
('MES', 'Micro E-mini S&P 500', 'futures', 'quarterly', 'CME', 'MES', 0.25, 1.25, 5.00, 5, 'USD'),
('MNQ', 'Micro E-mini Nasdaq 100', 'futures', 'quarterly', 'CME', 'MNQ', 0.25, 0.50, 2.00, 2, 'USD'),
('M2K', 'Micro E-mini Russell 2000', 'futures', 'quarterly', 'CME', 'M2K', 0.10, 0.50, 5.00, 5, 'USD'),
('MYM', 'Micro E-mini Dow', 'futures', 'quarterly', 'CBOT', 'MYM', 1.00, 0.50, 0.50, 0.5, 'USD'),

-- Commodities
('CL', 'Crude Oil', 'futures', 'monthly', 'NYMEX', 'CL', 0.01, 10.00, 1000.00, 1000, 'USD'),
('GC', 'Gold', 'futures', 'monthly', 'COMEX', 'GC', 0.10, 10.00, 100.00, 100, 'USD'),
('SI', 'Silver', 'futures', 'monthly', 'COMEX', 'SI', 0.005, 25.00, 5000.00, 5000, 'USD'),
('NG', 'Natural Gas', 'futures', 'monthly', 'NYMEX', 'NG', 0.001, 10.00, 10000.00, 10000, 'USD'),

-- Currencies
('6E', 'Euro FX', 'futures', 'quarterly', 'CME', '6E', 0.00005, 6.25, 125000.00, 125000, 'USD'),
('6J', 'Japanese Yen', 'futures', 'quarterly', 'CME', '6J', 0.0000005, 6.25, 12500000.00, 12500000, 'USD'),
('6B', 'British Pound', 'futures', 'quarterly', 'CME', '6B', 0.0001, 6.25, 62500.00, 62500, 'USD'),

-- Treasuries
('ZB', '30-Year Treasury Bond', 'futures', 'quarterly', 'CBOT', 'ZB', 0.03125, 31.25, 1000.00, 1000, 'USD'),
('ZN', '10-Year Treasury Note', 'futures', 'quarterly', 'CBOT', 'ZN', 0.015625, 15.625, 1000.00, 1000, 'USD'),
('ZF', '5-Year Treasury Note', 'futures', 'quarterly', 'CBOT', 'ZF', 0.0078125, 7.8125, 1000.00, 1000, 'USD')

ON CONFLICT (symbol, exchange) DO UPDATE SET
    name = EXCLUDED.name,
    tick_size = EXCLUDED.tick_size,
    tick_value = EXCLUDED.tick_value,
    point_value = EXCLUDED.point_value,
    contract_size = EXCLUDED.contract_size,
    updated_at = NOW();

-- ============================================================================
-- STEP 10: ROW LEVEL SECURITY (RLS) POLICIES
-- ============================================================================

-- Enable RLS on all tables
ALTER TABLE broker_definitions ENABLE ROW LEVEL SECURITY;
ALTER TABLE broker_connections ENABLE ROW LEVEL SECURITY;
ALTER TABLE broker_accounts ENABLE ROW LEVEL SECURITY;
ALTER TABLE broker_sync_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE broker_raw_data ENABLE ROW LEVEL SECURITY;
ALTER TABLE instrument_definitions ENABLE ROW LEVEL SECURITY;

-- Broker Definitions - Public read access
DROP POLICY IF EXISTS "Anyone can view active broker definitions" ON broker_definitions;
CREATE POLICY "Anyone can view active broker definitions"
    ON broker_definitions FOR SELECT
    USING (is_active = true);

-- Broker Connections Policies
DROP POLICY IF EXISTS "Users can view their own broker connections" ON broker_connections;
DROP POLICY IF EXISTS "Users can insert their own broker connections" ON broker_connections;
DROP POLICY IF EXISTS "Users can update their own broker connections" ON broker_connections;
DROP POLICY IF EXISTS "Users can delete their own broker connections" ON broker_connections;

CREATE POLICY "Users can view their own broker connections"
    ON broker_connections FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own broker connections"
    ON broker_connections FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own broker connections"
    ON broker_connections FOR UPDATE
    USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own broker connections"
    ON broker_connections FOR DELETE
    USING (auth.uid() = user_id);

-- Broker Accounts Policies
DROP POLICY IF EXISTS "Users can view their own broker accounts" ON broker_accounts;
DROP POLICY IF EXISTS "Users can insert their own broker accounts" ON broker_accounts;
DROP POLICY IF EXISTS "Users can update their own broker accounts" ON broker_accounts;
DROP POLICY IF EXISTS "Users can delete their own broker accounts" ON broker_accounts;

CREATE POLICY "Users can view their own broker accounts"
    ON broker_accounts FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own broker accounts"
    ON broker_accounts FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own broker accounts"
    ON broker_accounts FOR UPDATE
    USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own broker accounts"
    ON broker_accounts FOR DELETE
    USING (auth.uid() = user_id);

-- Broker Sync Logs Policies
DROP POLICY IF EXISTS "Users can view their own sync logs" ON broker_sync_logs;
DROP POLICY IF EXISTS "Users can insert their own sync logs" ON broker_sync_logs;
DROP POLICY IF EXISTS "Users can update their own sync logs" ON broker_sync_logs;

CREATE POLICY "Users can view their own sync logs"
    ON broker_sync_logs FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own sync logs"
    ON broker_sync_logs FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own sync logs"
    ON broker_sync_logs FOR UPDATE
    USING (auth.uid() = user_id);

-- Broker Raw Data Policies
DROP POLICY IF EXISTS "Users can view their own raw data" ON broker_raw_data;
DROP POLICY IF EXISTS "Users can insert their own raw data" ON broker_raw_data;

CREATE POLICY "Users can view their own raw data"
    ON broker_raw_data FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM broker_connections bc
            WHERE bc.id = broker_raw_data.connection_id
            AND bc.user_id = auth.uid()
        )
    );

CREATE POLICY "Users can insert their own raw data"
    ON broker_raw_data FOR INSERT
    WITH CHECK (
        EXISTS (
            SELECT 1 FROM broker_connections bc
            WHERE bc.id = broker_raw_data.connection_id
            AND bc.user_id = auth.uid()
        )
    );

-- Instrument Definitions - Public read access
DROP POLICY IF EXISTS "Anyone can view instrument definitions" ON instrument_definitions;
CREATE POLICY "Anyone can view instrument definitions"
    ON instrument_definitions FOR SELECT
    USING (is_active = true);

-- ============================================================================
-- STEP 11: HELPER FUNCTIONS
-- ============================================================================

-- Function to get user's active broker connections with broker details
CREATE OR REPLACE FUNCTION get_user_broker_connections(p_user_id UUID)
RETURNS TABLE (
    connection_id UUID,
    broker_name VARCHAR,
    broker_slug VARCHAR,
    broker_logo TEXT,
    connection_name VARCHAR,
    environment VARCHAR,
    status VARCHAR,
    accounts_count BIGINT,
    last_sync_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        bc.id as connection_id,
        COALESCE(bd.display_name, bc.broker::VARCHAR) as broker_name,
        COALESCE(bd.slug, bc.broker::VARCHAR) as broker_slug,
        bd.logo_url as broker_logo,
        bc.connection_name,
        bc.environment,
        bc.status,
        COUNT(ba.id) as accounts_count,
        bc.last_sync_at,
        bc.created_at
    FROM broker_connections bc
    LEFT JOIN broker_definitions bd ON bc.broker_id = bd.id
    LEFT JOIN broker_accounts ba ON ba.connection_id = bc.id AND ba.is_active = true
    WHERE bc.user_id = p_user_id
    AND bc.is_active = true
    GROUP BY bc.id, bd.display_name, bd.slug, bd.logo_url
    ORDER BY bc.created_at DESC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to update connection status
CREATE OR REPLACE FUNCTION update_connection_status(
    p_connection_id UUID,
    p_status VARCHAR,
    p_message TEXT DEFAULT NULL
) RETURNS VOID AS $$
BEGIN
    UPDATE broker_connections
    SET 
        status = p_status,
        status_message = p_message,
        updated_at = NOW(),
        connected_at = CASE WHEN p_status = 'connected' THEN NOW() ELSE connected_at END,
        disconnected_at = CASE WHEN p_status IN ('disconnected', 'expired', 'revoked', 'error') THEN NOW() ELSE disconnected_at END
    WHERE id = p_connection_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to log sync operation
CREATE OR REPLACE FUNCTION log_sync_operation(
    p_connection_id UUID,
    p_account_id UUID,
    p_user_id UUID,
    p_sync_type VARCHAR,
    p_trigger VARCHAR DEFAULT 'manual'
) RETURNS UUID AS $$
DECLARE
    v_log_id UUID;
BEGIN
    INSERT INTO broker_sync_logs (
        connection_id, account_id, user_id, sync_type, sync_trigger, status
    ) VALUES (
        p_connection_id, p_account_id, p_user_id, p_sync_type, p_trigger, 'started'
    ) RETURNING id INTO v_log_id;
    
    RETURN v_log_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to complete sync operation
CREATE OR REPLACE FUNCTION complete_sync_operation(
    p_log_id UUID,
    p_status VARCHAR,
    p_records_fetched INTEGER DEFAULT 0,
    p_records_created INTEGER DEFAULT 0,
    p_records_updated INTEGER DEFAULT 0,
    p_records_skipped INTEGER DEFAULT 0,
    p_records_failed INTEGER DEFAULT 0,
    p_error_message TEXT DEFAULT NULL,
    p_sync_details JSONB DEFAULT '{}'
) RETURNS VOID AS $$
DECLARE
    v_started_at TIMESTAMPTZ;
    v_duration INTEGER;
    v_connection_id UUID;
BEGIN
    SELECT started_at, connection_id INTO v_started_at, v_connection_id 
    FROM broker_sync_logs WHERE id = p_log_id;
    
    v_duration := EXTRACT(MILLISECONDS FROM (NOW() - v_started_at))::INTEGER;
    
    UPDATE broker_sync_logs
    SET 
        status = p_status,
        records_fetched = p_records_fetched,
        records_created = p_records_created,
        records_updated = p_records_updated,
        records_skipped = p_records_skipped,
        records_failed = p_records_failed,
        error_message = p_error_message,
        sync_details = p_sync_details,
        completed_at = NOW(),
        duration_ms = v_duration
    WHERE id = p_log_id;
    
    -- Update last sync on connection
    UPDATE broker_connections
    SET 
        last_sync_at = NOW(),
        last_successful_sync_at = CASE WHEN p_status = 'completed' THEN NOW() ELSE last_successful_sync_at END,
        last_error = CASE WHEN p_status = 'failed' THEN p_error_message ELSE last_error END,
        last_error_at = CASE WHEN p_status = 'failed' THEN NOW() ELSE last_error_at END,
        error_count = CASE WHEN p_status = 'failed' THEN COALESCE(error_count, 0) + 1 ELSE 0 END
    WHERE id = v_connection_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to get broker definition by slug
CREATE OR REPLACE FUNCTION get_broker_by_slug(p_slug VARCHAR)
RETURNS broker_definitions AS $$
DECLARE
    v_broker broker_definitions;
BEGIN
    SELECT * INTO v_broker
    FROM broker_definitions
    WHERE slug = p_slug AND is_active = true;
    
    RETURN v_broker;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to get instrument by symbol
CREATE OR REPLACE FUNCTION get_instrument_by_symbol(p_symbol VARCHAR, p_exchange VARCHAR DEFAULT NULL)
RETURNS instrument_definitions AS $$
DECLARE
    v_instrument instrument_definitions;
BEGIN
    IF p_exchange IS NOT NULL THEN
        SELECT * INTO v_instrument
        FROM instrument_definitions
        WHERE symbol = p_symbol AND exchange = p_exchange AND is_active = true;
    ELSE
        SELECT * INTO v_instrument
        FROM instrument_definitions
        WHERE symbol = p_symbol AND is_active = true
        LIMIT 1;
    END IF;
    
    RETURN v_instrument;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- STEP 12: TRIGGERS FOR UPDATED_AT
-- ============================================================================

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

DROP TRIGGER IF EXISTS update_broker_definitions_updated_at ON broker_definitions;
CREATE TRIGGER update_broker_definitions_updated_at
    BEFORE UPDATE ON broker_definitions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_broker_connections_updated_at ON broker_connections;
CREATE TRIGGER update_broker_connections_updated_at
    BEFORE UPDATE ON broker_connections
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_broker_accounts_updated_at ON broker_accounts;
CREATE TRIGGER update_broker_accounts_updated_at
    BEFORE UPDATE ON broker_accounts
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_instrument_definitions_updated_at ON instrument_definitions;
CREATE TRIGGER update_instrument_definitions_updated_at
    BEFORE UPDATE ON instrument_definitions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- ============================================================================
-- STEP 13: OPTIONAL - Link existing broker_connections to broker_definitions
-- ============================================================================
-- This updates existing connections to link to broker_definitions
-- Run this AFTER the seed data is inserted

-- Link existing tradovate connections
UPDATE broker_connections 
SET broker_id = (SELECT id FROM broker_definitions WHERE slug = 'tradovate')
WHERE broker = 'tradovate' AND broker_id IS NULL;

-- Link existing ninjatrader connections
UPDATE broker_connections 
SET broker_id = (SELECT id FROM broker_definitions WHERE slug = 'ninjatrader')
WHERE broker = 'ninja_trader' AND broker_id IS NULL;

-- Link existing interactive_brokers connections
UPDATE broker_connections 
SET broker_id = (SELECT id FROM broker_definitions WHERE slug = 'interactive-brokers')
WHERE broker = 'interactive_brokers' AND broker_id IS NULL;

-- Link existing tradingview connections
UPDATE broker_connections 
SET broker_id = (SELECT id FROM broker_definitions WHERE slug = 'tradingview')
WHERE broker = 'tradingview' AND broker_id IS NULL;

-- Link existing mt4 connections
UPDATE broker_connections 
SET broker_id = (SELECT id FROM broker_definitions WHERE slug = 'metatrader5')
WHERE broker IN ('mt4', 'mt5') AND broker_id IS NULL;

-- ============================================================================
-- VERIFICATION QUERIES (run these after migration to verify)
-- ============================================================================
/*
-- Check all tables exist
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('broker_definitions', 'broker_connections', 'broker_accounts', 
                   'broker_sync_logs', 'broker_raw_data', 'instrument_definitions');

-- Check broker_definitions has data
SELECT slug, display_name, broker_type, is_active FROM broker_definitions ORDER BY display_name;

-- Check instrument_definitions has data
SELECT symbol, name, point_value, tick_value FROM instrument_definitions ORDER BY symbol;

-- Check trades constraints include tradovate
SELECT conname, pg_get_constraintdef(oid) 
FROM pg_constraint 
WHERE conrelid = 'trades'::regclass 
AND (conname LIKE '%broker%' OR conname LIKE '%import%');

-- Check broker_connections columns
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'broker_connections'
ORDER BY ordinal_position;

-- Check RLS policies
SELECT schemaname, tablename, policyname, cmd, qual 
FROM pg_policies 
WHERE tablename IN ('broker_definitions', 'broker_connections', 'broker_accounts', 
                    'broker_sync_logs', 'broker_raw_data', 'instrument_definitions');
*/

-- ============================================================================
-- END OF MIGRATION ‚úÖ
-- ============================================================================



# üìä ◊ì◊ï◊ó ◊û◊ß◊ô◊£ - Finotaur Multi-Broker Database Architecture
## ◊í◊®◊°◊î 3.0 | ◊†◊ï◊ë◊û◊ë◊® 2024

---

# üéØ ◊™◊ß◊¶◊ô◊® ◊û◊†◊î◊ú◊ô◊ù

◊û◊¢◊®◊õ◊™ Finotaur ◊ë◊†◊ï◊ô◊î ◊ú◊™◊û◊ï◊ö ◊ë**◊ê◊ô◊†◊ò◊í◊®◊¶◊ô◊î ◊¢◊ù ◊û◊°◊§◊® ◊ë◊®◊ï◊ß◊®◊ô◊ù** ◊ë◊ê◊û◊¶◊¢◊ï◊™ ◊ê◊®◊õ◊ô◊ò◊ß◊ò◊ï◊®◊™ Database ◊í◊û◊ô◊©◊î ◊ï◊û◊ï◊ì◊ï◊ú◊®◊ô◊™. ◊î◊ì◊ï◊ó ◊î◊ñ◊î ◊û◊§◊®◊ò:

1. **◊û◊ë◊†◊î ◊î-Database ◊î◊û◊ú◊ê** - ◊õ◊ú ◊î◊ò◊ë◊ú◊ê◊ï◊™, ◊î◊¢◊û◊ï◊ì◊ï◊™ ◊ï◊î◊ß◊©◊®◊ô◊ù
2. **◊°◊ô◊†◊®◊í◊ô◊î ◊ë◊ô◊ü Frontend ◊ú-Database** - ◊û◊î ◊†◊©◊ú◊ó ◊ï◊û◊î ◊û◊™◊ß◊ë◊ú
3. **◊®◊©◊ô◊û◊™ ◊ë◊®◊ï◊ß◊®◊ô◊ù ◊†◊™◊û◊õ◊ô◊ù** - ◊û◊î ◊¢◊ï◊ë◊ì ◊î◊ô◊ï◊ù ◊ï◊û◊î ◊ê◊§◊©◊®◊ô
4. **Tradovate Deep Dive** - ◊ê◊ô◊ö ◊î◊ê◊ô◊†◊ò◊í◊®◊¶◊ô◊î ◊¢◊ï◊ë◊ì◊™ ◊ë◊§◊ï◊¢◊ú

---

# üìê ◊ó◊ú◊ß 1: ◊ê◊®◊õ◊ô◊ò◊ß◊ò◊ï◊®◊™ Database

## 1.1 ◊™◊®◊©◊ô◊ù ◊ô◊©◊ï◊ô◊ï◊™ (ERD)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                    DATABASE SCHEMA                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îÇ
‚îÇ  ‚îÇ  broker_definitions  ‚îÇ         ‚îÇ   auth.users         ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ         ‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ  id (PK)             ‚îÇ         ‚îÇ   id (PK)            ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ  name                ‚îÇ         ‚îÇ   email              ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ  display_name        ‚îÇ         ‚îÇ   ...                ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ  slug (UNIQUE)       ‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îÇ
‚îÇ  ‚îÇ  broker_type         ‚îÇ                    ‚îÇ                                       ‚îÇ
‚îÇ  ‚îÇ  asset_classes[]     ‚îÇ                    ‚îÇ user_id (FK)                          ‚îÇ
‚îÇ  ‚îÇ  auth_method         ‚îÇ                    ‚îÇ                                       ‚îÇ
‚îÇ  ‚îÇ  auth_config (JSONB) ‚îÇ                    ‚ñº                                       ‚îÇ
‚îÇ  ‚îÇ  api_config (JSONB)  ‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                          ‚îÇ
‚îÇ  ‚îÇ  features (JSONB)    ‚îÇ         ‚îÇ  broker_connections  ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ  is_active           ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ                          ‚îÇ
‚îÇ  ‚îÇ  is_beta             ‚îÇbroker_id‚îÇ  id (PK)             ‚îÇ                          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   (FK)  ‚îÇ  user_id (FK)‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚ñ∂ auth.users            ‚îÇ
‚îÇ                                   ‚îÇ  broker_id (FK)      ‚îÇ                          ‚îÇ
‚îÇ                                   ‚îÇ  broker (text)       ‚îÇ  ‚óÄ‚îÄ‚îÄ Legacy support      ‚îÇ
‚îÇ                                   ‚îÇ  environment         ‚îÇ                          ‚îÇ
‚îÇ                                   ‚îÇ  status              ‚îÇ                          ‚îÇ
‚îÇ                                   ‚îÇ  access_token        ‚îÇ                          ‚îÇ
‚îÇ                                   ‚îÇ  connection_data     ‚îÇ                          ‚îÇ
‚îÇ                                   ‚îÇ  last_sync_at        ‚îÇ                          ‚îÇ
‚îÇ                                   ‚îÇ  is_active           ‚îÇ                          ‚îÇ
‚îÇ                                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                          ‚îÇ
‚îÇ                                              ‚îÇ                                       ‚îÇ
‚îÇ                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ
‚îÇ                          ‚îÇ                   ‚îÇ                   ‚îÇ                  ‚îÇ
‚îÇ                          ‚ñº                   ‚ñº                   ‚ñº                  ‚îÇ
‚îÇ             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ             ‚îÇ   broker_accounts   ‚îÇ ‚îÇ broker_sync_logs‚îÇ ‚îÇ   broker_raw_data   ‚îÇ     ‚îÇ
‚îÇ             ‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îÇ ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ ‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îÇ     ‚îÇ
‚îÇ             ‚îÇ   id (PK)           ‚îÇ ‚îÇ id (PK)         ‚îÇ ‚îÇ   id (PK)           ‚îÇ     ‚îÇ
‚îÇ             ‚îÇ   connection_id(FK) ‚îÇ ‚îÇ connection_id   ‚îÇ ‚îÇ   connection_id(FK) ‚îÇ     ‚îÇ
‚îÇ             ‚îÇ   user_id (FK)      ‚îÇ ‚îÇ account_id (FK) ‚îÇ ‚îÇ   sync_log_id (FK)  ‚îÇ     ‚îÇ
‚îÇ             ‚îÇ   broker_account_id ‚îÇ ‚îÇ user_id (FK)    ‚îÇ ‚îÇ   data_type         ‚îÇ     ‚îÇ
‚îÇ             ‚îÇ   account_name      ‚îÇ ‚îÇ sync_type       ‚îÇ ‚îÇ   raw_data (JSONB)  ‚îÇ     ‚îÇ
‚îÇ             ‚îÇ   account_type      ‚îÇ ‚îÇ sync_trigger    ‚îÇ ‚îÇ   is_processed      ‚îÇ     ‚îÇ
‚îÇ             ‚îÇ   balance_snapshot  ‚îÇ ‚îÇ status          ‚îÇ ‚îÇ   created_trade_id  ‚îÇ     ‚îÇ
‚îÇ             ‚îÇ   is_primary        ‚îÇ ‚îÇ records_created ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ records_skipped ‚îÇ                             ‚îÇ
‚îÇ                       ‚îÇ             ‚îÇ error_message   ‚îÇ                             ‚îÇ
‚îÇ                       ‚îÇ             ‚îÇ duration_ms     ‚îÇ                             ‚îÇ
‚îÇ                       ‚îÇ             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                             ‚îÇ
‚îÇ                       ‚îÇ                                                             ‚îÇ
‚îÇ                       ‚îÇ broker_account_id (FK)                                      ‚îÇ
‚îÇ                       ‚ñº                                                             ‚îÇ
‚îÇ             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ             ‚îÇ                         trades                              ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   id (PK)                                                   ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   user_id (FK) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ auth.users   ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   symbol, asset_class, side                                 ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   quantity, entry_price, exit_price, stop_price             ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   pnl, multiplier, fees                                     ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   open_at, close_at                                         ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   broker, import_source                                     ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   broker_connection_id (FK) ‚îÄ‚îÄ‚ñ∂ broker_connections          ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   broker_account_id (FK) ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂ broker_accounts              ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   external_id (UNIQUE per broker)                           ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   synced_at, raw_data                                       ‚îÇ         ‚îÇ
‚îÇ             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                                                                                      ‚îÇ
‚îÇ             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ             ‚îÇ               instrument_definitions                        ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   id (PK)                                                   ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   symbol, name, exchange (UNIQUE together)                  ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   asset_class, tick_size, tick_value                        ‚îÇ         ‚îÇ
‚îÇ             ‚îÇ   point_value, contract_size                                ‚îÇ         ‚îÇ
‚îÇ             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îÇ                                                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 1.2 ◊§◊ô◊®◊ï◊ò ◊õ◊ú ◊ò◊ë◊ú◊î

### üî∑ broker_definitions
**◊™◊§◊ß◊ô◊ì:** ◊®◊©◊ô◊û◊™ ◊û◊ê◊°◊ò◊® ◊©◊ú ◊õ◊ú ◊î◊ë◊®◊ï◊ß◊®◊ô◊ù ◊î◊†◊™◊û◊õ◊ô◊ù ◊ë◊û◊¢◊®◊õ◊™

| ◊¢◊û◊ï◊ì◊î | ◊ò◊ô◊§◊ï◊° | ◊™◊ô◊ê◊ï◊® | ◊ì◊ï◊í◊û◊î |
|-------|-------|-------|-------|
| `id` | UUID | ◊û◊ñ◊î◊î ◊ô◊ô◊ó◊ï◊ì◊ô | `a1b2c3d4-...` |
| `name` | VARCHAR(100) | ◊©◊ù ◊§◊†◊ô◊û◊ô (◊ô◊ô◊ó◊ï◊ì◊ô) | `Tradovate` |
| `display_name` | VARCHAR(100) | ◊©◊ù ◊™◊¶◊ï◊í◊î | `Tradovate` |
| `slug` | VARCHAR(50) | URL-friendly (◊ô◊ô◊ó◊ï◊ì◊ô) | `tradovate` |
| `description` | TEXT | ◊™◊ô◊ê◊ï◊® ◊î◊ë◊®◊ï◊ß◊® | `Commission-free futures...` |
| `logo_url` | TEXT | ◊ß◊ô◊©◊ï◊® ◊ú◊ú◊ï◊í◊ï | `https://...` |
| `website_url` | TEXT | ◊ê◊™◊® ◊î◊ë◊®◊ï◊ß◊® | `https://tradovate.com` |
| `broker_type` | VARCHAR(50) | ◊°◊ï◊í | `broker` / `prop_firm` / `exchange` / `platform` |
| `asset_classes` | TEXT[] | ◊°◊ï◊í◊ô ◊†◊õ◊°◊ô◊ù | `['futures']` |
| `auth_method` | VARCHAR(50) | ◊©◊ô◊ò◊™ ◊ê◊ô◊û◊ï◊™ | `credentials` / `oauth2` / `api_key` / `csv_import` |
| `auth_config` | JSONB | ◊î◊í◊ì◊®◊ï◊™ ◊ê◊ô◊û◊ï◊™ | `{"fields": ["username", "password"]}` |
| `api_config` | JSONB | ◊î◊í◊ì◊®◊ï◊™ API | `{"demo_api_url": "https://..."}` |
| `features` | JSONB | ◊ô◊õ◊ï◊ú◊ï◊™ ◊†◊™◊û◊õ◊ï◊™ | `{"realtime_sync": true, "positions": true}` |
| `data_mapping` | JSONB | ◊û◊ô◊§◊ï◊ô ◊©◊ì◊ï◊™ | `{"symbol_field": "contractName"}` |
| `is_active` | BOOLEAN | ◊î◊ê◊ù ◊§◊¢◊ô◊ú | `true` |
| `is_beta` | BOOLEAN | ◊î◊ê◊ù ◊ë◊ë◊ò◊ê | `false` |
| `requires_subscription` | VARCHAR(20) | ◊®◊û◊™ ◊û◊†◊ï◊ô ◊†◊ì◊®◊©◊™ | `FREE` / `BASIC` / `PREMIUM` |
| `supported_regions` | TEXT[] | ◊ê◊ñ◊ï◊®◊ô◊ù ◊†◊™◊û◊õ◊ô◊ù | `['US', 'EU', 'GLOBAL']` |

**◊ì◊ï◊í◊û◊™ JSONB - auth_config:**
```json
{
  "fields": ["username", "password", "device_id"],
  "optional_fields": ["cid", "sec"],
  "supports_mfa": true
}
```

**◊ì◊ï◊í◊û◊™ JSONB - api_config:**
```json
{
  "demo_api_url": "https://demo.tradovateapi.com/v1",
  "live_api_url": "https://live.tradovateapi.com/v1",
  "demo_ws_url": "wss://demo.tradovateapi.com/v1/websocket",
  "live_ws_url": "wss://live.tradovateapi.com/v1/websocket",
  "rate_limit": 120,
  "rate_limit_window": 60
}
```

**◊ì◊ï◊í◊û◊™ JSONB - features:**
```json
{
  "realtime_sync": true,
  "historical_sync": true,
  "positions": true,
  "orders": true,
  "account_balance": true,
  "margin_info": true,
  "trade_execution": false
}
```

---

### üî∑ broker_connections
**◊™◊§◊ß◊ô◊ì:** ◊ó◊ô◊ë◊ï◊®◊ô◊ù ◊©◊ú ◊û◊©◊™◊û◊©◊ô◊ù ◊ú◊ë◊®◊ï◊ß◊®◊ô◊ù

| ◊¢◊û◊ï◊ì◊î | ◊ò◊ô◊§◊ï◊° | ◊™◊ô◊ê◊ï◊® | ◊ó◊ï◊ë◊î |
|-------|-------|-------|------|
| `id` | UUID | ◊û◊ñ◊î◊î ◊ô◊ô◊ó◊ï◊ì◊ô | ‚úÖ |
| `user_id` | UUID (FK) | ◊û◊ñ◊î◊î ◊û◊©◊™◊û◊© | ‚úÖ |
| `broker_id` | UUID (FK) | ◊ß◊ô◊©◊ï◊® ◊ú-broker_definitions | ‚ùå (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô) |
| `broker` | TEXT | ◊©◊ù ◊ë◊®◊ï◊ß◊® (legacy) | ‚úÖ |
| `connection_name` | VARCHAR(100) | ◊©◊ù ◊ô◊ì◊ô◊ì◊ï◊™◊ô | ‚ùå |
| `environment` | VARCHAR(20) | ◊°◊ë◊ô◊ë◊î | ‚úÖ (default: `demo`) |
| `status` | VARCHAR(30) | ◊°◊ò◊ò◊ï◊° ◊ó◊ô◊ë◊ï◊® | ‚úÖ |
| `access_token` | TEXT | ◊ò◊ï◊ß◊ü ◊í◊ô◊©◊î | ‚ùå |
| `refresh_token` | TEXT | ◊ò◊ï◊ß◊ü ◊®◊¢◊†◊ï◊ü | ‚ùå |
| `token_expires_at` | TIMESTAMPTZ | ◊™◊§◊ï◊í◊™ ◊ò◊ï◊ß◊ü | ‚ùå |
| `connection_data` | JSONB | ◊û◊ô◊ì◊¢ ◊†◊ï◊°◊£ | ‚ùå |
| `status_message` | TEXT | ◊î◊ï◊ì◊¢◊™ ◊°◊ò◊ò◊ï◊° | ‚ùå |
| `last_error` | TEXT | ◊©◊í◊ô◊ê◊î ◊ê◊ó◊®◊ï◊†◊î | ‚ùå |
| `last_error_at` | TIMESTAMPTZ | ◊ñ◊û◊ü ◊©◊í◊ô◊ê◊î | ‚ùå |
| `error_count` | INTEGER | ◊û◊ï◊†◊î ◊©◊í◊ô◊ê◊ï◊™ | ‚ùå |
| `auto_sync_enabled` | BOOLEAN | ◊°◊†◊õ◊®◊ï◊ü ◊ê◊ï◊ò◊ï◊û◊ò◊ô | ‚úÖ (default: `true`) |
| `sync_interval_minutes` | INTEGER | ◊™◊ì◊ô◊®◊ï◊™ ◊°◊†◊õ◊®◊ï◊ü | ‚úÖ (default: `15`) |
| `last_sync_at` | TIMESTAMPTZ | ◊°◊†◊õ◊®◊ï◊ü ◊ê◊ó◊®◊ï◊ü | ‚ùå |
| `last_successful_sync_at` | TIMESTAMPTZ | ◊°◊†◊õ◊®◊ï◊ü ◊û◊ï◊¶◊ú◊ó ◊ê◊ó◊®◊ï◊ü | ‚ùå |
| `is_active` | BOOLEAN | ◊î◊ê◊ù ◊§◊¢◊ô◊ú | ‚úÖ (default: `true`) |
| `connected_at` | TIMESTAMPTZ | ◊ñ◊û◊ü ◊î◊™◊ó◊ë◊®◊ï◊™ | ‚ùå |
| `disconnected_at` | TIMESTAMPTZ | ◊ñ◊û◊ü ◊î◊™◊†◊™◊ß◊ï◊™ | ‚ùå |

**◊¢◊®◊õ◊ô status ◊ê◊§◊©◊®◊ô◊ô◊ù:**
- `pending` - ◊û◊û◊™◊ô◊ü ◊ú◊ó◊ô◊ë◊ï◊®
- `connected` - ◊û◊ó◊ï◊ë◊® ◊ï◊§◊¢◊ô◊ú
- `disconnected` - ◊û◊†◊ï◊™◊ß
- `error` - ◊©◊í◊ô◊ê◊î
- `expired` - ◊ò◊ï◊ß◊ü ◊§◊í
- `revoked` - ◊ë◊ï◊ò◊ú

**◊¢◊®◊õ◊ô environment ◊ê◊§◊©◊®◊ô◊ô◊ù:**
- `demo` - ◊ó◊©◊ë◊ï◊ü ◊î◊ì◊í◊û◊î
- `live` - ◊ó◊©◊ë◊ï◊ü ◊ê◊û◊ô◊™◊ô
- `paper` - ◊û◊°◊ó◊® ◊¢◊ú ◊†◊ô◊ô◊®
- `simulated` - ◊°◊ô◊û◊ï◊ú◊¶◊ô◊î

---

### üî∑ broker_accounts
**◊™◊§◊ß◊ô◊ì:** ◊ó◊©◊ë◊ï◊†◊ï◊™ ◊û◊°◊ó◊® ◊ë◊™◊ï◊ö ◊ó◊ô◊ë◊ï◊® (◊û◊©◊™◊û◊© ◊ô◊õ◊ï◊ú ◊ú◊ó◊ë◊® ◊ó◊©◊ë◊ï◊ü ◊ê◊ó◊ì ◊¢◊ù ◊õ◊û◊î Sub-Accounts)

| ◊¢◊û◊ï◊ì◊î | ◊ò◊ô◊§◊ï◊° | ◊™◊ô◊ê◊ï◊® |
|-------|-------|-------|
| `id` | UUID | ◊û◊ñ◊î◊î ◊ô◊ô◊ó◊ï◊ì◊ô |
| `connection_id` | UUID (FK) | ◊ß◊ô◊©◊ï◊® ◊ú-broker_connections |
| `user_id` | UUID (FK) | ◊ß◊ô◊©◊ï◊® ◊ú-auth.users |
| `broker_account_id` | VARCHAR(100) | ◊û◊ñ◊î◊î ◊î◊ó◊©◊ë◊ï◊ü ◊ê◊¶◊ú ◊î◊ë◊®◊ï◊ß◊® |
| `account_name` | VARCHAR(100) | ◊©◊ù ◊î◊ó◊©◊ë◊ï◊ü |
| `account_number` | VARCHAR(100) | ◊û◊°◊§◊® ◊ó◊©◊ë◊ï◊ü |
| `account_type` | VARCHAR(50) | ◊°◊ï◊í ◊ó◊©◊ë◊ï◊ü |
| `account_subtype` | VARCHAR(50) | ◊™◊™-◊°◊ï◊í |
| `base_currency` | VARCHAR(10) | ◊û◊ò◊ë◊¢ ◊ë◊°◊ô◊° |
| `timezone` | VARCHAR(50) | ◊ê◊ñ◊ï◊® ◊ñ◊û◊ü |
| `broker_status` | VARCHAR(50) | ◊°◊ò◊ò◊ï◊° ◊ê◊¶◊ú ◊î◊ë◊®◊ï◊ß◊® |
| `balance_snapshot` | JSONB | ◊™◊û◊ï◊†◊™ ◊û◊¶◊ë ◊ô◊™◊®◊ï◊™ |
| `account_data` | JSONB | ◊û◊ô◊ì◊¢ ◊†◊ï◊°◊£ |
| `is_primary` | BOOLEAN | ◊î◊ê◊ù ◊®◊ê◊©◊ô |
| `is_active` | BOOLEAN | ◊î◊ê◊ù ◊§◊¢◊ô◊ú |
| `display_order` | INTEGER | ◊°◊ì◊® ◊™◊¶◊ï◊í◊î |
| `last_sync_at` | TIMESTAMPTZ | ◊°◊†◊õ◊®◊ï◊ü ◊ê◊ó◊®◊ï◊ü |
| `sync_status` | VARCHAR(30) | ◊°◊ò◊ò◊ï◊° ◊°◊†◊õ◊®◊ï◊ü |

**◊¢◊®◊õ◊ô account_type ◊ê◊§◊©◊®◊ô◊ô◊ù:**
- `individual` - ◊ê◊ô◊©◊ô
- `joint` - ◊û◊©◊ï◊™◊£
- `ira` - ◊§◊†◊°◊ô◊î
- `corporate` - ◊ó◊ë◊®◊î
- `prop` - Prop Trading
- `funded` - Funded Account
- `evaluation` - ◊î◊¢◊®◊õ◊î

**◊ì◊ï◊í◊û◊™ balance_snapshot:**
```json
{
  "cash_balance": 50000.00,
  "buying_power": 100000.00,
  "equity": 52000.00,
  "margin_used": 5000.00,
  "margin_available": 45000.00,
  "open_pnl": 1500.00,
  "realized_pnl_today": 500.00,
  "updated_at": "2024-11-28T10:30:00Z"
}
```

---

### üî∑ broker_sync_logs
**◊™◊§◊ß◊ô◊ì:** ◊ú◊ï◊í ◊©◊ú ◊õ◊ú ◊§◊¢◊ï◊ú◊ï◊™ ◊î◊°◊†◊õ◊®◊ï◊ü

| ◊¢◊û◊ï◊ì◊î | ◊ò◊ô◊§◊ï◊° | ◊™◊ô◊ê◊ï◊® |
|-------|-------|-------|
| `id` | UUID | ◊û◊ñ◊î◊î ◊ô◊ô◊ó◊ï◊ì◊ô |
| `connection_id` | UUID (FK) | ◊ß◊ô◊©◊ï◊® ◊ú◊ó◊ô◊ë◊ï◊® |
| `account_id` | UUID (FK) | ◊ß◊ô◊©◊ï◊® ◊ú◊ó◊©◊ë◊ï◊ü (◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô) |
| `user_id` | UUID (FK) | ◊ß◊ô◊©◊ï◊® ◊ú◊û◊©◊™◊û◊© |
| `sync_type` | VARCHAR(50) | ◊°◊ï◊í ◊°◊†◊õ◊®◊ï◊ü |
| `sync_trigger` | VARCHAR(50) | ◊û◊î ◊î◊§◊¢◊ô◊ú |
| `sync_from_date` | TIMESTAMPTZ | ◊û◊™◊ê◊®◊ô◊ö |
| `sync_to_date` | TIMESTAMPTZ | ◊¢◊ì ◊™◊ê◊®◊ô◊ö |
| `status` | VARCHAR(30) | ◊°◊ò◊ò◊ï◊° |
| `records_fetched` | INTEGER | ◊†◊©◊ú◊§◊ï |
| `records_created` | INTEGER | ◊†◊ï◊¶◊®◊ï |
| `records_updated` | INTEGER | ◊¢◊ï◊ì◊õ◊†◊ï |
| `records_skipped` | INTEGER | ◊ì◊ï◊ú◊í◊ï |
| `records_failed` | INTEGER | ◊†◊õ◊©◊ú◊ï |
| `sync_details` | JSONB | ◊§◊®◊ò◊ô◊ù ◊†◊ï◊°◊§◊ô◊ù |
| `error_message` | TEXT | ◊î◊ï◊ì◊¢◊™ ◊©◊í◊ô◊ê◊î |
| `error_details` | JSONB | ◊§◊®◊ò◊ô ◊©◊í◊ô◊ê◊î |
| `started_at` | TIMESTAMPTZ | ◊î◊™◊ó◊ú◊î |
| `completed_at` | TIMESTAMPTZ | ◊°◊ô◊ï◊ù |
| `duration_ms` | INTEGER | ◊û◊©◊ö ◊ëms |

**◊¢◊®◊õ◊ô sync_type:**
- `full` - ◊°◊†◊õ◊®◊ï◊ü ◊û◊ú◊ê
- `incremental` - ◊®◊ß ◊ó◊ì◊©◊ô◊ù
- `positions` - ◊§◊ï◊ñ◊ô◊¶◊ô◊ï◊™ ◊ë◊ú◊ë◊ì
- `orders` - ◊î◊ï◊®◊ê◊ï◊™ ◊ë◊ú◊ë◊ì
- `fills` - ◊ë◊ô◊¶◊ï◊¢◊ô◊ù ◊ë◊ú◊ë◊ì
- `balance` - ◊ô◊™◊®◊ï◊™ ◊ë◊ú◊ë◊ì
- `manual` - ◊ô◊ì◊†◊ô

**◊¢◊®◊õ◊ô sync_trigger:**
- `manual` - ◊û◊©◊™◊û◊© ◊ú◊ó◊•
- `scheduled` - ◊û◊™◊ï◊ñ◊û◊ü
- `realtime` - WebSocket
- `webhook` - Callback
- `login` - ◊ë◊î◊™◊ó◊ë◊®◊ï◊™

---

### üî∑ broker_raw_data
**◊™◊§◊ß◊ô◊ì:** ◊©◊û◊ô◊®◊™ ◊†◊™◊ï◊†◊ô◊ù ◊í◊ï◊ú◊û◊ô◊ô◊ù ◊û◊î◊ë◊®◊ï◊ß◊® (◊ú◊ì◊ô◊ë◊ï◊í ◊ï-replay)

| ◊¢◊û◊ï◊ì◊î | ◊ò◊ô◊§◊ï◊° | ◊™◊ô◊ê◊ï◊® |
|-------|-------|-------|
| `id` | UUID | ◊û◊ñ◊î◊î ◊ô◊ô◊ó◊ï◊ì◊ô |
| `sync_log_id` | UUID (FK) | ◊ß◊ô◊©◊ï◊® ◊ú◊ú◊ï◊í ◊°◊†◊õ◊®◊ï◊ü |
| `connection_id` | UUID (FK) | ◊ß◊ô◊©◊ï◊® ◊ú◊ó◊ô◊ë◊ï◊® |
| `data_type` | VARCHAR(50) | ◊°◊ï◊í ◊†◊™◊ï◊ü |
| `broker_record_id` | VARCHAR(100) | ◊û◊ñ◊î◊î ◊ê◊¶◊ú ◊î◊ë◊®◊ï◊ß◊® |
| `raw_data` | JSONB | ◊î◊†◊™◊ï◊ü ◊î◊í◊ï◊ú◊û◊ô |
| `is_processed` | BOOLEAN | ◊î◊ê◊ù ◊¢◊ï◊ë◊ì |
| `processed_at` | TIMESTAMPTZ | ◊ñ◊û◊ü ◊¢◊ô◊ë◊ï◊ì |
| `processing_error` | TEXT | ◊©◊í◊ô◊ê◊™ ◊¢◊ô◊ë◊ï◊ì |
| `created_trade_id` | UUID | ◊î◊ò◊®◊ô◊ô◊ì ◊©◊†◊ï◊¶◊® |
| `broker_timestamp` | TIMESTAMPTZ | ◊ñ◊û◊ü ◊ê◊¶◊ú ◊î◊ë◊®◊ï◊ß◊® |

**◊¢◊®◊õ◊ô data_type:**
- `fill` - ◊ë◊ô◊¶◊ï◊¢
- `order` - ◊î◊ï◊®◊ê◊î
- `position` - ◊§◊ï◊ñ◊ô◊¶◊ô◊î
- `balance` - ◊ô◊™◊®◊î
- `margin` - ◊û◊®◊í'◊ô◊ü
- `contract` - ◊ó◊ï◊ñ◊î

---

### üî∑ instrument_definitions
**◊™◊§◊ß◊ô◊ì:** ◊û◊ô◊ì◊¢ ◊¢◊ú ◊û◊õ◊©◊ô◊®◊ô ◊û◊°◊ó◊® (tick size, multiplier ◊ï◊õ◊ï')

| ◊¢◊û◊ï◊ì◊î | ◊ò◊ô◊§◊ï◊° | ◊™◊ô◊ê◊ï◊® | ◊ì◊ï◊í◊û◊î |
|-------|-------|-------|-------|
| `id` | UUID | ◊û◊ñ◊î◊î | |
| `symbol` | VARCHAR(50) | ◊°◊ô◊û◊ï◊ú | `ES` |
| `name` | VARCHAR(200) | ◊©◊ù | `E-mini S&P 500` |
| `description` | TEXT | ◊™◊ô◊ê◊ï◊® | |
| `asset_class` | VARCHAR(30) | ◊°◊ï◊í ◊†◊õ◊° | `futures` |
| `instrument_type` | VARCHAR(50) | ◊°◊ï◊í ◊û◊õ◊©◊ô◊® | `quarterly` |
| `exchange` | VARCHAR(50) | ◊ë◊ï◊®◊°◊î | `CME` |
| `product_code` | VARCHAR(20) | ◊ß◊ï◊ì ◊û◊ï◊¶◊® | `ES` |
| `tick_size` | DECIMAL(18,8) | ◊í◊ï◊ì◊ú ◊ò◊ô◊ß | `0.25` |
| `tick_value` | DECIMAL(18,4) | ◊¢◊®◊ö ◊ò◊ô◊ß | `12.50` |
| `point_value` | DECIMAL(18,4) | ◊¢◊®◊ö ◊†◊ß◊ï◊ì◊î | `50.00` |
| `contract_size` | DECIMAL(18,4) | ◊í◊ï◊ì◊ú ◊ó◊ï◊ñ◊î | `50` |
| `currency` | VARCHAR(10) | ◊û◊ò◊ë◊¢ | `USD` |
| `trading_hours` | JSONB | ◊©◊¢◊ï◊™ ◊û◊°◊ó◊® | |
| `margin_requirements` | JSONB | ◊ì◊®◊ô◊©◊ï◊™ ◊û◊®◊í'◊ô◊ü | |
| `is_active` | BOOLEAN | ◊§◊¢◊ô◊ú | `true` |

**◊†◊™◊ï◊†◊ô Seed ◊û◊ï◊ë◊†◊ô◊ù:**

| Symbol | Name | Tick Size | Tick Value | Point Value |
|--------|------|-----------|------------|-------------|
| ES | E-mini S&P 500 | 0.25 | $12.50 | $50 |
| NQ | E-mini Nasdaq 100 | 0.25 | $5.00 | $20 |
| RTY | E-mini Russell 2000 | 0.10 | $5.00 | $50 |
| YM | E-mini Dow | 1.00 | $5.00 | $5 |
| MES | Micro S&P | 0.25 | $1.25 | $5 |
| MNQ | Micro Nasdaq | 0.25 | $0.50 | $2 |
| CL | Crude Oil | 0.01 | $10.00 | $1,000 |
| GC | Gold | 0.10 | $10.00 | $100 |
| SI | Silver | 0.005 | $25.00 | $5,000 |
| NG | Natural Gas | 0.001 | $10.00 | $10,000 |

---

### üî∑ trades (◊¢◊û◊ï◊ì◊ï◊™ ◊ë◊®◊ï◊ß◊®)
**◊™◊§◊ß◊ô◊ì:** ◊î◊ò◊ë◊ú◊î ◊î◊®◊ê◊©◊ô◊™ - ◊õ◊ú ◊î◊ò◊®◊ô◊ô◊ì◊ô◊ù ◊©◊ú ◊î◊û◊©◊™◊û◊©

**◊¢◊û◊ï◊ì◊ï◊™ ◊ú◊ô◊ë◊î ◊ß◊ô◊ô◊û◊ï◊™:**
| ◊¢◊û◊ï◊ì◊î | ◊ò◊ô◊§◊ï◊° | ◊™◊ô◊ê◊ï◊® |
|-------|-------|-------|
| `id` | UUID | ◊û◊ñ◊î◊î |
| `user_id` | UUID (FK) | ◊û◊©◊™◊û◊© |
| `symbol` | TEXT | ◊°◊ô◊û◊ï◊ú |
| `asset_class` | VARCHAR(30) | ◊°◊ï◊í ◊†◊õ◊° |
| `side` | TEXT | ◊õ◊ô◊ï◊ï◊ü (`LONG`/`SHORT`) |
| `quantity` | NUMERIC | ◊õ◊û◊ï◊™ |
| `entry_price` | NUMERIC | ◊û◊ó◊ô◊® ◊õ◊†◊ô◊°◊î |
| `exit_price` | NUMERIC | ◊û◊ó◊ô◊® ◊ô◊¶◊ô◊ê◊î |
| `stop_price` | NUMERIC | ◊°◊ò◊ï◊§ |
| `fees` | NUMERIC | ◊¢◊û◊ú◊ï◊™ |
| `multiplier` | NUMERIC | ◊û◊õ◊§◊ô◊ú |
| `pnl` | NUMERIC | ◊®◊ï◊ï◊ó/◊î◊§◊°◊ì |
| `open_at` | TIMESTAMPTZ | ◊ñ◊û◊ü ◊§◊™◊ô◊ó◊î |
| `close_at` | TIMESTAMPTZ | ◊ñ◊û◊ü ◊°◊í◊ô◊®◊î |
| `broker` | TEXT | ◊©◊ù ◊ë◊®◊ï◊ß◊® |
| `import_source` | TEXT | ◊û◊ß◊ï◊® ◊ô◊ô◊ë◊ï◊ê |
| `external_id` | TEXT | ◊û◊ñ◊î◊î ◊ó◊ô◊¶◊ï◊†◊ô (◊ú◊û◊†◊ô◊¢◊™ ◊õ◊§◊ô◊ú◊ï◊ô◊ï◊™) |

**◊¢◊û◊ï◊ì◊ï◊™ ◊ë◊®◊ï◊ß◊® ◊ó◊ì◊©◊ï◊™:**
| ◊¢◊û◊ï◊ì◊î | ◊ò◊ô◊§◊ï◊° | ◊™◊ô◊ê◊ï◊® |
|-------|-------|-------|
| `broker_connection_id` | UUID (FK) | ◊ß◊ô◊©◊ï◊® ◊ú◊ó◊ô◊ë◊ï◊® |
| `broker_account_id` | UUID (FK) | ◊ß◊ô◊©◊ï◊® ◊ú◊ó◊©◊ë◊ï◊ü |
| `broker_name` | VARCHAR(50) | ◊©◊ù ◊ë◊®◊ï◊ß◊® |
| `broker_trade_id` | VARCHAR(100) | ◊û◊ñ◊î◊î ◊ò◊®◊ô◊ô◊ì ◊ê◊¶◊ú ◊î◊ë◊®◊ï◊ß◊® |
| `broker_order_id` | VARCHAR(100) | ◊û◊ñ◊î◊î ◊î◊ï◊®◊ê◊î |
| `contract_id` | VARCHAR(100) | ◊û◊ñ◊î◊î ◊ó◊ï◊ñ◊î |
| `contract_name` | VARCHAR(100) | ◊©◊ù ◊ó◊ï◊ñ◊î |
| `contract_month` | VARCHAR(20) | ◊ó◊ï◊ì◊© ◊ó◊ï◊ñ◊î |
| `underlying_symbol` | VARCHAR(20) | ◊°◊ô◊û◊ï◊ú ◊ë◊°◊ô◊° |
| `tick_size` | DECIMAL | ◊í◊ï◊ì◊ú ◊ò◊ô◊ß |
| `tick_value` | DECIMAL | ◊¢◊®◊ö ◊ò◊ô◊ß |
| `point_value` | DECIMAL | ◊¢◊®◊ö ◊†◊ß◊ï◊ì◊î |
| `execution_id` | VARCHAR(100) | ◊û◊ñ◊î◊î ◊ë◊ô◊¶◊ï◊¢ |
| `order_type` | VARCHAR(30) | ◊°◊ï◊í ◊î◊ï◊®◊ê◊î |
| `synced_at` | TIMESTAMPTZ | ◊ñ◊û◊ü ◊°◊†◊õ◊®◊ï◊ü |
| `sync_source` | VARCHAR(30) | ◊û◊ß◊ï◊® ◊°◊†◊õ◊®◊ï◊ü |
| `raw_data` | JSONB | ◊†◊™◊ï◊ü ◊í◊ï◊ú◊û◊ô |

---

## 1.3 Constraints ◊ó◊©◊ï◊ë◊ô◊ù

### trades table:

**broker constraint:**
```sql
CHECK (broker = ANY (ARRAY[
  'manual', 'interactive_brokers', 'td_ameritrade', 'alpaca',
  'tradingview', 'mt4', 'mt5', 'ninja_trader', 'tradovate',
  'rithmic', 'topstepx', 'tradelocker', 'bybit', 'binance',
  'schwab', 'robinhood', 'snaptrade', 'sierra_chart', 'dxtrade', 'colmexpro'
]))
```

**import_source constraint:**
```sql
CHECK (import_source = ANY (ARRAY[
  'manual', 'snaptrade', 'csv', 'api', 'tradovate',
  'broker_sync', 'webhook', 'rithmic', 'ninja_trader'
]))
```

**side constraint:**
```sql
CHECK (side IN ('LONG', 'SHORT'))
```
‚ö†Ô∏è **◊ó◊©◊ï◊ë:** ◊ó◊ï◊ë◊î UPPERCASE!

**session constraint:**
```sql
CHECK ((session IS NULL) OR (lower(TRIM(session)) IN ('asia', 'london', 'newyork')))
```

---

## 1.4 RLS Policies

◊õ◊ú ◊î◊ò◊ë◊ú◊ê◊ï◊™ ◊û◊ï◊í◊†◊ï◊™ ◊ë-Row Level Security:

| ◊ò◊ë◊ú◊î | SELECT | INSERT | UPDATE | DELETE |
|------|--------|--------|--------|--------|
| broker_definitions | Anyone (if active) | - | - | - |
| broker_connections | Own only | Own only | Own only | Own only |
| broker_accounts | Own only | Own only | Own only | Own only |
| broker_sync_logs | Own only | Own only | Own only | - |
| broker_raw_data | Via connection | Via connection | - | - |
| instrument_definitions | Anyone (if active) | - | - | - |
| trades | Own only + Admin | With limits check | Own only | Own only |

---

# üîÑ ◊ó◊ú◊ß 2: ◊°◊ô◊†◊®◊í◊ô◊î Frontend ‚Üî Database

## 2.1 ◊ñ◊®◊ô◊û◊™ ◊†◊™◊ï◊†◊ô◊ù - ◊î◊™◊ó◊ë◊®◊ï◊™ ◊ú◊ë◊®◊ï◊ß◊®

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         CONNECTION FLOW                                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                              ‚îÇ
‚îÇ  [User enters credentials]                                                   ‚îÇ
‚îÇ           ‚îÇ                                                                  ‚îÇ
‚îÇ           ‚ñº                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                    ‚îÇ
‚îÇ  ‚îÇ  TradovateLogin.tsx ‚îÇ                                                    ‚îÇ
‚îÇ  ‚îÇ  username, password ‚îÇ                                                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                    ‚îÇ
‚îÇ             ‚îÇ                                                                ‚îÇ
‚îÇ             ‚ñº                                                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ  ‚îÇ  useTradovate.ts    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  tradovateApi.login()       ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  login()            ‚îÇ      ‚îÇ  POST /auth/accesstokenrequest             ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ             ‚îÇ                                ‚îÇ                              ‚îÇ
‚îÇ             ‚îÇ                                ‚ñº                              ‚îÇ
‚îÇ             ‚îÇ                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ             ‚îÇ                 ‚îÇ  Tradovate API Response     ‚îÇ              ‚îÇ
‚îÇ             ‚îÇ                 ‚îÇ  {accessToken, userId, ...} ‚îÇ              ‚îÇ
‚îÇ             ‚îÇ                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ             ‚îÇ                                ‚îÇ                              ‚îÇ
‚îÇ             ‚ñº                                ‚ñº                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ  ‚îÇ  brokerConnection   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  broker_connections         ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  .createConnection()‚îÇ      ‚îÇ  INSERT/UPDATE              ‚îÇ              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ  status='connected'         ‚îÇ              ‚îÇ
‚îÇ             ‚îÇ                 ‚îÇ  access_token=xxx           ‚îÇ              ‚îÇ
‚îÇ             ‚îÇ                 ‚îÇ  environment='demo'         ‚îÇ              ‚îÇ
‚îÇ             ‚îÇ                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ             ‚îÇ                                                              ‚îÇ
‚îÇ             ‚ñº                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ  ‚îÇ  tradovateApi       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  GET /account/list          ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  .getAccounts()     ‚îÇ      ‚îÇ  Returns: [{id, name,...}]  ‚îÇ              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ             ‚îÇ                                ‚îÇ                              ‚îÇ
‚îÇ             ‚ñº                                ‚ñº                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ  ‚îÇ  brokerConnection   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  broker_accounts            ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  .createAccount()   ‚îÇ      ‚îÇ  INSERT                     ‚îÇ              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ  broker_account_id=xxx      ‚îÇ              ‚îÇ
‚îÇ                               ‚îÇ  account_name='Demo Account'‚îÇ              ‚îÇ
‚îÇ                               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2.2 ◊ñ◊®◊ô◊û◊™ ◊†◊™◊ï◊†◊ô◊ù - ◊°◊†◊õ◊®◊ï◊ü ◊ò◊®◊ô◊ô◊ì◊ô◊ù

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                           SYNC FLOW                                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                              ‚îÇ
‚îÇ  [User clicks "Sync Historical"]                                             ‚îÇ
‚îÇ           ‚îÇ                                                                  ‚îÇ
‚îÇ           ‚ñº                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  tradovateSyncV2.syncHistoricalTrades(startDate, endDate)   ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                 ‚îÇ                                            ‚îÇ
‚îÇ                                 ‚ñº                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  Step 1: Create sync log                                     ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  broker_sync_logs.INSERT(status='started', sync_type='full') ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                 ‚îÇ                                            ‚îÇ
‚îÇ                                 ‚ñº                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  Step 2: Get existing external_ids from trades              ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  SELECT external_id FROM trades                              ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  WHERE broker='tradovate' AND user_id=xxx                    ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                 ‚îÇ                                            ‚îÇ
‚îÇ                                 ‚ñº                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  Step 3: Fetch fills from Tradovate                         ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  GET /fill/list?accountId=xxx&startDate=xxx                 ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  Returns: [{id, contractId, action, qty, price, ...}]       ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                 ‚îÇ                                            ‚îÇ
‚îÇ                                 ‚ñº                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  Step 4: Filter finallyPaired=true only                     ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  (Only closed trades, not open positions)                   ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                 ‚îÇ                                            ‚îÇ
‚îÇ                                 ‚ñº                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  Step 5: Enrich with contract/product details               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  GET /contract/item?id=xxx ‚Üí {name, productId}              ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  GET /product/item?id=xxx ‚Üí {valuePerPoint, tickSize}       ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                 ‚îÇ                                            ‚îÇ
‚îÇ                                 ‚ñº                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  Step 6: Pair fills using FIFO                              ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  tradovateTradeMapper.pairFillsToTrades()                   ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  Input:  [Buy 2 @ 5000, Sell 2 @ 5010]                      ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  Output: [{entry: Buy, exit: Sell, direction: 'long',       ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ           pnl: (5010-5000) * 2 * 50 = $1000}]               ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                 ‚îÇ                                            ‚îÇ
‚îÇ                                 ‚ñº                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  Step 7: Convert to Finotaur format                         ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  tradovateTradeMapper.convertToFinotaurTrade()              ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  {                                                           ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    symbol: 'ESZ4',                                          ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    asset_class: 'futures',                                  ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    side: 'LONG',           ‚Üê UPPERCASE!                     ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    quantity: 2,                                             ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    entry_price: 5000,                                       ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    exit_price: 5010,                                        ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    stop_price: 4900,       ‚Üê estimated 2%                   ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    multiplier: 50,                                          ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    pnl: 1000,                                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    broker: 'tradovate',                                     ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    import_source: 'tradovate',                              ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    external_id: 'tradovate_123_456',                        ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    open_at: '2024-11-28T10:00:00Z',                         ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ    close_at: '2024-11-28T10:30:00Z'                         ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  }                                                           ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                 ‚îÇ                                            ‚îÇ
‚îÇ                                 ‚ñº                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  Step 8: Check for duplicates                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  if (existingIds.has(external_id)) ‚Üí SKIP                   ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                 ‚îÇ                                            ‚îÇ
‚îÇ                                 ‚ñº                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  Step 9: Insert to trades table                             ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  INSERT INTO trades (...)                                   ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  + can_create_trade() RLS check                             ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                 ‚îÇ                                            ‚îÇ
‚îÇ                                 ‚ñº                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ  Step 10: Complete sync log                                 ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  UPDATE broker_sync_logs                                    ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  SET status='completed',                                    ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ      records_created=5,                                     ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ      records_skipped=2,                                     ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ      duration_ms=1234                                       ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ                                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2.3 ◊û◊î Frontend ◊©◊ï◊ú◊ó vs ◊û◊î Database ◊û◊¶◊§◊î

### ◊ò◊ë◊ú◊™ trades - ◊î◊©◊ï◊ï◊ê◊î ◊û◊ú◊ê◊î:

| ◊©◊ì◊î | Frontend ◊©◊ï◊ú◊ó | Database ◊û◊¶◊§◊î | ◊°◊ò◊ò◊ï◊° |
|-----|---------------|---------------|-------|
| `user_id` | ◊û◊î-auth session | UUID | ‚úÖ |
| `symbol` | `contract.name` (ESZ4) | TEXT | ‚úÖ |
| `asset_class` | `'futures'` | VARCHAR(30) | ‚úÖ |
| `side` | ‚ö†Ô∏è `'long'` | `'LONG'` (UPPERCASE) | ‚ö†Ô∏è **◊¶◊®◊ô◊ö ◊™◊ô◊ß◊ï◊ü** |
| `quantity` | `fill.qty` | NUMERIC | ‚úÖ |
| `entry_price` | `entryFill.price` | NUMERIC | ‚úÖ |
| `exit_price` | `exitFill.price` | NUMERIC (nullable) | ‚úÖ |
| `stop_price` | estimated 2% | NUMERIC | ‚úÖ (◊ê◊ë◊ú ◊ú◊ê ◊û◊ì◊ï◊ô◊ß) |
| `fees` | `0` | NUMERIC | ‚ö†Ô∏è (Tradovate ◊ú◊ê ◊©◊ï◊ú◊ó) |
| `multiplier` | `product.valuePerPoint` | NUMERIC | ‚úÖ |
| `pnl` | calculated | NUMERIC | ‚úÖ |
| `open_at` | `entryFill.timestamp` | TIMESTAMPTZ | ‚úÖ |
| `close_at` | `exitFill.timestamp` | TIMESTAMPTZ (nullable) | ‚úÖ |
| `broker` | `'tradovate'` | TEXT (constraint) | ‚úÖ |
| `import_source` | `'tradovate'` | TEXT (constraint) | ‚úÖ |
| `external_id` | `tradovate_{entry}_{exit}` | TEXT | ‚úÖ |
| `broker_connection_id` | from initialization | UUID (FK) | ‚úÖ |
| `synced_at` | `new Date()` | TIMESTAMPTZ | ‚úÖ |

### ‚ö†Ô∏è ◊ë◊¢◊ô◊ô◊™ Side - ◊î◊™◊ô◊ß◊ï◊ü ◊î◊†◊ì◊®◊©:

**◊ë-tradovateTradeMapper.service.ts, ◊©◊ï◊®◊î ~150:**

```typescript
// ◊†◊ï◊õ◊ó◊ô (◊ú◊ê ◊†◊õ◊ï◊ü):
side: direction,  // 'long' ◊ê◊ï 'short'

// ◊†◊ì◊®◊©:
side: direction.toUpperCase() as 'LONG' | 'SHORT',  // 'LONG' ◊ê◊ï 'SHORT'
```

---

## 2.4 ◊ó◊ô◊©◊ï◊ë P&L - ◊î◊†◊ï◊°◊ó◊î

```typescript
// Long Trade (◊ß◊†◊ô◊ô◊î ◊ï◊ê◊ñ ◊û◊õ◊ô◊®◊î):
pnl = (exitPrice - entryPrice) * quantity * multiplier

// Short Trade (◊û◊õ◊ô◊®◊î ◊ï◊ê◊ñ ◊ß◊†◊ô◊ô◊î):
pnl = (entryPrice - exitPrice) * quantity * multiplier

// ◊ì◊ï◊í◊û◊ê◊ï◊™:
// ES Long: entry=5000, exit=5010, qty=2, multiplier=50
// pnl = (5010 - 5000) * 2 * 50 = $1,000 ‚úÖ

// NQ Short: entry=20000, exit=19950, qty=1, multiplier=20
// pnl = (20000 - 19950) * 1 * 20 = $1,000 ‚úÖ

// MES Long: entry=5000, exit=4990, qty=5, multiplier=5
// pnl = (4990 - 5000) * 5 * 5 = -$250 (◊î◊§◊°◊ì) ‚úÖ
```

---

# üîå ◊ó◊ú◊ß 3: ◊®◊©◊ô◊û◊™ ◊ë◊®◊ï◊ß◊®◊ô◊ù ◊†◊™◊û◊õ◊ô◊ù

## 3.1 ◊°◊ô◊õ◊ï◊ù ◊û◊¶◊ë ◊†◊ï◊õ◊ó◊ô

| ◊ë◊®◊ï◊ß◊® | Slug | ◊°◊ï◊í | ◊†◊õ◊°◊ô◊ù | ◊©◊ô◊ò◊™ ◊ê◊ô◊û◊ï◊™ | ◊û◊¶◊ë | ◊°◊†◊õ◊®◊ï◊ü |
|-------|------|-----|-------|------------|-----|--------|
| **Tradovate** | `tradovate` | Broker | Futures | Credentials | ‚úÖ **◊§◊¢◊ô◊ú** | Real-time + Historical |
| NinjaTrader | `ninjatrader` | Platform | Futures | Credentials | üî∂ Beta | ◊ì◊®◊ö Rithmic |
| Interactive Brokers | `interactive-brokers` | Broker | Multi | OAuth2 | üî∂ Beta | API |
| Rithmic | `rithmic` | Data Provider | Futures | Credentials | üî∂ Beta | Protocol Buffer |
| TopstepX | `topstepx` | Prop Firm | Futures | Credentials | üî∂ Beta | via Tradovate |
| MetaTrader 5 | `metatrader5` | Platform | Multi | CSV Import | üî∂ Beta | CSV |
| TradeLocker | `tradelocker` | Prop Firm | Multi | API Key | üî∂ Beta | API |
| Bybit | `bybit` | Exchange | Crypto | API Key | ‚úÖ Ready | API |
| Binance | `binance` | Exchange | Crypto | API Key | ‚úÖ Ready | API |
| Sierra Chart | `sierra-chart` | Platform | Futures | CSV Import | üî∂ Beta | CSV |
| TradingView | `tradingview` | Platform | Multi | CSV Import | üî∂ Beta | CSV |
| Charles Schwab | `charles-schwab` | Broker | Multi | OAuth2 | üî∂ Beta | API |
| Robinhood | `robinhood` | Broker | Stocks/Crypto | CSV Import | üî∂ Beta | CSV |
| ColmexPro | `colmexpro` | Prop Firm | Forex | Credentials | üî∂ Beta | CSV |
| DXtrade | `dxtrade` | Platform | Multi | Credentials | üî∂ Beta | API |

**◊û◊ß◊®◊ê:**
- ‚úÖ **◊§◊¢◊ô◊ú** = ◊ß◊ï◊ì ◊û◊ú◊ê ◊ï◊¢◊ï◊ë◊ì
- ‚úÖ Ready = Schema ◊û◊ï◊õ◊ü, ◊¶◊®◊ô◊ö ◊ß◊ï◊ì
- üî∂ Beta = Schema ◊û◊ï◊õ◊ü, ◊ë◊§◊ô◊™◊ï◊ó

---

## 3.2 ◊§◊ô◊®◊ï◊ò ◊ú◊§◊ô ◊©◊ô◊ò◊™ ◊ê◊ô◊û◊ï◊™

### üîê Credentials (Username/Password)
| ◊ë◊®◊ï◊ß◊® | ◊©◊ì◊ï◊™ ◊†◊ì◊®◊©◊ô◊ù | ◊î◊¢◊®◊ï◊™ |
|-------|-------------|-------|
| Tradovate | username, password, device_id | + optional cid, sec |
| NinjaTrader | username, password | ◊ì◊®◊ö Rithmic |
| Rithmic | username, password, server | ◊ë◊ó◊ô◊®◊™ server |
| TopstepX | username, password | ◊û◊©◊™◊û◊© ◊ë-Tradovate API |
| ColmexPro | username, password | |
| DXtrade | username, password, server | |

### üîë API Key
| ◊ë◊®◊ï◊ß◊® | ◊©◊ì◊ï◊™ ◊†◊ì◊®◊©◊ô◊ù | ◊î◊¢◊®◊ï◊™ |
|-------|-------------|-------|
| TradeLocker | api_key, api_secret | |
| Bybit | api_key, api_secret | + testnet |
| Binance | api_key, api_secret | + testnet |

### üåê OAuth2
| ◊ë◊®◊ï◊ß◊® | ◊©◊ì◊ï◊™ ◊†◊ì◊®◊©◊ô◊ù | ◊î◊¢◊®◊ï◊™ |
|-------|-------------|-------|
| Interactive Brokers | OAuth flow | ◊ì◊ï◊®◊© Gateway |
| Charles Schwab | OAuth flow | |

### üìÅ CSV Import
| ◊ë◊®◊ï◊ß◊® | ◊§◊ï◊®◊û◊ò◊ô◊ù ◊†◊™◊û◊õ◊ô◊ù | ◊î◊¢◊®◊ï◊™ |
|-------|-----------------|-------|
| MetaTrader 5 | mt5_history, mt5_statement | |
| Sierra Chart | sierra_trade_log | |
| TradingView | tradingview_export | |
| Robinhood | robinhood_export | |

---

## 3.3 ◊§◊ô◊®◊ï◊ò ◊ú◊§◊ô ◊°◊ï◊í ◊†◊õ◊°◊ô◊ù

### üìà Futures
- Tradovate ‚úÖ
- NinjaTrader
- Rithmic
- TopstepX
- Interactive Brokers
- Charles Schwab
- Sierra Chart

### ü™ô Crypto
- Bybit
- Binance
- TradeLocker
- Robinhood (limited)

### üìä Stocks
- Interactive Brokers
- Charles Schwab
- Robinhood
- TradingView (charts)

### üí± Forex
- MetaTrader 5
- TradeLocker
- ColmexPro
- DXtrade

---

# üéØ ◊ó◊ú◊ß 4: Tradovate Deep Dive

## 4.1 ◊û◊î Tradovate ◊û◊°◊§◊ß

### API Endpoints ◊ë◊©◊ô◊û◊ï◊©:

| Endpoint | Method | ◊™◊ô◊ê◊ï◊® | Response |
|----------|--------|-------|----------|
| `/auth/accesstokenrequest` | POST | ◊î◊™◊ó◊ë◊®◊ï◊™ | `{accessToken, userId, expirationTime}` |
| `/auth/renewaccesstoken` | POST | ◊ó◊ô◊ì◊ï◊© ◊ò◊ï◊ß◊ü | `{accessToken, ...}` |
| `/account/list` | GET | ◊®◊©◊ô◊û◊™ ◊ó◊©◊ë◊ï◊†◊ï◊™ | `[{id, name, accountType}]` |
| `/fill/list` | GET | ◊ë◊ô◊¶◊ï◊¢◊ô◊ù | `[{id, contractId, action, qty, price, timestamp}]` |
| `/position/list` | GET | ◊§◊ï◊ñ◊ô◊¶◊ô◊ï◊™ ◊§◊™◊ï◊ó◊ï◊™ | `[{id, contractId, netPos, netPrice}]` |
| `/contract/item` | GET | ◊§◊®◊ò◊ô ◊ó◊ï◊ñ◊î | `{id, name, productId}` |
| `/product/item` | GET | ◊§◊®◊ò◊ô ◊û◊ï◊¶◊® | `{valuePerPoint, tickSize}` |
| `/cashBalance/getcashbalancesnapshot` | GET | ◊ô◊™◊®◊î | `{amount, realizedPnL}` |
| `/cashBalance/getaccountmarginSsnapshot` | GET | ◊û◊®◊í'◊ô◊ü | `{initialMargin, marginExcess}` |

### WebSocket Events:

| Event | ◊™◊ô◊ê◊ï◊® | Data |
|-------|-------|------|
| `fill` | ◊ë◊ô◊¶◊ï◊¢ ◊ó◊ì◊© | `{id, contractId, action, qty, price}` |
| `position` | ◊©◊ô◊†◊ï◊ô ◊§◊ï◊ñ◊ô◊¶◊ô◊î | `{id, contractId, netPos}` |
| `order` | ◊©◊ô◊†◊ï◊ô ◊î◊ï◊®◊ê◊î | `{id, orderStatus}` |

---

## 4.2 ◊û◊ë◊†◊î Fill ◊û-Tradovate

```typescript
interface TradovateFill {
  id: number;                    // ◊û◊ñ◊î◊î ◊ô◊ô◊ó◊ï◊ì◊ô
  contractId: number;            // ◊û◊ñ◊î◊î ◊ó◊ï◊ñ◊î
  timestamp: string;             // ISO timestamp
  action: 'Buy' | 'Sell';        // ◊õ◊ô◊ï◊ï◊ü
  qty: number;                   // ◊õ◊û◊ï◊™
  price: number;                 // ◊û◊ó◊ô◊®
  finallyPaired: boolean;        // ◊î◊ê◊ù ◊î◊ò◊®◊ô◊ô◊ì ◊†◊°◊í◊®
  orderId: number;               // ◊û◊ñ◊î◊î ◊î◊ï◊®◊ê◊î
  
  // ◊†◊ï◊°◊£ ◊ê◊ó◊®◊ô enrichment:
  contract?: TradovateContract;  // ◊§◊®◊ò◊ô ◊ó◊ï◊ñ◊î
  product?: TradovateProduct;    // ◊§◊®◊ò◊ô ◊û◊ï◊¶◊® (multiplier)
}
```

---

## 4.3 ◊ê◊ú◊í◊ï◊®◊ô◊™◊ù ◊ñ◊ô◊ï◊ï◊í FIFO

```
Input Fills (sorted by timestamp):
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. Buy 2 @ 5000   (t1)
2. Sell 1 @ 5005  (t2)
3. Buy 1 @ 5002   (t3)
4. Sell 2 @ 5010  (t4)

Processing:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Step 1: Buy 2 @ 5000
  ‚Üí Opens Long position
  ‚Üí Queue: [Buy 2 @ 5000]

Step 2: Sell 1 @ 5005
  ‚Üí Closes 1 from Long
  ‚Üí Matched: Buy 1 @ 5000 + Sell 1 @ 5005
  ‚Üí Trade 1: Long, Entry=5000, Exit=5005, Qty=1, PnL=+$250
  ‚Üí Queue: [Buy 1 @ 5000 remaining]

Step 3: Buy 1 @ 5002
  ‚Üí Adds to Long
  ‚Üí Queue: [Buy 1 @ 5000, Buy 1 @ 5002]

Step 4: Sell 2 @ 5010
  ‚Üí Closes both
  ‚Üí Matched: Buy 1 @ 5000 + Sell 1 @ 5010 ‚Üí Trade 2
  ‚Üí Matched: Buy 1 @ 5002 + Sell 1 @ 5010 ‚Üí Trade 3
  ‚Üí Queue: []

Output Trades:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Trade 1: Long, Qty=1, Entry=5000, Exit=5005, PnL=+$250
Trade 2: Long, Qty=1, Entry=5000, Exit=5010, PnL=+$500
Trade 3: Long, Qty=1, Entry=5002, Exit=5010, PnL=+$400

Total PnL: $1,150
```

---

## 4.4 ◊û◊†◊ô◊¢◊™ ◊õ◊§◊ô◊ú◊ï◊ô◊ï◊™

**◊§◊ï◊®◊û◊ò external_id:**
```
tradovate_{entryFillId}_{exitFillId}

◊ì◊ï◊í◊û◊ê◊ï◊™:
- tradovate_12345_12346      (◊ò◊®◊ô◊ô◊ì ◊°◊í◊ï◊®)
- tradovate_pos_789          (◊§◊ï◊ñ◊ô◊¶◊ô◊î ◊§◊™◊ï◊ó◊î)
```

**◊™◊î◊ú◊ô◊ö:**
1. ◊ú◊§◊†◊ô ◊°◊†◊õ◊®◊ï◊ü - ◊©◊ï◊ú◊£ ◊õ◊ú external_ids ◊ß◊ô◊ô◊û◊ô◊ù
2. ◊ú◊õ◊ú ◊ò◊®◊ô◊ô◊ì ◊ó◊ì◊© - ◊ë◊ï◊ì◊ß ◊ê◊ù ◊î-ID ◊ß◊ô◊ô◊ù
3. ◊ê◊ù ◊ß◊ô◊ô◊ù ‚Üí ◊û◊ì◊ú◊í (records_skipped++)
4. ◊ê◊ù ◊ú◊ê ◊ß◊ô◊ô◊ù ‚Üí ◊û◊õ◊†◊ô◊° (records_created++)

---

## 4.5 ◊î◊í◊ì◊®◊ï◊™ API ◊©◊ú Tradovate

◊û◊™◊ï◊ö `broker_definitions.api_config`:

```json
{
  "demo_api_url": "https://demo.tradovateapi.com/v1",
  "live_api_url": "https://live.tradovateapi.com/v1",
  "demo_ws_url": "wss://demo.tradovateapi.com/v1/websocket",
  "live_ws_url": "wss://live.tradovateapi.com/v1/websocket",
  "rate_limit": 120,
  "rate_limit_window": 60
}
```

**Rate Limits:**
- 120 ◊ë◊ß◊©◊ï◊™ ◊ú◊ì◊ß◊î
- Heartbeat ◊õ◊ú 30 ◊©◊†◊ô◊ï◊™ ◊ú-WebSocket
- Token ◊™◊ß◊£ ◊ú-24 ◊©◊¢◊ï◊™ (◊¶◊®◊ô◊ö ◊ó◊ô◊ì◊ï◊©)

---

# ‚úÖ ◊ó◊ú◊ß 5: ◊ë◊ì◊ô◊ß◊™ ◊°◊ô◊†◊®◊í◊ô◊î

## 5.1 ◊¶'◊ß◊ú◊ô◊°◊ò ◊°◊ô◊†◊®◊í◊ô◊î

| ◊ë◊ì◊ô◊ß◊î | Frontend | Database | ◊°◊ò◊ò◊ï◊° |
|-------|----------|----------|-------|
| broker value | `'tradovate'` | constraint includes `'tradovate'` | ‚úÖ |
| import_source | `'tradovate'` | constraint includes `'tradovate'` | ‚úÖ |
| side value | ‚ö†Ô∏è `'long'` | expects `'LONG'` | ‚ö†Ô∏è **FIX NEEDED** |
| multiplier | from API | NUMERIC column exists | ‚úÖ |
| external_id | generated | TEXT column exists | ‚úÖ |
| broker_connection_id | from init | UUID FK exists | ‚úÖ |
| timestamps | ISO format | TIMESTAMPTZ | ‚úÖ |
| session | null | constraint allows null | ‚úÖ |
| asset_class | `'futures'` | VARCHAR(30) | ‚úÖ |

## 5.2 ◊û◊î ◊¢◊ï◊ë◊ì ◊û◊ï◊©◊ú◊ù ‚úÖ

1. **◊ó◊ô◊ë◊ï◊® ◊ú◊ë◊®◊ï◊ß◊®** - login/logout ◊¢◊ù token management
2. **◊©◊ú◊ô◊§◊™ ◊ó◊©◊ë◊ï◊†◊ï◊™** - Demo + Live
3. **◊©◊ú◊ô◊§◊™ Fills** - ◊¢◊ù date range
4. **◊©◊ú◊ô◊§◊™ Contracts/Products** - ◊¢◊ù caching
5. **◊ñ◊ô◊ï◊ï◊í FIFO** - ◊ê◊ú◊í◊ï◊®◊ô◊™◊ù ◊†◊õ◊ï◊ü
6. **◊ó◊ô◊©◊ï◊ë P&L** - ◊¢◊ù multiplier
7. **◊û◊†◊ô◊¢◊™ ◊õ◊§◊ô◊ú◊ï◊ô◊ï◊™** - via external_id
8. **WebSocket** - heartbeat + reconnect
9. **DB Schema** - ◊õ◊ú ◊î◊ò◊ë◊ú◊ê◊ï◊™ ◊ï◊î◊¢◊û◊ï◊ì◊ï◊™
10. **RLS Policies** - ◊ê◊ë◊ò◊ó◊î ◊™◊ß◊ô◊†◊î
11. **Sync Logs** - tracking ◊û◊ú◊ê

## 5.3 ◊û◊î ◊¶◊®◊ô◊ö ◊™◊ô◊ß◊ï◊ü ‚ö†Ô∏è

### ◊™◊ô◊ß◊ï◊ü 1: Side UPPERCASE
**◊ß◊ï◊ë◊•:** `tradovateTradeMapper.service.ts`
**◊©◊ï◊®◊î:** ~150
```typescript
// ◊û:
side: direction,
// ◊ú:
side: direction.toUpperCase() as 'LONG' | 'SHORT',
```

### ◊™◊ô◊ß◊ï◊ü 2: useTradovate.ts Service Import
**◊ß◊ï◊ë◊•:** `useTradovate.ts`
**◊©◊ï◊®◊î:** 6
```typescript
// ◊û:
import { tradovateSyncService } from '@/services/brokers/tradovate/tradovateSync.service';
// ◊ú:
import { tradovateSyncV2Service } from '@/services/brokers/tradovate/tradovateSyncV2.service';
```

## 5.4 ◊û◊î ◊ê◊ï◊§◊¶◊ô◊ï◊†◊ú◊ô ◊ú◊©◊ô◊§◊ï◊® üî∂

1. **Stop Price** - ◊õ◊®◊í◊¢ ◊û◊ï◊¢◊®◊ö 2%, ◊ê◊§◊©◊® ◊ú◊©◊ú◊ï◊£ ◊û-Orders API
2. **Fees** - Tradovate ◊ú◊ê ◊©◊ï◊ú◊ó, ◊ê◊§◊©◊® ◊ú◊î◊ï◊°◊ô◊£ ◊ô◊ì◊†◊ô◊™
3. **Auto-Sync** - background service ◊õ◊ú X ◊ì◊ß◊ï◊™
4. **Real-time Processing** - ◊¢◊ô◊ë◊ï◊ì Fill ◊ë◊ï◊ì◊ì ◊ë◊û◊ß◊ï◊ù full sync

---

# üìä ◊ó◊ú◊ß 6: ◊°◊ô◊õ◊ï◊ù ◊ë◊ô◊¶◊ï◊¢◊ô◊ù

## 6.1 Indexes ◊ß◊ô◊ô◊û◊ô◊ù

| ◊ò◊ë◊ú◊î | Index | ◊¢◊û◊ï◊ì◊ï◊™ |
|------|-------|--------|
| broker_definitions | slug | slug |
| broker_definitions | active | is_active |
| broker_connections | user | user_id |
| broker_connections | broker | broker |
| broker_connections | status | status |
| broker_accounts | connection | connection_id |
| broker_accounts | user | user_id |
| broker_sync_logs | connection | connection_id |
| broker_sync_logs | created | created_at DESC |
| trades | broker_connection | broker_connection_id |
| trades | broker_name | broker_name |
| trades | external_id | external_id |
| trades | synced_at | synced_at |
| instrument_definitions | symbol | symbol |

## 6.2 ◊¶◊§◊ô ◊ë◊ô◊¶◊ï◊¢◊ô◊ù

| ◊§◊¢◊ï◊ú◊î | ◊ñ◊û◊ü ◊¶◊§◊ï◊ô | ◊î◊¢◊®◊ï◊™ |
|-------|----------|-------|
| Login | < 1 sec | single API call |
| Get Accounts | < 500ms | cached after first |
| Sync 100 trades | < 5 sec | with enrichment |
| Sync 1000 trades | < 30 sec | bulk operations |
| Duplicate check | < 100ms | indexed external_id |

---

# üéØ ◊°◊ô◊õ◊ï◊ù

## ◊î◊û◊¢◊®◊õ◊™ ◊û◊ï◊õ◊†◊î ◊ú:
‚úÖ ◊ó◊ô◊ë◊ï◊® Tradovate ◊û◊ú◊ê (Demo + Live)
‚úÖ ◊°◊†◊õ◊®◊ï◊ü ◊î◊ô◊°◊ò◊ï◊®◊ô ◊©◊ú ◊ò◊®◊ô◊ô◊ì◊ô◊ù
‚úÖ WebSocket ◊ú◊ñ◊û◊ü ◊ê◊û◊™
‚úÖ ◊û◊†◊ô◊¢◊™ ◊õ◊§◊ô◊ú◊ï◊ô◊ï◊™
‚úÖ ◊ó◊ô◊©◊ï◊ë◊ô P&L ◊†◊õ◊ï◊†◊ô◊ù ◊¢◊ù multiplier
‚úÖ ◊™◊û◊ô◊õ◊î ◊¢◊™◊ô◊ì◊ô◊™ ◊ë-14 ◊ë◊®◊ï◊ß◊®◊ô◊ù ◊†◊ï◊°◊§◊ô◊ù

## ◊†◊ì◊®◊© ◊ú◊§◊†◊ô Production:
‚ö†Ô∏è ◊™◊ô◊ß◊ï◊ü side ◊ú-UPPERCASE
‚ö†Ô∏è ◊¢◊ì◊õ◊ï◊ü import ◊ë-useTradovate.ts
üî∂ ◊ë◊ì◊ô◊ß◊™ E2E ◊û◊ú◊ê◊î

## ◊î◊®◊ó◊ë◊ï◊™ ◊¢◊™◊ô◊ì◊ô◊ï◊™:
üîÆ Bybit/Binance integration (Schema ready)
üîÆ Auto-sync background service
üîÆ Multi-account parallel sync
üîÆ Advanced stop price detection

---

**◊û◊°◊û◊ö ◊ñ◊î ◊û◊°◊§◊ß ◊™◊û◊ï◊†◊î ◊û◊ú◊ê◊î ◊©◊ú ◊ê◊®◊õ◊ô◊ò◊ß◊ò◊ï◊®◊™ ◊î-Database ◊ï◊ê◊ô◊†◊ò◊í◊®◊¶◊ô◊ô◊™ ◊î◊ë◊®◊ï◊ß◊®◊ô◊ù ◊ë-Finotaur.**
**◊õ◊ú ◊û◊§◊™◊ó ◊©◊ô◊ß◊ë◊ú ◊û◊°◊û◊ö ◊ñ◊î ◊ô◊ï◊õ◊ú ◊ú◊î◊ë◊ô◊ü, ◊ú◊™◊ó◊ñ◊ß ◊ï◊ú◊î◊®◊ó◊ô◊ë ◊ê◊™ ◊î◊û◊¢◊®◊õ◊™.**