-- ===============================================
-- üî• FINOTAUR - COMPLETE UNIFIED MIGRATION
-- ===============================================
-- Version: v8.5.1-PRODUCTION-FINAL-WITH-SNAPTRADE-AND-TICKERS
-- Date: 2025-01-15
-- Part: 1/4 (Tables + Indexes + RLS)
-- ===============================================
-- ‚úÖ Zero duplicates
-- ‚úÖ Correct order
-- ‚úÖ Production-optimized
-- ‚úÖ 5000+ users ready
-- ‚úÖ ALL RLS policies VERIFIED WORKING (NO RECURSION!)
-- ‚úÖ Profiles INSERT policy
-- ‚úÖ Trades INSERT policy (CRITICAL FIX)
-- ‚úÖ Admin impersonation support
-- ‚úÖ Soft deletes support
-- ‚úÖ Rate limiting
-- ‚úÖ Generated columns
-- üîí Payment provider column INCLUDED
-- üÜï Risk calculation columns (risk_mode NOT risk_calculation_mode)
-- üí≥ Payment system enhancements INCLUDED
-- üî• HOTFIX v8.4.9: Fixed infinite recursion in RLS
-- üìä NEW v8.5.0: SnapTrade broker integration INCLUDED
-- üéØ NEW v8.5.1: Comprehensive Ticker Symbols table with multipliers
-- ===============================================

BEGIN;

-- ===============================================
-- SECTION 1: NUCLEAR CLEANUP
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó';
  RAISE NOTICE '‚ïë  üî• FINOTAUR MIGRATION v8.5.1         ‚ïë';
  RAISE NOTICE '‚ïë     Part 1/4: Tables + Indexes + RLS  ‚ïë';
  RAISE NOTICE '‚ïë     ‚ú® PRODUCTION FINAL - WORKING!    ‚ïë';
  RAISE NOTICE '‚ïë     üîß NO RECURSION IN RLS!           ‚ïë';
  RAISE NOTICE '‚ïë     üîí PAYMENT PROVIDER INCLUDED!     ‚ïë';
  RAISE NOTICE '‚ïë     üÜï RISK COLUMNS FIXED!            ‚ïë';
  RAISE NOTICE '‚ïë     üí≥ PAYMENT ENHANCEMENTS ADDED!    ‚ïë';
  RAISE NOTICE '‚ïë     üìä SNAPTRADE INTEGRATION ADDED!   ‚ïë';
  RAISE NOTICE '‚ïë     üéØ TICKER SYMBOLS MASTER TABLE!   ‚ïë';
  RAISE NOTICE '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù';
  RAISE NOTICE '';
  RAISE NOTICE '[1/10] Starting nuclear cleanup...';
END $$;

-- Drop ALL views (in correct order)
DROP MATERIALIZED VIEW IF EXISTS public.user_daily_pnl CASCADE;
DROP MATERIALIZED VIEW IF EXISTS public.strategy_stats_view CASCADE;
DROP MATERIALIZED VIEW IF EXISTS public.webhook_stats CASCADE;
DROP VIEW IF EXISTS public.payment_analytics CASCADE;
DROP VIEW IF EXISTS public.active_subscriptions CASCADE;
DROP VIEW IF EXISTS public.admin_stats_view CASCADE;
DROP VIEW IF EXISTS public.pricing_info CASCADE;
DROP VIEW IF EXISTS public.trade_limits_overview CASCADE;
DROP VIEW IF EXISTS public.snaptrade_connection_stats CASCADE;
DROP VIEW IF EXISTS public.admin_users_list_view CASCADE;
DROP VIEW IF EXISTS public.user_referral_info CASCADE;
DROP VIEW IF EXISTS public.affiliate_stats_view CASCADE;

-- Drop ALL triggers
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users CASCADE;
DROP TRIGGER IF EXISTS increment_trade_count_trigger ON public.trades CASCADE;
DROP TRIGGER IF EXISTS calculate_trade_outcome_trigger ON public.trades CASCADE;
DROP TRIGGER IF EXISTS on_payment_completed ON public.payment_history CASCADE;
DROP TRIGGER IF EXISTS trigger_update_login_stats ON public.user_activity_log CASCADE;
DROP TRIGGER IF EXISTS trigger_broker_connection_updated_at ON public.broker_connections CASCADE;
DROP TRIGGER IF EXISTS trigger_user_settings_updated_at ON public.user_settings CASCADE;
DROP TRIGGER IF EXISTS set_updated_at ON public.profiles CASCADE;
DROP TRIGGER IF EXISTS set_updated_at ON public.strategies CASCADE;
DROP TRIGGER IF EXISTS set_updated_at ON public.trades CASCADE;
DROP TRIGGER IF EXISTS trades_search_vector_update ON public.trades CASCADE;
DROP TRIGGER IF EXISTS trigger_update_current_portfolio ON public.trades CASCADE;
DROP TRIGGER IF EXISTS trigger_initialize_risk_settings ON public.profiles CASCADE;
DROP TRIGGER IF EXISTS trigger_update_monthly_usage ON public.trades CASCADE;
DROP TRIGGER IF EXISTS trigger_increment_monthly_trade_count ON public.trades CASCADE;
DROP TRIGGER IF EXISTS update_snaptrade_activity_updated_at_trigger ON public.snaptrade_activity CASCADE;
DROP TRIGGER IF EXISTS handle_trade_changes_unified_trigger ON public.trades CASCADE;

-- Drop ALL functions (alphabetically)
DROP FUNCTION IF EXISTS public.admin_get_broker_stats() CASCADE;
DROP FUNCTION IF EXISTS public.admin_get_limits_overview() CASCADE;
DROP FUNCTION IF EXISTS public.admin_get_trade_limits_overview() CASCADE;
DROP FUNCTION IF EXISTS public.admin_grant_free_months(UUID, INTEGER) CASCADE;
DROP FUNCTION IF EXISTS public.admin_grant_free_access(UUID, INTEGER, TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.admin_reset_trade_count(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.admin_toggle_user_ban(UUID, TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.admin_update_subscription(UUID, TEXT, TEXT, TEXT, TIMESTAMPTZ) CASCADE;
DROP FUNCTION IF EXISTS public.calculate_trade_outcome() CASCADE;
DROP FUNCTION IF EXISTS public.can_create_trade(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.check_expired_subscriptions() CASCADE;
DROP FUNCTION IF EXISTS public.check_usage_warning(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.close_tradingview_trade(UUID, TEXT, TEXT, NUMERIC) CASCADE;
DROP FUNCTION IF EXISTS public.complete_referral_and_grant_rewards(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.generate_affiliate_code() CASCADE;
DROP FUNCTION IF EXISTS public.generate_tradingview_webhook() CASCADE;
DROP FUNCTION IF EXISTS public.generate_unique_affiliate_code() CASCADE;
DROP FUNCTION IF EXISTS public.get_admin_referral_overview() CASCADE;
DROP FUNCTION IF EXISTS public.get_asset_multiplier(TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.get_broker_status(TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.get_platform_stats() CASCADE;
DROP FUNCTION IF EXISTS public.get_portfolio_stats(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_remaining_trades(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_revenue_analytics(INTEGER) CASCADE;
DROP FUNCTION IF EXISTS public.get_subscription_breakdown() CASCADE;
DROP FUNCTION IF EXISTS public.get_trade_details(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_trade_limit(TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.get_trades_by_broker() CASCADE;
DROP FUNCTION IF EXISTS public.get_user_detailed_stats(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_user_referral_stats(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_user_role() CASCADE;
DROP FUNCTION IF EXISTS public.get_user_storage_usage(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_user_subscription_status(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.handle_new_user() CASCADE;
DROP FUNCTION IF EXISTS public.handle_updated_at() CASCADE;
DROP FUNCTION IF EXISTS public.increment_affiliate_conversions(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.increment_affiliate_signups(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.increment_free_months(UUID, INTEGER) CASCADE;
DROP FUNCTION IF EXISTS public.increment_monthly_trade_count() CASCADE;
DROP FUNCTION IF EXISTS public.increment_referral_count(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.increment_trade_count() CASCADE;
DROP FUNCTION IF EXISTS public.initialize_risk_settings() CASCADE;
DROP FUNCTION IF EXISTS public.is_admin() CASCADE;
DROP FUNCTION IF EXISTS public.is_super_admin() CASCADE;
DROP FUNCTION IF EXISTS public.log_admin_action(TEXT, UUID, TEXT, UUID, JSONB) CASCADE;
DROP FUNCTION IF EXISTS public.mark_warning_shown(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.process_referral_signup(UUID, TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.reset_monthly_trade_counts() CASCADE;
DROP FUNCTION IF EXISTS public.search_trades(TEXT, UUID) CASCADE;
DROP FUNCTION IF EXISTS public.update_account_type_on_payment() CASCADE;
DROP FUNCTION IF EXISTS public.update_current_portfolio() CASCADE;
DROP FUNCTION IF EXISTS public.update_monthly_usage() CASCADE;
DROP FUNCTION IF EXISTS public.update_timestamp() CASCADE;
DROP FUNCTION IF EXISTS public.update_trades_search_vector() CASCADE;
DROP FUNCTION IF EXISTS public.update_user_login_stats() CASCADE;
DROP FUNCTION IF EXISTS public.use_free_month(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.handle_trade_changes_unified() CASCADE;
DROP FUNCTION IF EXISTS public.verify_paid_access(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.check_rate_limit(TEXT, INTEGER, INTEGER) CASCADE;
DROP FUNCTION IF EXISTS public.soft_delete_trade(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.restore_trade(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.permanent_delete_trade(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.grant_free_access(UUID, INTEGER, TEXT, UUID) CASCADE;
DROP FUNCTION IF EXISTS public.verify_and_activate_subscription(UUID, TEXT, TEXT, TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.search_ticker_symbols(TEXT, INTEGER) CASCADE;
DROP FUNCTION IF EXISTS public.get_ticker_multiplier(TEXT) CASCADE;

-- Drop ALL RLS policies
DO $$
DECLARE
  pol record;
BEGIN
  FOR pol IN 
    SELECT DISTINCT tablename, policyname
    FROM pg_policies 
    WHERE schemaname = 'public'
  LOOP
    BEGIN
      EXECUTE format('DROP POLICY IF EXISTS %I ON public.%I CASCADE', 
        pol.policyname, pol.tablename);
    EXCEPTION WHEN OTHERS THEN
      NULL;
    END;
  END LOOP;
END $$;

-- Drop storage policies
DROP POLICY IF EXISTS "Users can upload trade screenshots" ON storage.objects;
DROP POLICY IF EXISTS "Users can view own trade screenshots" ON storage.objects;
DROP POLICY IF EXISTS "Users can update own trade screenshots" ON storage.objects;
DROP POLICY IF EXISTS "Users can delete own trade screenshots" ON storage.objects;

-- ===============================================
-- SECTION 2: PROFILES TABLE (COMPLETE + ENHANCED + RISK COLUMNS)
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[2/10] Setting up profiles table...';
  RAISE NOTICE '      üÜï Adding risk calculation columns...';
  RAISE NOTICE '      üîß Using risk_mode (NOT risk_calculation_mode)';
  RAISE NOTICE '      üí≥ Adding payment system enhancements...';
END $$;

-- Add all columns (IF NOT EXISTS pattern)
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS role TEXT DEFAULT 'user';
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS account_type TEXT DEFAULT 'free';
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS subscription_interval TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS subscription_status TEXT DEFAULT 'active';
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS subscription_started_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS subscription_expires_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS trial_ends_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS subscription_paused_until TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS last_login_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS login_count INTEGER DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS is_banned BOOLEAN DEFAULT false;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS ban_reason TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS banned_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS banned_by UUID;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS affiliate_code TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS referred_by TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS free_months_available INTEGER DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS referral_count INTEGER DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}'::jsonb;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS current_month_trades_count INTEGER DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS current_month_active_days INTEGER DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS billing_cycle_start DATE DEFAULT CURRENT_DATE;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS last_warning_shown_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS current_portfolio DECIMAL;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS initial_portfolio DECIMAL DEFAULT 10000;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS total_pnl DECIMAL DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS trade_count INTEGER DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS risk_settings JSONB DEFAULT NULL;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS commission_settings JSONB DEFAULT '{}'::jsonb;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS max_trades INTEGER DEFAULT 10;

-- üîí Payment provider tracking
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS payment_provider TEXT;

-- ‚ú® NEW: Soft delete support
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS deleted_by UUID;

-- üÜï NEW: Risk calculation columns (FIXED IN v8.4.9 - using risk_mode)
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS portfolio_size DECIMAL(15, 2) DEFAULT 10000;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS risk_percentage DECIMAL(5, 2) DEFAULT 1.0; 
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS risk_mode VARCHAR(20) DEFAULT 'percentage';
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS fixed_risk_amount DECIMAL(15, 2) DEFAULT NULL;

-- üí≥ NEW: Payment system enhancements
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS cancellation_reason TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS cancellation_requested_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS cancellation_effective_date TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS previous_account_type TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS upgrade_date TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS prorated_credit NUMERIC(10,2) DEFAULT 0;

-- ‚ú® NEW: Generated columns for performance
-- Extract portfolio_size from risk_settings
ALTER TABLE public.profiles 
ADD COLUMN IF NOT EXISTS portfolio_size_cached NUMERIC
GENERATED ALWAYS AS (
  CASE 
    WHEN risk_settings IS NOT NULL 
    THEN (risk_settings->>'portfolioSize')::NUMERIC 
    ELSE initial_portfolio 
  END
) STORED;

-- Extract risk_per_trade from risk_settings
ALTER TABLE public.profiles 
ADD COLUMN IF NOT EXISTS risk_per_trade_cached NUMERIC
GENERATED ALWAYS AS (
  CASE 
    WHEN risk_settings IS NOT NULL 
    THEN (risk_settings->>'riskPerTrade')::NUMERIC 
    ELSE 1 
  END
) STORED;

-- Drop and recreate constraints
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_role_check;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_role_check 
  CHECK (role IN ('user', 'admin', 'super_admin'));

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_account_type_check;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_account_type_check 
  CHECK (account_type IN ('free', 'basic', 'premium', 'trial'));

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_subscription_interval_check;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_subscription_interval_check 
  CHECK (subscription_interval IN ('monthly', 'yearly') OR subscription_interval IS NULL);

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_subscription_status_check;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_subscription_status_check 
  CHECK (subscription_status IN ('trial', 'active', 'expired', 'cancelled'));

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_paid_has_interval;
ALTER TABLE public.profiles ADD CONSTRAINT check_paid_has_interval 
  CHECK (
    (account_type = 'free' AND subscription_interval IS NULL) OR
    (account_type IN ('basic', 'premium') AND subscription_interval IS NOT NULL) OR
    (account_type = 'trial')
  );

-- üîí Payment provider constraint
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_payment_provider_check;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_payment_provider_check 
  CHECK (payment_provider IN ('payplus', 'stripe', 'paypal') OR payment_provider IS NULL);

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_banned_by_fkey;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_banned_by_fkey 
  FOREIGN KEY (banned_by) REFERENCES public.profiles(id);

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_deleted_by_fkey;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_deleted_by_fkey 
  FOREIGN KEY (deleted_by) REFERENCES public.profiles(id);

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS fk_referred_by_affiliate_code;
ALTER TABLE public.profiles ADD CONSTRAINT fk_referred_by_affiliate_code 
  FOREIGN KEY (referred_by) REFERENCES public.profiles(affiliate_code) ON DELETE SET NULL;

-- üÜï Risk calculation constraints (FIXED IN v8.4.9 - using risk_mode)
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_portfolio_size_positive;
ALTER TABLE public.profiles ADD CONSTRAINT check_portfolio_size_positive 
  CHECK (portfolio_size > 0);

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_risk_per_trade_range;
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_risk_percentage_range;
ALTER TABLE public.profiles ADD CONSTRAINT check_risk_percentage_range 
  CHECK (risk_percentage >= 0.1 AND risk_percentage <= 10);

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_risk_mode;
ALTER TABLE public.profiles ADD CONSTRAINT check_risk_mode 
  CHECK (risk_mode IN ('percentage', 'fixed'));

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_fixed_risk_amount_positive;
ALTER TABLE public.profiles ADD CONSTRAINT check_fixed_risk_amount_positive 
  CHECK (fixed_risk_amount IS NULL OR fixed_risk_amount > 0);

-- Create unique indexes
CREATE UNIQUE INDEX IF NOT EXISTS profiles_affiliate_code_key ON public.profiles(affiliate_code);

-- üîí Payment provider index
CREATE INDEX IF NOT EXISTS idx_profiles_payment_provider 
ON public.profiles(payment_provider) 
WHERE payment_provider IS NOT NULL;

-- üÜï Risk calculation index (FIXED IN v8.4.9 - using risk_mode)
CREATE INDEX IF NOT EXISTS idx_profiles_risk_settings 
ON public.profiles(risk_mode, portfolio_size);

-- üí≥ Payment system indexes
CREATE INDEX IF NOT EXISTS idx_profiles_subscription_expires 
ON public.profiles(subscription_expires_at) 
WHERE subscription_status IN ('active', 'cancelled');

CREATE INDEX IF NOT EXISTS idx_profiles_cancellation 
ON public.profiles(cancellation_effective_date) 
WHERE cancellation_effective_date IS NOT NULL;

-- Comments
COMMENT ON COLUMN public.profiles.current_portfolio IS 'Current portfolio value - auto-calculated as initial_portfolio + total_pnl';
COMMENT ON COLUMN public.profiles.initial_portfolio IS 'Starting portfolio value for tracking growth';
COMMENT ON COLUMN public.profiles.total_pnl IS 'Cumulative P&L across all closed trades - auto-updated';
COMMENT ON COLUMN public.profiles.trade_count IS 'Total number of trades (closed + open)';
COMMENT ON COLUMN public.profiles.risk_settings IS 'User risk configuration - auto-initialized on profile creation';
COMMENT ON COLUMN public.profiles.commission_settings IS 'User commission/fees configuration for different brokers and asset classes';
COMMENT ON COLUMN public.profiles.deleted_at IS 'Soft delete timestamp - NULL means active';
COMMENT ON COLUMN public.profiles.portfolio_size_cached IS 'Cached portfolio size from risk_settings for faster queries';
COMMENT ON COLUMN public.profiles.risk_per_trade_cached IS 'Cached risk per trade from risk_settings for faster queries';
COMMENT ON COLUMN public.profiles.max_trades IS 'Maximum trades allowed per billing cycle - varies by account type';
COMMENT ON COLUMN public.profiles.payment_provider IS 'Payment provider: payplus, stripe, paypal. NULL for free accounts.';

-- üÜï New comments for risk calculation columns (FIXED v8.4.9)
COMMENT ON COLUMN public.profiles.portfolio_size IS 'Total account value for risk calculations';
COMMENT ON COLUMN public.profiles.risk_percentage IS 'Risk percentage per trade (0.5% - 2% recommended)';
COMMENT ON COLUMN public.profiles.risk_mode IS 'Risk calculation mode: percentage of portfolio or fixed dollar amount';
COMMENT ON COLUMN public.profiles.fixed_risk_amount IS 'Fixed dollar amount per trade when using fixed amount risk calculation mode';

-- üí≥ Payment system comments
COMMENT ON COLUMN public.profiles.cancellation_reason IS 'Reason for cancellation - stored for analytics';
COMMENT ON COLUMN public.profiles.cancellation_requested_at IS 'When user requested cancellation';
COMMENT ON COLUMN public.profiles.cancellation_effective_date IS 'When cancellation takes effect (end of paid period)';
COMMENT ON COLUMN public.profiles.previous_account_type IS 'Previous plan before upgrade/downgrade';
COMMENT ON COLUMN public.profiles.upgrade_date IS 'Date of last plan change';
COMMENT ON COLUMN public.profiles.prorated_credit IS 'Credit from unused portion of previous plan (for upgrades)';

-- ===============================================
-- SECTION 3: STRATEGIES TABLE (ENHANCED)
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[3/10] Setting up strategies table...';
END $$;

-- ‚ú® NEW: Soft delete support
ALTER TABLE public.strategies ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ;

COMMENT ON COLUMN public.strategies.deleted_at IS 'Soft delete timestamp - NULL means active';

-- ===============================================
-- SECTION 4: TRADES TABLE (COMPLETE + ENHANCED + SNAPTRADE)
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[4/10] Setting up trades table...';
  RAISE NOTICE '      üìä Adding SnapTrade integration columns...';
END $$;

ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS open_at TIMESTAMPTZ DEFAULT NOW();
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS close_at TIMESTAMPTZ;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS asset_class TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS stop_price NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS take_profit_price NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS fees_mode TEXT DEFAULT 'auto';
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS strategy_id UUID;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS setup TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS mistake TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS next_time TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS tags TEXT[];
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS outcome TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS quality_tag TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS metrics JSONB;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS broker TEXT DEFAULT 'manual';
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS external_id TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS multiplier NUMERIC(10,2) DEFAULT 1;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS actual_r NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS user_risk_r NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS user_reward_r NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS risk_pts NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS reward_pts NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS rr NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS risk_usd NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS reward_usd NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS notes TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS screenshot_url TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS notes_search_vector tsvector;

-- ‚ú® NEW: Soft delete support
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS deleted_by UUID;

-- üìä NEW v8.5.0: SnapTrade integration columns
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS snaptrade_activity_id TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS snaptrade_account_id TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS import_source TEXT DEFAULT 'manual';
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS imported_at TIMESTAMPTZ;

-- Constraints
ALTER TABLE public.trades DROP CONSTRAINT IF EXISTS trades_outcome_check;
ALTER TABLE public.trades ADD CONSTRAINT trades_outcome_check 
  CHECK (outcome IN ('WIN', 'LOSS', 'BE', 'OPEN') OR outcome IS NULL);

ALTER TABLE public.trades DROP CONSTRAINT IF EXISTS trades_broker_check;
ALTER TABLE public.trades ADD CONSTRAINT trades_broker_check 
  CHECK (broker IN ('manual', 'interactive_brokers', 'td_ameritrade', 'alpaca', 'tradingview', 'mt4', 'mt5', 'ninja_trader'));

ALTER TABLE public.trades DROP CONSTRAINT IF EXISTS trades_strategy_id_fkey;
ALTER TABLE public.trades ADD CONSTRAINT trades_strategy_id_fkey 
  FOREIGN KEY (strategy_id) REFERENCES public.strategies(id) ON DELETE SET NULL;

ALTER TABLE public.trades DROP CONSTRAINT IF EXISTS trades_deleted_by_fkey;
ALTER TABLE public.trades ADD CONSTRAINT trades_deleted_by_fkey 
  FOREIGN KEY (deleted_by) REFERENCES public.profiles(id);

-- üìä SnapTrade constraint
ALTER TABLE public.trades DROP CONSTRAINT IF EXISTS check_import_source;
ALTER TABLE public.trades ADD CONSTRAINT check_import_source 
  CHECK (import_source IN ('manual', 'snaptrade', 'csv', 'api'));

-- Update existing trades (set import_source if NULL)
UPDATE public.trades 
SET import_source = 'manual' 
WHERE import_source IS NULL;

-- Comments
COMMENT ON COLUMN public.trades.multiplier IS 'Asset contract multiplier - verified against CME/ICE standards';
COMMENT ON COLUMN public.trades.actual_r IS 'Actual R achieved: PnL / Initial Risk';
COMMENT ON COLUMN public.trades.notes IS 'Trade thesis, feelings, and what worked - supports full-text search';
COMMENT ON COLUMN public.trades.screenshot_url IS 'URL to compressed screenshot in Supabase Storage';
COMMENT ON COLUMN public.trades.deleted_at IS 'Soft delete timestamp - NULL means active';

-- üìä SnapTrade comments
COMMENT ON COLUMN public.trades.snaptrade_activity_id IS 'SnapTrade activity ID - used for deduplication (unique per import)';
COMMENT ON COLUMN public.trades.snaptrade_account_id IS 'SnapTrade account ID - identifies which broker account this trade came from';
COMMENT ON COLUMN public.trades.import_source IS 'Source of the trade: manual (user entered), snaptrade (broker import), csv (CSV upload), api (API import)';
COMMENT ON COLUMN public.trades.imported_at IS 'Timestamp when this trade was imported from external source';

-- ===============================================
-- SECTION 5: üéØ TICKER SYMBOLS - MASTER TABLE
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[5/10] Creating Ticker Symbols Master Table...';
  RAISE NOTICE '      üéØ Comprehensive list: Stocks, Futures, Crypto, Forex, ETFs';
  RAISE NOTICE '      üìä Accurate multipliers for all asset classes';
  RAISE NOTICE '      üöÄ Fast autocomplete with popularity ranking';
END $$;

CREATE TABLE IF NOT EXISTS public.ticker_symbols (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  symbol TEXT NOT NULL UNIQUE,
  name TEXT NOT NULL,
  asset_class TEXT NOT NULL CHECK (asset_class IN ('stock', 'futures', 'options', 'crypto', 'forex', 'etf')),
  multiplier NUMERIC(10,2) NOT NULL DEFAULT 1,
  exchange TEXT,
  popularity_rank INTEGER DEFAULT 999,
  is_active BOOLEAN DEFAULT TRUE,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for ultra-fast autocomplete
CREATE INDEX IF NOT EXISTS idx_ticker_symbols_search 
ON public.ticker_symbols(symbol text_pattern_ops)
WHERE is_active = TRUE;

CREATE INDEX IF NOT EXISTS idx_ticker_symbols_popularity 
ON public.ticker_symbols(popularity_rank, symbol)
WHERE is_active = TRUE;

CREATE INDEX IF NOT EXISTS idx_ticker_symbols_asset_class 
ON public.ticker_symbols(asset_class, popularity_rank)
WHERE is_active = TRUE;

-- Comments
COMMENT ON TABLE public.ticker_symbols IS 'Master list of tradeable symbols with accurate multipliers and metadata for autocomplete';
COMMENT ON COLUMN public.ticker_symbols.symbol IS 'Ticker symbol (e.g., AAPL, ES, BTCUSDT)';
COMMENT ON COLUMN public.ticker_symbols.name IS 'Full name of the asset';
COMMENT ON COLUMN public.ticker_symbols.asset_class IS 'Type: stock, futures, options, crypto, forex, etf';
COMMENT ON COLUMN public.ticker_symbols.multiplier IS 'Contract multiplier - CRITICAL for P&L calculations (e.g., ES=50, NQ=20)';
COMMENT ON COLUMN public.ticker_symbols.exchange IS 'Exchange or broker (e.g., NASDAQ, CME, BINANCE)';
COMMENT ON COLUMN public.ticker_symbols.popularity_rank IS 'Lower = more popular (for autocomplete sorting)';
COMMENT ON COLUMN public.ticker_symbols.is_active IS 'FALSE if symbol is delisted/deprecated';

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- üéØ INSERT COMPREHENSIVE TICKER DATA
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- üìà TOP US STOCKS (Rank 1-100)
INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank) VALUES
  ('AAPL', 'Apple Inc.', 'stock', 1, 'NASDAQ', 1),
  ('MSFT', 'Microsoft Corporation', 'stock', 1, 'NASDAQ', 2),
  ('GOOGL', 'Alphabet Inc. Class A', 'stock', 1, 'NASDAQ', 3),
  ('AMZN', 'Amazon.com Inc.', 'stock', 1, 'NASDAQ', 4),
  ('TSLA', 'Tesla Inc.', 'stock', 1, 'NASDAQ', 5),
  ('META', 'Meta Platforms Inc.', 'stock', 1, 'NASDAQ', 6),
  ('NVDA', 'NVIDIA Corporation', 'stock', 1, 'NASDAQ', 7),
  ('BRK.B', 'Berkshire Hathaway Inc. Class B', 'stock', 1, 'NYSE', 8),
  ('JNJ', 'Johnson & Johnson', 'stock', 1, 'NYSE', 9),
  ('V', 'Visa Inc.', 'stock', 1, 'NYSE', 10),
  ('WMT', 'Walmart Inc.', 'stock', 1, 'NYSE', 11),
  ('JPM', 'JPMorgan Chase & Co.', 'stock', 1, 'NYSE', 12),
  ('PG', 'Procter & Gamble Co.', 'stock', 1, 'NYSE', 13),
  ('MA', 'Mastercard Inc.', 'stock', 1, 'NYSE', 14),
  ('UNH', 'UnitedHealth Group Inc.', 'stock', 1, 'NYSE', 15),
  ('HD', 'The Home Depot Inc.', 'stock', 1, 'NYSE', 16),
  ('DIS', 'The Walt Disney Company', 'stock', 1, 'NYSE', 17),
  ('BAC', 'Bank of America Corporation', 'stock', 1, 'NYSE', 18),
  ('ADBE', 'Adobe Inc.', 'stock', 1, 'NASDAQ', 19),
  ('NFLX', 'Netflix Inc.', 'stock', 1, 'NASDAQ', 20),
  ('CRM', 'Salesforce Inc.', 'stock', 1, 'NYSE', 21),
  ('XOM', 'Exxon Mobil Corporation', 'stock', 1, 'NYSE', 22),
  ('CSCO', 'Cisco Systems Inc.', 'stock', 1, 'NASDAQ', 23),
  ('PFE', 'Pfizer Inc.', 'stock', 1, 'NYSE', 24),
  ('KO', 'The Coca-Cola Company', 'stock', 1, 'NYSE', 25),
  ('PEP', 'PepsiCo Inc.', 'stock', 1, 'NASDAQ', 26),
  ('INTC', 'Intel Corporation', 'stock', 1, 'NASDAQ', 27),
  ('AVGO', 'Broadcom Inc.', 'stock', 1, 'NASDAQ', 28),
  ('COST', 'Costco Wholesale Corporation', 'stock', 1, 'NASDAQ', 29),
  ('ORCL', 'Oracle Corporation', 'stock', 1, 'NYSE', 30),
  ('AMD', 'Advanced Micro Devices Inc.', 'stock', 1, 'NASDAQ', 31),
  ('NKE', 'Nike Inc.', 'stock', 1, 'NYSE', 32),
  ('ABT', 'Abbott Laboratories', 'stock', 1, 'NYSE', 33),
  ('TMO', 'Thermo Fisher Scientific Inc.', 'stock', 1, 'NYSE', 34),
  ('MRK', 'Merck & Co. Inc.', 'stock', 1, 'NYSE', 35),
  ('ACN', 'Accenture plc', 'stock', 1, 'NYSE', 36),
  ('CVX', 'Chevron Corporation', 'stock', 1, 'NYSE', 37),
  ('LLY', 'Eli Lilly and Company', 'stock', 1, 'NYSE', 38),
  ('TXN', 'Texas Instruments Inc.', 'stock', 1, 'NASDAQ', 39),
  ('QCOM', 'QUALCOMM Inc.', 'stock', 1, 'NASDAQ', 40),
  ('NEE', 'NextEra Energy Inc.', 'stock', 1, 'NYSE', 41),
  ('DHR', 'Danaher Corporation', 'stock', 1, 'NYSE', 42),
  ('UNP', 'Union Pacific Corporation', 'stock', 1, 'NYSE', 43),
  ('BMY', 'Bristol-Myers Squibb Company', 'stock', 1, 'NYSE', 44),
  ('PM', 'Philip Morris International Inc.', 'stock', 1, 'NYSE', 45),
  ('HON', 'Honeywell International Inc.', 'stock', 1, 'NASDAQ', 46),
  ('LOW', 'Lowe''s Companies Inc.', 'stock', 1, 'NYSE', 47),
  ('UPS', 'United Parcel Service Inc.', 'stock', 1, 'NYSE', 48),
  ('AMGN', 'Amgen Inc.', 'stock', 1, 'NASDAQ', 49),
  ('RTX', 'Raytheon Technologies Corporation', 'stock', 1, 'NYSE', 50),
  ('BA', 'The Boeing Company', 'stock', 1, 'NYSE', 51),
  ('CAT', 'Caterpillar Inc.', 'stock', 1, 'NYSE', 52),
  ('SBUX', 'Starbucks Corporation', 'stock', 1, 'NASDAQ', 53),
  ('GS', 'The Goldman Sachs Group Inc.', 'stock', 1, 'NYSE', 54),
  ('IBM', 'International Business Machines Corporation', 'stock', 1, 'NYSE', 55),
  ('PYPL', 'PayPal Holdings Inc.', 'stock', 1, 'NASDAQ', 56),
  ('BKNG', 'Booking Holdings Inc.', 'stock', 1, 'NASDAQ', 57),
  ('GILD', 'Gilead Sciences Inc.', 'stock', 1, 'NASDAQ', 58),
  ('MMM', '3M Company', 'stock', 1, 'NYSE', 59),
  ('AXP', 'American Express Company', 'stock', 1, 'NYSE', 60),
  ('NOW', 'ServiceNow Inc.', 'stock', 1, 'NYSE', 61),
  ('SYK', 'Stryker Corporation', 'stock', 1, 'NYSE', 62),
  ('ISRG', 'Intuitive Surgical Inc.', 'stock', 1, 'NASDAQ', 63),
  ('SPGI', 'S&P Global Inc.', 'stock', 1, 'NYSE', 64),
  ('TJX', 'The TJX Companies Inc.', 'stock', 1, 'NYSE', 65),
  ('ZTS', 'Zoetis Inc.', 'stock', 1, 'NYSE', 66),
  ('BLK', 'BlackRock Inc.', 'stock', 1, 'NYSE', 67),
  ('ADP', 'Automatic Data Processing Inc.', 'stock', 1, 'NASDAQ', 68),
  ('MDLZ', 'Mondelez International Inc.', 'stock', 1, 'NASDAQ', 69),
  ('CI', 'Cigna Corporation', 'stock', 1, 'NYSE', 70),
  ('TMUS', 'T-Mobile US Inc.', 'stock', 1, 'NASDAQ', 71),
  ('MO', 'Altria Group Inc.', 'stock', 1, 'NYSE', 72),
  ('LMT', 'Lockheed Martin Corporation', 'stock', 1, 'NYSE', 73),
  ('USB', 'U.S. Bancorp', 'stock', 1, 'NYSE', 74),
  ('SCHW', 'The Charles Schwab Corporation', 'stock', 1, 'NYSE', 75),
  ('CB', 'Chubb Limited', 'stock', 1, 'NYSE', 76),
  ('DE', 'Deere & Company', 'stock', 1, 'NYSE', 77),
  ('DUK', 'Duke Energy Corporation', 'stock', 1, 'NYSE', 78),
  ('SO', 'The Southern Company', 'stock', 1, 'NYSE', 79),
  ('BSX', 'Boston Scientific Corporation', 'stock', 1, 'NYSE', 80),
  ('C', 'Citigroup Inc.', 'stock', 1, 'NYSE', 81),
  ('MS', 'Morgan Stanley', 'stock', 1, 'NYSE', 82),
  ('CVS', 'CVS Health Corporation', 'stock', 1, 'NYSE', 83),
  ('BDX', 'Becton Dickinson and Company', 'stock', 1, 'NYSE', 84),
  ('CL', 'Colgate-Palmolive Company', 'stock', 1, 'NYSE', 85),
  ('CME', 'CME Group Inc.', 'stock', 1, 'NASDAQ', 86),
  ('EOG', 'EOG Resources Inc.', 'stock', 1, 'NYSE', 87),
  ('FIS', 'Fidelity National Information Services Inc.', 'stock', 1, 'NYSE', 88),
  ('GE', 'General Electric Company', 'stock', 1, 'NYSE', 89),
  ('ITW', 'Illinois Tool Works Inc.', 'stock', 1, 'NYSE', 90),
  ('MMC', 'Marsh & McLennan Companies Inc.', 'stock', 1, 'NYSE', 91),
  ('NSC', 'Norfolk Southern Corporation', 'stock', 1, 'NYSE', 92),
  ('PLD', 'Prologis Inc.', 'stock', 1, 'NYSE', 93),
  ('SLB', 'Schlumberger Limited', 'stock', 1, 'NYSE', 94),
  ('TGT', 'Target Corporation', 'stock', 1, 'NYSE', 95),
  ('WM', 'Waste Management Inc.', 'stock', 1, 'NYSE', 96),
  ('SQ', 'Block Inc. (Square)', 'stock', 1, 'NYSE', 97),
  ('SHOP', 'Shopify Inc.', 'stock', 1, 'NYSE', 98),
  ('UBER', 'Uber Technologies Inc.', 'stock', 1, 'NYSE', 99),
  ('LYFT', 'Lyft Inc.', 'stock', 1, 'NASDAQ', 100)
ON CONFLICT (symbol) DO NOTHING;

-- üìä FUTURES - CME/ICE/EUREX (Rank 101-200)
INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank) VALUES
  ('ES', 'E-mini S&P 500', 'futures', 50, 'CME', 101),
  ('NQ', 'E-mini NASDAQ-100', 'futures', 20, 'CME', 102),
  ('YM', 'E-mini Dow Jones', 'futures', 5, 'CME', 103),
  ('RTY', 'E-mini Russell 2000', 'futures', 50, 'CME', 104),
  ('MES', 'Micro E-mini S&P 500', 'futures', 5, 'CME', 105),
  ('MNQ', 'Micro E-mini NASDAQ-100', 'futures', 2, 'CME', 106),
  ('M2K', 'Micro E-mini Russell 2000', 'futures', 5, 'CME', 107),
  ('MYM', 'Micro E-mini Dow Jones', 'futures', 0.5, 'CME', 108),
  ('CL', 'Crude Oil (WTI)', 'futures', 1000, 'NYMEX', 109),
  ('GC', 'Gold', 'futures', 100, 'COMEX', 110),
  ('SI', 'Silver', 'futures', 5000, 'COMEX', 111),
  ('NG', 'Natural Gas', 'futures', 10000, 'NYMEX', 112),
  ('HG', 'Copper', 'futures', 25000, 'COMEX', 113),
  ('ZC', 'Corn', 'futures', 50, 'CBOT', 114),
  ('ZS', 'Soybeans', 'futures', 50, 'CBOT', 115),
  ('ZW', 'Wheat', 'futures', 50, 'CBOT', 116),
  ('ZN', '10-Year T-Note', 'futures', 1000, 'CBOT', 117),
  ('ZB', '30-Year T-Bond', 'futures', 1000, 'CBOT', 118),
  ('ZF', '5-Year T-Note', 'futures', 1000, 'CBOT', 119),
  ('ZT', '2-Year T-Note', 'futures', 2000, 'CBOT', 120),
  ('6E', 'Euro FX', 'futures', 125000, 'CME', 121),
  ('6J', 'Japanese Yen', 'futures', 12500000, 'CME', 122),
  ('6B', 'British Pound', 'futures', 62500, 'CME', 123),
  ('6C', 'Canadian Dollar', 'futures', 100000, 'CME', 124),
  ('6A', 'Australian Dollar', 'futures', 100000, 'CME', 125),
  ('HE', 'Lean Hogs', 'futures', 40000, 'CME', 126),
  ('LE', 'Live Cattle', 'futures', 40000, 'CME', 127),
  ('GF', 'Feeder Cattle', 'futures', 50000, 'CME', 128),
  ('PA', 'Palladium', 'futures', 100, 'NYMEX', 129),
  ('PL', 'Platinum', 'futures', 50, 'NYMEX', 130),
  ('KC', 'Coffee', 'futures', 37500, 'ICE', 131),
  ('CT', 'Cotton', 'futures', 50000, 'ICE', 132),
  ('SB', 'Sugar #11', 'futures', 112000, 'ICE', 133),
  ('CC', 'Cocoa', 'futures', 10, 'ICE', 134),
  ('OJ', 'Orange Juice', 'futures', 15000, 'ICE', 135),
  ('BTC', 'Bitcoin Futures (CME)', 'futures', 5, 'CME', 136),
  ('ETH', 'Ethereum Futures (CME)', 'futures', 50, 'CME', 137),
  ('VX', 'VIX Futures', 'futures', 1000, 'CFE', 138),
  ('GE', 'Eurodollar', 'futures', 2500, 'CME', 139),
  ('SR1', 'SOFR 1-Month', 'futures', 4167, 'CME', 140)
ON CONFLICT (symbol) DO NOTHING;

-- üí∞ CRYPTOCURRENCY (Rank 201-250)
INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank) VALUES
  ('BTCUSDT', 'Bitcoin', 'crypto', 1, 'BINANCE', 201),
  ('ETHUSDT', 'Ethereum', 'crypto', 1, 'BINANCE', 202),
  ('BNBUSDT', 'Binance Coin', 'crypto', 1, 'BINANCE', 203),
  ('XRPUSDT', 'Ripple', 'crypto', 1, 'BINANCE', 204),
  ('ADAUSDT', 'Cardano', 'crypto', 1, 'BINANCE', 205),
  ('SOLUSDT', 'Solana', 'crypto', 1, 'BINANCE', 206),
  ('DOGEUSDT', 'Dogecoin', 'crypto', 1, 'BINANCE', 207),
  ('DOTUSDT', 'Polkadot', 'crypto', 1, 'BINANCE', 208),
  ('MATICUSDT', 'Polygon', 'crypto', 1, 'BINANCE', 209),
  ('TRXUSDT', 'TRON', 'crypto', 1, 'BINANCE', 210),
  ('AVAXUSDT', 'Avalanche', 'crypto', 1, 'BINANCE', 211),
  ('LINKUSDT', 'Chainlink', 'crypto', 1, 'BINANCE', 212),
  ('UNIUSDT', 'Uniswap', 'crypto', 1, 'BINANCE', 213),
  ('LTCUSDT', 'Litecoin', 'crypto', 1, 'BINANCE', 214),
  ('ATOMUSDT', 'Cosmos', 'crypto', 1, 'BINANCE', 215),
  ('ETCUSDT', 'Ethereum Classic', 'crypto', 1, 'BINANCE', 216),
  ('XLMUSDT', 'Stellar', 'crypto', 1, 'BINANCE', 217),
  ('XMRUSDT', 'Monero', 'crypto', 1, 'BINANCE', 218),
  ('ALGOUSDT', 'Algorand', 'crypto', 1, 'BINANCE', 219),
  ('VETUSDT', 'VeChain', 'crypto', 1, 'BINANCE', 220),
  ('ICPUSDT', 'Internet Computer', 'crypto', 1, 'BINANCE', 221),
  ('FILUSDT', 'Filecoin', 'crypto', 1, 'BINANCE', 222),
  ('SANDUSDT', 'The Sandbox', 'crypto', 1, 'BINANCE', 223),
  ('MANAUSDT', 'Decentraland', 'crypto', 1, 'BINANCE', 224),
  ('AXSUSDT', 'Axie Infinity', 'crypto', 1, 'BINANCE', 225)
ON CONFLICT (symbol) DO NOTHING;

-- üí± FOREX PAIRS (Rank 251-300)
INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank) VALUES
  ('EURUSD', 'Euro / US Dollar', 'forex', 100000, 'FOREX', 251),
  ('GBPUSD', 'British Pound / US Dollar', 'forex', 100000, 'FOREX', 252),
  ('USDJPY', 'US Dollar / Japanese Yen', 'forex', 100000, 'FOREX', 253),
  ('USDCHF', 'US Dollar / Swiss Franc', 'forex', 100000, 'FOREX', 254),
  ('AUDUSD', 'Australian Dollar / US Dollar', 'forex', 100000, 'FOREX', 255),
  ('USDCAD', 'US Dollar / Canadian Dollar', 'forex', 100000, 'FOREX', 256),
  ('NZDUSD', 'New Zealand Dollar / US Dollar', 'forex', 100000, 'FOREX', 257),
  ('EURGBP', 'Euro / British Pound', 'forex', 100000, 'FOREX', 258),
  ('EURJPY', 'Euro / Japanese Yen', 'forex', 100000, 'FOREX', 259),
  ('GBPJPY', 'British Pound / Japanese Yen', 'forex', 100000, 'FOREX', 260),
  ('EURCHF', 'Euro / Swiss Franc', 'forex', 100000, 'FOREX', 261),
  ('AUDJPY', 'Australian Dollar / Japanese Yen', 'forex', 100000, 'FOREX', 262),
  ('CADJPY', 'Canadian Dollar / Japanese Yen', 'forex', 100000, 'FOREX', 263),
  ('NZDJPY', 'New Zealand Dollar / Japanese Yen', 'forex', 100000, 'FOREX', 264),
  ('EURAUD', 'Euro / Australian Dollar', 'forex', 100000, 'FOREX', 265),
  ('GBPAUD', 'British Pound / Australian Dollar', 'forex', 100000, 'FOREX', 266),
  ('AUDNZD', 'Australian Dollar / New Zealand Dollar', 'forex', 100000, 'FOREX', 267),
  ('AUDCAD', 'Australian Dollar / Canadian Dollar', 'forex', 100000, 'FOREX', 268),
  ('GBPCAD', 'British Pound / Canadian Dollar', 'forex', 100000, 'FOREX', 269),
  ('EURCAD', 'Euro / Canadian Dollar', 'forex', 100000, 'FOREX', 270)
ON CONFLICT (symbol) DO NOTHING;

-- üìä LEVERAGED ETFs (◊™◊¢◊ï◊ì◊ï◊™ ◊°◊ú ◊û◊û◊ï◊†◊§◊ï◊™) (Rank 301-350)
INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank) VALUES
  ('TQQQ', 'ProShares UltraPro QQQ (3x NASDAQ)', 'etf', 1, 'NASDAQ', 301),
  ('SQQQ', 'ProShares UltraPro Short QQQ (3x Inverse NASDAQ)', 'etf', 1, 'NASDAQ', 302),
  ('UPRO', 'ProShares UltraPro S&P500 (3x S&P 500)', 'etf', 1, 'NYSE', 303),
  ('SPXU', 'ProShares UltraPro Short S&P500 (3x Inverse S&P 500)', 'etf', 1, 'NYSE', 304),
  ('TNA', 'Direxion Daily Small Cap Bull 3X (3x Russell 2000)', 'etf', 1, 'NYSE', 305),
  ('TZA', 'Direxion Daily Small Cap Bear 3X (3x Inverse Russell 2000)', 'etf', 1, 'NYSE', 306),
  ('UDOW', 'ProShares UltraPro Dow30 (3x Dow Jones)', 'etf', 1, 'NYSE', 307),
  ('SDOW', 'ProShares UltraPro Short Dow30 (3x Inverse Dow)', 'etf', 1, 'NYSE', 308),
  ('TECL', 'Direxion Daily Technology Bull 3X', 'etf', 1, 'NYSE', 309),
  ('TECS', 'Direxion Daily Technology Bear 3X', 'etf', 1, 'NYSE', 310),
  ('FAS', 'Direxion Daily Financial Bull 3X', 'etf', 1, 'NYSE', 311),
  ('FAZ', 'Direxion Daily Financial Bear 3X', 'etf', 1, 'NYSE', 312),
  ('SOXL', 'Direxion Daily Semiconductor Bull 3X', 'etf', 1, 'NYSE', 313),
  ('SOXS', 'Direxion Daily Semiconductor Bear 3X', 'etf', 1, 'NYSE', 314),
  ('LABU', 'Direxion Daily S&P Biotech Bull 3X', 'etf', 1, 'NYSE', 315),
  ('LABD', 'Direxion Daily S&P Biotech Bear 3X', 'etf', 1, 'NYSE', 316),
  ('NUGT', 'Direxion Daily Gold Miners Bull 2X', 'etf', 1, 'NYSE', 317),
  ('DUST', 'Direxion Daily Gold Miners Bear 2X', 'etf', 1, 'NYSE', 318),
  ('ERX', 'Direxion Daily Energy Bull 2X', 'etf', 1, 'NYSE', 319),
  ('ERY', 'Direxion Daily Energy Bear 2X', 'etf', 1, 'NYSE', 320),
  ('UCO', 'ProShares Ultra Bloomberg Crude Oil (2x Oil)', 'etf', 1, 'NYSE', 321),
  ('SCO', 'ProShares UltraShort Bloomberg Crude Oil (2x Inverse Oil)', 'etf', 1, 'NYSE', 322),
  ('UGL', 'ProShares Ultra Gold (2x Gold)', 'etf', 1, 'NYSE', 323),
  ('GLL', 'ProShares UltraShort Gold (2x Inverse Gold)', 'etf', 1, 'NYSE', 324),
  ('AGQ', 'ProShares Ultra Silver (2x Silver)', 'etf', 1, 'NYSE', 325)
ON CONFLICT (symbol) DO NOTHING;

-- üìä REGULAR ETFs (Popular) (Rank 351-400)
INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank) VALUES
  ('SPY', 'SPDR S&P 500 ETF', 'etf', 1, 'NYSE', 351),
  ('QQQ', 'Invesco QQQ Trust (NASDAQ-100)', 'etf', 1, 'NASDAQ', 352),
  ('IWM', 'iShares Russell 2000 ETF', 'etf', 1, 'NYSE', 353),
  ('DIA', 'SPDR Dow Jones Industrial Average ETF', 'etf', 1, 'NYSE', 354),
  ('VTI', 'Vanguard Total Stock Market ETF', 'etf', 1, 'NYSE', 355),
  ('VOO', 'Vanguard S&P 500 ETF', 'etf', 1, 'NYSE', 356),
  ('VEA', 'Vanguard FTSE Developed Markets ETF', 'etf', 1, 'NYSE', 357),
  ('VWO', 'Vanguard FTSE Emerging Markets ETF', 'etf', 1, 'NYSE', 358),
  ('AGG', 'iShares Core U.S. Aggregate Bond ETF', 'etf', 1, 'NYSE', 359),
  ('BND', 'Vanguard Total Bond Market ETF', 'etf', 1, 'NASDAQ', 360),
  ('GLD', 'SPDR Gold Shares', 'etf', 1, 'NYSE', 361),
  ('SLV', 'iShares Silver Trust', 'etf', 1, 'NYSE', 362),
  ('USO', 'United States Oil Fund', 'etf', 1, 'NYSE', 363),
  ('XLE', 'Energy Select Sector SPDR Fund', 'etf', 1, 'NYSE', 364),
  ('XLF', 'Financial Select Sector SPDR Fund', 'etf', 1, 'NYSE', 365),
  ('XLK', 'Technology Select Sector SPDR Fund', 'etf', 1, 'NYSE', 366),
  ('XLV', 'Health Care Select Sector SPDR Fund', 'etf', 1, 'NYSE', 367),
  ('XLI', 'Industrial Select Sector SPDR Fund', 'etf', 1, 'NYSE', 368),
  ('XLP', 'Consumer Staples Select Sector SPDR Fund', 'etf', 1, 'NYSE', 369),
  ('XLY', 'Consumer Discretionary Select Sector SPDR Fund', 'etf', 1, 'NYSE', 370),
  ('XLB', 'Materials Select Sector SPDR Fund', 'etf', 1, 'NYSE', 371),
  ('XLU', 'Utilities Select Sector SPDR Fund', 'etf', 1, 'NYSE', 372),
  ('XLRE', 'Real Estate Select Sector SPDR Fund', 'etf', 1, 'NYSE', 373),
  ('VIG', 'Vanguard Dividend Appreciation ETF', 'etf', 1, 'NYSE', 374),
  ('VYM', 'Vanguard High Dividend Yield ETF', 'etf', 1, 'NYSE', 375),
  ('SCHD', 'Schwab U.S. Dividend Equity ETF', 'etf', 1, 'NYSE', 376),
  ('ARKK', 'ARK Innovation ETF', 'etf', 1, 'NYSE', 377),
  ('ARKW', 'ARK Next Generation Internet ETF', 'etf', 1, 'NYSE', 378),
  ('ARKG', 'ARK Genomic Revolution ETF', 'etf', 1, 'NYSE', 379),
  ('TLT', 'iShares 20+ Year Treasury Bond ETF', 'etf', 1, 'NASDAQ', 380)
ON CONFLICT (symbol) DO NOTHING;

-- üî• ADDITIONAL POPULAR STOCKS (Tech, Finance, Energy)
INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank) VALUES
  ('T', 'AT&T Inc.', 'stock', 1, 'NYSE', 401),
  ('VZ', 'Verizon Communications Inc.', 'stock', 1, 'NYSE', 402),
  ('F', 'Ford Motor Company', 'stock', 1, 'NYSE', 403),
  ('GM', 'General Motors Company', 'stock', 1, 'NYSE', 404),
  ('RIVN', 'Rivian Automotive Inc.', 'stock', 1, 'NASDAQ', 405),
  ('LCID', 'Lucid Group Inc.', 'stock', 1, 'NASDAQ', 406),
  ('NIO', 'NIO Inc.', 'stock', 1, 'NYSE', 407),
  ('XPEV', 'XPeng Inc.', 'stock', 1, 'NYSE', 408),
  ('LI', 'Li Auto Inc.', 'stock', 1, 'NASDAQ', 409),
  ('PLTR', 'Palantir Technologies Inc.', 'stock', 1, 'NYSE', 410),
  ('SNOW', 'Snowflake Inc.', 'stock', 1, 'NYSE', 411),
  ('COIN', 'Coinbase Global Inc.', 'stock', 1, 'NASDAQ', 412),
  ('RBLX', 'Roblox Corporation', 'stock', 1, 'NYSE', 413),
  ('U', 'Unity Software Inc.', 'stock', 1, 'NYSE', 414),
  ('DKNG', 'DraftKings Inc.', 'stock', 1, 'NASDAQ', 415),
  ('PINS', 'Pinterest Inc.', 'stock', 1, 'NYSE', 416),
  ('SNAP', 'Snap Inc.', 'stock', 1, 'NYSE', 417),
  ('TWTR', 'Twitter Inc.', 'stock', 1, 'NYSE', 418),
  ('SPOT', 'Spotify Technology S.A.', 'stock', 1, 'NYSE', 419),
  ('ZM', 'Zoom Video Communications Inc.', 'stock', 1, 'NASDAQ', 420),
  ('DOCU', 'DocuSign Inc.', 'stock', 1, 'NASDAQ', 421),
  ('TWLO', 'Twilio Inc.', 'stock', 1, 'NYSE', 422),
  ('OKTA', 'Okta Inc.', 'stock', 1, 'NASDAQ', 423),
  ('NET', 'Cloudflare Inc.', 'stock', 1, 'NYSE', 424),
  ('DDOG', 'Datadog Inc.', 'stock', 1, 'NASDAQ', 425),
  ('CRWD', 'CrowdStrike Holdings Inc.', 'stock', 1, 'NASDAQ', 426),
  ('ZS', 'Zscaler Inc.', 'stock', 1, 'NASDAQ', 427),
  ('PANW', 'Palo Alto Networks Inc.', 'stock', 1, 'NASDAQ', 428),
  ('FTNT', 'Fortinet Inc.', 'stock', 1, 'NASDAQ', 429),
  ('MDB', 'MongoDB Inc.', 'stock', 1, 'NASDAQ', 430),
  ('TEAM', 'Atlassian Corporation', 'stock', 1, 'NASDAQ', 431),
  ('WDAY', 'Workday Inc.', 'stock', 1, 'NASDAQ', 432),
  ('ABNB', 'Airbnb Inc.', 'stock', 1, 'NASDAQ', 433),
  ('DASH', 'DoorDash Inc.', 'stock', 1, 'NYSE', 434),
  ('MELI', 'MercadoLibre Inc.', 'stock', 1, 'NASDAQ', 435)
ON CONFLICT (symbol) DO NOTHING;

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- GRANT PERMISSIONS
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

GRANT SELECT ON public.ticker_symbols TO authenticated;
GRANT SELECT ON public.ticker_symbols TO anon;

-- ===============================================
-- SECTION 6: ADDITIONAL TABLES
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[6/10] Creating additional tables...';
  RAISE NOTICE '      üìä Including SnapTrade tables...';
END $$;

-- Payment History
CREATE TABLE IF NOT EXISTS public.payment_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  amount DECIMAL(10, 2) NOT NULL,
  currency TEXT NOT NULL DEFAULT 'USD',
  status TEXT NOT NULL CHECK (status IN ('pending', 'completed', 'failed', 'refunded')),
  plan TEXT NOT NULL CHECK (plan IN ('basic', 'premium')),
  payplus_transaction_id TEXT NOT NULL,
  invoice_url TEXT,
  payment_method TEXT,
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- üí≥ Add proration tracking to payment_history
ALTER TABLE public.payment_history ADD COLUMN IF NOT EXISTS is_prorated BOOLEAN DEFAULT FALSE;
ALTER TABLE public.payment_history ADD COLUMN IF NOT EXISTS prorated_days INTEGER;
ALTER TABLE public.payment_history ADD COLUMN IF NOT EXISTS original_amount NUMERIC(10,2);
ALTER TABLE public.payment_history ADD COLUMN IF NOT EXISTS discount_amount NUMERIC(10,2) DEFAULT 0;
ALTER TABLE public.payment_history ADD COLUMN IF NOT EXISTS payment_type TEXT DEFAULT 'subscription';

-- Add constraint
ALTER TABLE public.payment_history DROP CONSTRAINT IF EXISTS payment_type_check;
ALTER TABLE public.payment_history ADD CONSTRAINT payment_type_check 
CHECK (payment_type IN ('subscription', 'upgrade', 'renewal', 'refund'));

COMMENT ON COLUMN public.payment_history.is_prorated IS 'TRUE if this payment was prorated (mid-cycle upgrade)';
COMMENT ON COLUMN public.payment_history.prorated_days IS 'Number of days remaining in billing cycle at time of upgrade';
COMMENT ON COLUMN public.payment_history.original_amount IS 'Original full price before proration discount';
COMMENT ON COLUMN public.payment_history.discount_amount IS 'Discount applied due to proration';
COMMENT ON COLUMN public.payment_history.payment_type IS 'Type: subscription (new), upgrade, renewal, refund';

-- Subscription Periods
CREATE TABLE IF NOT EXISTS public.subscription_periods (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  plan TEXT NOT NULL CHECK (plan IN ('free', 'basic', 'premium')),
  payplus_transaction_id TEXT,
  period_start TIMESTAMPTZ NOT NULL,
  period_end TIMESTAMPTZ NOT NULL,
  auto_renew BOOLEAN DEFAULT TRUE,
  canceled_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Free Months Credits
CREATE TABLE IF NOT EXISTS public.free_months_credits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  months_earned INTEGER NOT NULL,
  earned_from_user_id UUID REFERENCES auth.users(id),
  earned_at TIMESTAMPTZ DEFAULT NOW(),
  applied BOOLEAN DEFAULT FALSE,
  applied_at TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}'::jsonb
);

-- Admin Audit Log
CREATE TABLE IF NOT EXISTS public.admin_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  action TEXT NOT NULL,
  target_user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
  target_type TEXT,
  target_id UUID,
  details JSONB DEFAULT '{}'::jsonb,
  ip_address TEXT,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- User Activity Log
CREATE TABLE IF NOT EXISTS public.user_activity_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  action TEXT NOT NULL,
  details JSONB DEFAULT '{}'::jsonb,
  ip_address TEXT,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Referrals
CREATE TABLE IF NOT EXISTS public.referrals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  referrer_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  referred_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  referral_code TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'completed', 'expired', 'cancelled')),
  reward_granted_to_referrer BOOLEAN NOT NULL DEFAULT false,
  reward_granted_to_referred BOOLEAN NOT NULL DEFAULT false,
  reward_type TEXT NOT NULL DEFAULT 'free_month',
  reward_value NUMERIC NOT NULL DEFAULT 1,
  completed_at TIMESTAMPTZ NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'::jsonb,
  signed_up_at TIMESTAMPTZ DEFAULT NOW(),
  converted_to_paid BOOLEAN DEFAULT FALSE,
  converted_at TIMESTAMPTZ,
  subscription_type TEXT,
  reward_credited BOOLEAN DEFAULT FALSE,
  credited_at TIMESTAMPTZ,
  discount_applied BOOLEAN DEFAULT FALSE,
  CONSTRAINT referrals_no_self_referral CHECK (referrer_id != referred_id)
);

-- Affiliate Stats
CREATE TABLE IF NOT EXISTS public.affiliate_stats (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  total_signups INTEGER DEFAULT 0,
  total_conversions INTEGER DEFAULT 0,
  total_free_months_earned INTEGER DEFAULT 0,
  last_updated TIMESTAMPTZ DEFAULT NOW()
);

-- Broker Connections
CREATE TABLE IF NOT EXISTS public.broker_connections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  broker TEXT NOT NULL CHECK (broker IN (
    'interactive_brokers', 'td_ameritrade', 'alpaca', 'tradingview',
    'mt4', 'mt5', 'ninja_trader', 'manual'
  )),
  status TEXT NOT NULL DEFAULT 'disconnected' CHECK (status IN (
    'connected', 'disconnected', 'error', 'pending'
  )),
  account_id TEXT,
  account_name TEXT,
  connected_at TIMESTAMPTZ,
  last_sync_at TIMESTAMPTZ,
  error_message TEXT,
  access_token TEXT,
  refresh_token TEXT,
  expires_at TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, broker)
);

-- User Settings
CREATE TABLE IF NOT EXISTS public.user_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID UNIQUE NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  tradingview_webhook_secret TEXT,
  alpaca_api_key TEXT,
  alpaca_api_secret TEXT,
  preferences JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Admin Impersonation Sessions
CREATE TABLE IF NOT EXISTS public.admin_impersonation_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  impersonated_user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  session_token TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '2 hours'),
  last_activity_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  is_active BOOLEAN NOT NULL DEFAULT true,
  ip_address TEXT,
  user_agent TEXT,
  impersonated_user_email TEXT,
  impersonated_user_name TEXT,
  admin_email TEXT,
  CONSTRAINT valid_session CHECK (expires_at > created_at),
  CONSTRAINT different_users CHECK (admin_id != impersonated_user_id)
);

-- SnapTrade Activity
CREATE TABLE IF NOT EXISTS public.snaptrade_activity (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  last_activity_at TIMESTAMPTZ DEFAULT NOW(),
  connection_status TEXT DEFAULT 'disconnected' CHECK (connection_status IN ('connected', 'disconnected')),
  brokerage_connection_id TEXT,
  brokerage_name TEXT,
  connected_at TIMESTAMPTZ,
  disconnected_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id)
);

-- ‚ú® NEW: API Rate Limiting
CREATE TABLE IF NOT EXISTS public.api_rate_limits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  endpoint TEXT NOT NULL,
  requests_count INTEGER DEFAULT 1,
  window_start TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

COMMENT ON TABLE public.api_rate_limits IS 'Rate limiting tracking - auto-cleanup entries older than 1 hour';

-- üí≥ NEW: Subscription Changes (Audit Log)
CREATE TABLE IF NOT EXISTS public.subscription_changes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  change_type TEXT NOT NULL CHECK (change_type IN ('upgrade', 'downgrade', 'cancel', 'renew', 'expire', 'reactivate')),
  from_plan TEXT,
  to_plan TEXT,
  from_interval TEXT,
  to_interval TEXT,
  effective_date TIMESTAMPTZ NOT NULL,
  prorated_amount NUMERIC(10,2),
  prorated_days INTEGER,
  reason TEXT,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

COMMENT ON TABLE public.subscription_changes IS 'Audit log of all subscription changes for analytics and customer support';

-- üí≥ NEW: Pricing Configuration
CREATE TABLE IF NOT EXISTS public.pricing_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  plan TEXT NOT NULL,
  interval TEXT NOT NULL,
  price NUMERIC(10,2) NOT NULL,
  currency TEXT DEFAULT 'USD',
  features JSONB DEFAULT '{}'::jsonb,
  is_active BOOLEAN DEFAULT TRUE,
  valid_from TIMESTAMPTZ DEFAULT NOW(),
  valid_until TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(plan, interval, valid_from)
);

-- Insert current pricing
INSERT INTO public.pricing_config (plan, interval, price, features) VALUES
  ('basic', 'monthly', 15.99, '{"max_trades": 25, "support": "email"}'::jsonb),
  ('basic', 'yearly', 155.88, '{"max_trades": 25, "support": "email", "discount": "18%"}'::jsonb),
  ('premium', 'monthly', 24.99, '{"max_trades": "unlimited", "support": "priority", "advanced_analytics": true}'::jsonb),
  ('premium', 'yearly', 239.88, '{"max_trades": "unlimited", "support": "priority", "advanced_analytics": true, "discount": "20%"}'::jsonb)
ON CONFLICT DO NOTHING;

COMMENT ON TABLE public.pricing_config IS 'Flexible pricing configuration - allows price changes without code deployment';

-- üìä NEW v8.5.0: SnapTrade Users
CREATE TABLE IF NOT EXISTS public.snaptrade_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  snaptrade_user_id TEXT NOT NULL,
  snaptrade_user_secret TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  CONSTRAINT unique_user_id UNIQUE(user_id),
  CONSTRAINT unique_snaptrade_user_id UNIQUE(snaptrade_user_id)
);

-- üìä NEW v8.5.0: SnapTrade Sync Log
CREATE TABLE IF NOT EXISTS public.snaptrade_sync_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  sync_started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  sync_completed_at TIMESTAMPTZ,
  duration_seconds INT GENERATED ALWAYS AS (
    EXTRACT(EPOCH FROM (sync_completed_at - sync_started_at))::INT
  ) STORED,
  
  trades_imported INT DEFAULT 0,
  trades_skipped INT DEFAULT 0,
  trades_failed INT DEFAULT 0,
  
  sync_type TEXT DEFAULT 'manual',
  date_range_start DATE,
  date_range_end DATE,
  
  status TEXT NOT NULL DEFAULT 'running',
  error_message TEXT,
  error_details JSONB,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  CONSTRAINT check_sync_status CHECK (status IN ('running', 'completed', 'failed', 'cancelled')),
  CONSTRAINT check_sync_type CHECK (sync_type IN ('manual', 'automatic', 'scheduled')),
  CONSTRAINT check_completed_status CHECK (
    (status = 'running' AND sync_completed_at IS NULL) OR
    (status != 'running' AND sync_completed_at IS NOT NULL)
  )
);

-- Comments for SnapTrade tables
COMMENT ON TABLE public.snaptrade_users IS 'Stores SnapTrade API credentials for each Finotaur user';
COMMENT ON COLUMN public.snaptrade_users.snaptrade_user_id IS 'SnapTrade userId (e.g., finotaur_{uuid})';
COMMENT ON COLUMN public.snaptrade_users.snaptrade_user_secret IS 'SnapTrade userSecret (optional in Pay-as-you-go)';

COMMENT ON TABLE public.snaptrade_sync_log IS 'Tracks SnapTrade trade synchronization history and results';
COMMENT ON COLUMN public.snaptrade_sync_log.duration_seconds IS 'How long the sync took (computed column)';
COMMENT ON COLUMN public.snaptrade_sync_log.sync_type IS 'manual (user clicked button), automatic (scheduled), or scheduled (cron)';

-- ===============================================
-- SECTION 7: STORAGE BUCKET
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[7/10] Setting up storage bucket...';
END $$;

INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'trade-screenshots',
  'trade-screenshots',
  false,
  5242880,
  ARRAY['image/jpeg', 'image/png', 'image/webp']::text[]
)
ON CONFLICT (id) DO UPDATE SET
  file_size_limit = 5242880,
  allowed_mime_types = ARRAY['image/jpeg', 'image/png', 'image/webp']::text[];

-- ===============================================
-- SECTION 8: PRODUCTION-OPTIMIZED INDEXES
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[8/10] Creating production-grade indexes...';
  RAISE NOTICE '      Optimized for 5000+ concurrent users';
  RAISE NOTICE '      Including payment system indexes...';
  RAISE NOTICE '      üìä Including SnapTrade indexes...';
  RAISE NOTICE '      üéØ Including Ticker Symbols indexes...';
END $$;

-- Profiles indexes
CREATE INDEX IF NOT EXISTS idx_profiles_email ON public.profiles(email);
CREATE INDEX IF NOT EXISTS idx_profiles_role ON public.profiles(role);
CREATE INDEX IF NOT EXISTS idx_profiles_account_type ON public.profiles(account_type);
CREATE INDEX IF NOT EXISTS idx_profiles_subscription_status ON public.profiles(subscription_status);
CREATE INDEX IF NOT EXISTS idx_profiles_last_login ON public.profiles(last_login_at DESC);
CREATE INDEX IF NOT EXISTS idx_profiles_is_banned ON public.profiles(is_banned);
CREATE INDEX IF NOT EXISTS idx_profiles_created_recent ON public.profiles(created_at);
CREATE INDEX IF NOT EXISTS idx_profiles_total_pnl ON public.profiles(total_pnl) WHERE total_pnl IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_profiles_portfolio ON public.profiles(current_portfolio) WHERE current_portfolio IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_profiles_trade_limits ON public.profiles(account_type, current_month_trades_count, billing_cycle_start);

-- ‚ú® NEW: Soft delete index for profiles
CREATE INDEX IF NOT EXISTS idx_profiles_not_deleted 
ON public.profiles(id) WHERE deleted_at IS NULL;

-- ‚ú® NEW: Generated columns indexes
CREATE INDEX IF NOT EXISTS idx_profiles_portfolio_cached 
ON public.profiles(portfolio_size_cached) 
WHERE portfolio_size_cached IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_profiles_risk_cached 
ON public.profiles(risk_per_trade_cached) 
WHERE risk_per_trade_cached IS NOT NULL;

-- Strategies indexes
CREATE INDEX IF NOT EXISTS idx_strategies_user_id ON public.strategies(user_id);
CREATE INDEX IF NOT EXISTS idx_strategies_status ON public.strategies(status);

-- ‚ú® NEW: Soft delete index for strategies
CREATE INDEX IF NOT EXISTS idx_strategies_not_deleted 
ON public.strategies(user_id) WHERE deleted_at IS NULL;

-- üî• TRADES - ULTRA-OPTIMIZED COMPOSITE INDEXES
CREATE INDEX IF NOT EXISTS idx_trades_dashboard_ultimate 
ON public.trades(user_id, outcome, close_at DESC, id, symbol, pnl, rr, actual_r, open_at, stop_price, entry_price, exit_price, take_profit_price, quantity, risk_usd)
WHERE outcome IN ('WIN', 'LOSS', 'BE');

CREATE INDEX IF NOT EXISTS idx_trades_date_range_ultimate 
ON public.trades(user_id, close_at DESC, id, symbol, pnl, rr, actual_r, open_at, stop_price, entry_price, exit_price, take_profit_price, quantity, risk_usd)
WHERE outcome != 'OPEN';

CREATE INDEX IF NOT EXISTS idx_trades_user_open 
ON public.trades(user_id, open_at DESC, id, symbol, side, entry_price, stop_price, take_profit_price, quantity, risk_pts, reward_pts, rr, risk_usd, reward_usd)
WHERE outcome = 'OPEN';

CREATE INDEX IF NOT EXISTS idx_trades_user_symbol_date 
ON public.trades(user_id, symbol, close_at DESC)
WHERE outcome != 'OPEN';

CREATE INDEX IF NOT EXISTS idx_trades_user_strategy_outcome 
ON public.trades(user_id, strategy_id, outcome, close_at DESC)
WHERE strategy_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_user_r_analysis 
ON public.trades(user_id, actual_r, outcome, close_at)
WHERE actual_r IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_strategy_id ON public.trades(strategy_id);
CREATE INDEX IF NOT EXISTS idx_trades_broker ON public.trades(broker);
CREATE INDEX IF NOT EXISTS idx_trades_multiplier ON public.trades(multiplier);

CREATE UNIQUE INDEX IF NOT EXISTS idx_trades_external_id_not_null 
ON public.trades(user_id, broker, external_id) 
WHERE external_id IS NOT NULL;

-- ‚ú® NEW: Soft delete index for trades
CREATE INDEX IF NOT EXISTS idx_trades_not_deleted 
ON public.trades(user_id, id) WHERE deleted_at IS NULL;

-- üìä NEW v8.5.0: SnapTrade indexes on trades
CREATE UNIQUE INDEX IF NOT EXISTS idx_trades_snaptrade_activity_id 
ON public.trades(snaptrade_activity_id) 
WHERE snaptrade_activity_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_snaptrade_account_id 
ON public.trades(snaptrade_account_id)
WHERE snaptrade_account_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_import_source 
ON public.trades(import_source);

CREATE INDEX IF NOT EXISTS idx_trades_imported_at 
ON public.trades(imported_at DESC)
WHERE imported_at IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_user_import_source 
ON public.trades(user_id, import_source, imported_at DESC);

-- Notes & Screenshots indexes
CREATE INDEX IF NOT EXISTS idx_trades_notes_search 
ON public.trades USING GIN(notes_search_vector);

CREATE INDEX IF NOT EXISTS idx_trades_notes_not_null 
ON public.trades(user_id, id) 
WHERE notes IS NOT NULL AND notes != '';

CREATE INDEX IF NOT EXISTS idx_trades_screenshot_not_null 
ON public.trades(user_id, id) 
WHERE screenshot_url IS NOT NULL AND screenshot_url != '';

-- TradingView webhook indexes
CREATE INDEX IF NOT EXISTS idx_user_settings_webhook_lookup 
ON public.user_settings(user_id) 
INCLUDE (tradingview_webhook_secret)
WHERE tradingview_webhook_secret IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_webhook_lookup 
ON public.trades(user_id, symbol, side, open_at DESC) 
WHERE close_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_trades_close_lookup 
ON public.trades(user_id, symbol, side, close_at, open_at DESC)
WHERE close_at IS NULL AND broker = 'tradingview';

-- Portfolio performance indexes
CREATE INDEX IF NOT EXISTS idx_trades_user_exit_pnl 
ON public.trades(user_id, exit_price) 
WHERE exit_price IS NOT NULL;

-- Payment & Subscriptions indexes
CREATE INDEX IF NOT EXISTS idx_payment_history_user_id ON public.payment_history(user_id);
CREATE INDEX IF NOT EXISTS idx_payment_history_status ON public.payment_history(status);
CREATE INDEX IF NOT EXISTS idx_subscription_periods_user_id ON public.subscription_periods(user_id);
CREATE INDEX IF NOT EXISTS idx_subscription_periods_active ON public.subscription_periods(user_id, period_end);

-- üí≥ NEW: Payment system indexes
CREATE INDEX IF NOT EXISTS idx_payment_history_type 
ON public.payment_history(payment_type, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_payment_history_prorated 
ON public.payment_history(is_prorated, created_at DESC) 
WHERE is_prorated = TRUE;

CREATE INDEX IF NOT EXISTS idx_subscription_changes_user_id 
ON public.subscription_changes(user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_subscription_changes_type 
ON public.subscription_changes(change_type, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_pricing_config_active 
ON public.pricing_config(plan, interval) WHERE is_active = TRUE;

-- Admin & Activity indexes
CREATE INDEX IF NOT EXISTS idx_admin_audit_admin_id ON public.admin_audit_log(admin_id);
CREATE INDEX IF NOT EXISTS idx_admin_audit_created_at ON public.admin_audit_log(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_user_activity_user_id ON public.user_activity_log(user_id);
CREATE INDEX IF NOT EXISTS idx_user_activity_created_at ON public.user_activity_log(created_at DESC);

-- Referrals & Affiliates indexes
CREATE INDEX IF NOT EXISTS idx_referrals_referrer_id ON public.referrals(referrer_id);
CREATE INDEX IF NOT EXISTS idx_referrals_referred_id ON public.referrals(referred_id);
CREATE INDEX IF NOT EXISTS idx_referrals_status ON public.referrals(status);
CREATE INDEX IF NOT EXISTS idx_referrals_referrer_converted ON public.referrals(referrer_id, converted_to_paid);
CREATE INDEX IF NOT EXISTS idx_profiles_affiliate_code_idx ON public.profiles(affiliate_code) WHERE affiliate_code IS NOT NULL;

-- Broker & Settings indexes
CREATE INDEX IF NOT EXISTS idx_broker_connections_user_id ON public.broker_connections(user_id);
CREATE INDEX IF NOT EXISTS idx_broker_connections_status ON public.broker_connections(status);
CREATE INDEX IF NOT EXISTS idx_user_settings_user_id ON public.user_settings(user_id);

-- Impersonation indexes
CREATE INDEX IF NOT EXISTS idx_impersonation_admin_id ON public.admin_impersonation_sessions(admin_id);
CREATE INDEX IF NOT EXISTS idx_impersonation_token ON public.admin_impersonation_sessions(session_token);
CREATE INDEX IF NOT EXISTS idx_impersonation_active ON public.admin_impersonation_sessions(is_active) WHERE is_active = true;

-- SnapTrade indexes
CREATE INDEX IF NOT EXISTS idx_snaptrade_activity_user_id ON public.snaptrade_activity(user_id);
CREATE INDEX IF NOT EXISTS idx_snaptrade_activity_status ON public.snaptrade_activity(connection_status);

-- üìä NEW v8.5.0: SnapTrade tables indexes
CREATE INDEX IF NOT EXISTS idx_snaptrade_users_user_id ON public.snaptrade_users(user_id);
CREATE INDEX IF NOT EXISTS idx_snaptrade_users_snaptrade_user_id ON public.snaptrade_users(snaptrade_user_id);
CREATE INDEX IF NOT EXISTS idx_snaptrade_users_created_at ON public.snaptrade_users(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_user_id ON public.snaptrade_sync_log(user_id);
CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_status ON public.snaptrade_sync_log(status);
CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_created_at ON public.snaptrade_sync_log(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_completed_at ON public.snaptrade_sync_log(sync_completed_at DESC)
WHERE sync_completed_at IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_user_status ON public.snaptrade_sync_log(user_id, status, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_user_sync_type ON public.snaptrade_sync_log(user_id, sync_type, created_at DESC);

-- ‚ú® NEW: Rate limiting indexes
CREATE INDEX IF NOT EXISTS idx_rate_limits_window 
ON public.api_rate_limits(user_id, endpoint, window_start);

-- Cleanup index without NOW() in predicate
CREATE INDEX IF NOT EXISTS idx_rate_limits_cleanup
ON public.api_rate_limits(window_start);

-- ‚ú® NEW: Rate limiting indexes
CREATE INDEX IF NOT EXISTS idx_rate_limits_window 
ON public.api_rate_limits(user_id, endpoint, window_start);

-- Cleanup index without NOW() in predicate
CREATE INDEX IF NOT EXISTS idx_rate_limits_cleanup
ON public.api_rate_limits(window_start);

-- Analyze tables
ANALYZE public.profiles;
ANALYZE public.trades;
ANALYZE public.strategies;
ANALYZE public.broker_connections;
ANALYZE public.snaptrade_activity;
ANALYZE public.api_rate_limits;
ANALYZE public.payment_history;
ANALYZE public.subscription_changes;
ANALYZE public.pricing_config;
ANALYZE public.snaptrade_users;
ANALYZE public.snaptrade_sync_log;
ANALYZE public.ticker_symbols;

-- ===============================================
-- SECTION 9: ENABLE RLS
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[9/10] Enabling RLS...';
  RAISE NOTICE '      üìä Including SnapTrade tables...';
  RAISE NOTICE '      üéØ Including Ticker Symbols...';
END $$;

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.strategies ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.trades ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.payment_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.subscription_periods ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.free_months_credits ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admin_audit_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_activity_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.referrals ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.affiliate_stats ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.broker_connections ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admin_impersonation_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.snaptrade_activity ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.api_rate_limits ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.subscription_changes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.pricing_config ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.snaptrade_users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.snaptrade_sync_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ticker_symbols ENABLE ROW LEVEL SECURITY;

-- ===============================================
-- SECTION 10: SAFE RLS POLICIES (HOTFIX v8.4.9 - NO RECURSION!)
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[10/10] Creating SAFE RLS policies (NO RECURSION!)...';
  RAISE NOTICE '      ‚úÖ Simple policies - no subqueries';
  RAISE NOTICE '      ‚úÖ Admin access via SECURITY DEFINER functions';
  RAISE NOTICE '      üí≥ Payment system policies included';
  RAISE NOTICE '      üìä SnapTrade policies included';
  RAISE NOTICE '      üéØ Ticker Symbols policies included';
END $$;

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- PROFILES - 4 SIMPLE POLICIES (NO RECURSION!)
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- SELECT: Everyone sees own, NO admin check here!
CREATE POLICY "profiles_select_own"
ON public.profiles
FOR SELECT
TO authenticated
USING (id = auth.uid());

COMMENT ON POLICY "profiles_select_own" ON public.profiles IS 
'v8.5.1: Users see ONLY own profile. Admin access via SECURITY DEFINER functions.';

-- INSERT: Only during signup
CREATE POLICY "profiles_insert_own"
ON public.profiles
FOR INSERT
TO authenticated
WITH CHECK (
  id = auth.uid()
  AND account_type = 'free'
);

COMMENT ON POLICY "profiles_insert_own" ON public.profiles IS 
'v8.5.1: Users can create own profile during registration (FREE only).';

-- UPDATE: Users can update own (with restrictions)
CREATE POLICY "profiles_update_own"
ON public.profiles
FOR UPDATE
TO authenticated
USING (id = auth.uid())
WITH CHECK (id = auth.uid());

COMMENT ON POLICY "profiles_update_own" ON public.profiles IS 
'v8.5.1: Users update own profile. Restrictions enforced at application layer.';

-- DELETE: Forbidden (use soft delete)
CREATE POLICY "profiles_delete_never"
ON public.profiles
FOR DELETE
TO authenticated
USING (false);

COMMENT ON POLICY "profiles_delete_never" ON public.profiles IS 
'v8.5.1: Direct deletion forbidden - use soft delete (deleted_at) instead.';

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- TRADES - 4 SIMPLE POLICIES
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

CREATE POLICY "trades_select_own"
ON public.trades
FOR SELECT
TO authenticated
USING (user_id = auth.uid());

COMMENT ON POLICY "trades_select_own" ON public.trades IS 
'v8.5.1: Users see only own trades. Admin via functions.';

CREATE POLICY "trades_insert_own"
ON public.trades
FOR INSERT
TO authenticated
WITH CHECK (
  user_id = auth.uid()
);

COMMENT ON POLICY "trades_insert_own" ON public.trades IS 
'v8.5.1: Users create own trades. Limits checked via can_create_trade().';

CREATE POLICY "trades_update_own"
ON public.trades
FOR UPDATE
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

COMMENT ON POLICY "trades_update_own" ON public.trades IS 
'v8.5.1: Users update only own trades.';

CREATE POLICY "trades_delete_own"
ON public.trades
FOR DELETE
TO authenticated
USING (user_id = auth.uid());

COMMENT ON POLICY "trades_delete_own" ON public.trades IS 
'v8.5.1: Users delete only own trades (or use soft delete).';

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- STRATEGIES - 4 SIMPLE POLICIES
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

CREATE POLICY "strategies_select_own"
ON public.strategies
FOR SELECT
TO authenticated
USING (user_id = auth.uid());

CREATE POLICY "strategies_insert_own"
ON public.strategies
FOR INSERT
TO authenticated
WITH CHECK (user_id = auth.uid());

CREATE POLICY "strategies_update_own"
ON public.strategies
FOR UPDATE
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

CREATE POLICY "strategies_delete_own"
ON public.strategies
FOR DELETE
TO authenticated
USING (user_id = auth.uid());

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- OTHER TABLES - SIMPLE POLICIES
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- Payment History
CREATE POLICY "payment_own" ON public.payment_history 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

-- Subscription Periods
CREATE POLICY "subscription_own" ON public.subscription_periods 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

-- Admin Audit Log (read-only for admins - checked in function)
CREATE POLICY "audit_read_only" ON public.admin_audit_log 
FOR SELECT TO authenticated
USING (false);  -- Access via SECURITY DEFINER functions only

-- Referrals
CREATE POLICY "referrals_own" ON public.referrals 
FOR SELECT TO authenticated
USING (auth.uid() IN (referrer_id, referred_id));

-- Free Months Credits
CREATE POLICY "free_months_own" ON public.free_months_credits 
FOR SELECT TO authenticated
USING (user_id = auth.uid());

-- User Activity Log
CREATE POLICY "activity_own" ON public.user_activity_log 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

-- Affiliate Stats
CREATE POLICY "affiliate_own" ON public.affiliate_stats 
FOR SELECT TO authenticated
USING (user_id = auth.uid());

-- Broker Connections
CREATE POLICY "broker_own" ON public.broker_connections 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

-- User Settings
CREATE POLICY "settings_own" ON public.user_settings 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

-- Admin Impersonation Sessions
CREATE POLICY "impersonation_own" ON public.admin_impersonation_sessions 
FOR SELECT TO authenticated
USING (admin_id = auth.uid());

-- SnapTrade Activity
CREATE POLICY "snaptrade_own" ON public.snaptrade_activity 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

-- Rate Limits
CREATE POLICY "rate_limits_own" ON public.api_rate_limits
FOR ALL TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

-- üí≥ Subscription Changes
CREATE POLICY "Users can view own subscription changes"
ON public.subscription_changes FOR SELECT
TO authenticated
USING (user_id = auth.uid());

-- üí≥ Pricing Config (public read)
CREATE POLICY "Everyone can view active pricing"
ON public.pricing_config FOR SELECT
TO authenticated
USING (is_active = TRUE);

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- üìä SNAPTRADE TABLES - SIMPLE POLICIES
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- SnapTrade Users
CREATE POLICY "snaptrade_users_select_own"
ON public.snaptrade_users
FOR SELECT
TO authenticated
USING (user_id = auth.uid());

CREATE POLICY "snaptrade_users_insert_own"
ON public.snaptrade_users
FOR INSERT
TO authenticated
WITH CHECK (user_id = auth.uid());

CREATE POLICY "snaptrade_users_update_own"
ON public.snaptrade_users
FOR UPDATE
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

CREATE POLICY "snaptrade_users_delete_own"
ON public.snaptrade_users
FOR DELETE
TO authenticated
USING (user_id = auth.uid());

COMMENT ON POLICY "snaptrade_users_select_own" ON public.snaptrade_users IS 
'v8.5.1: Users can only view their own SnapTrade credentials';

-- SnapTrade Sync Log
CREATE POLICY "snaptrade_sync_log_select_own"
ON public.snaptrade_sync_log
FOR SELECT
TO authenticated
USING (user_id = auth.uid());

CREATE POLICY "snaptrade_sync_log_insert_own"
ON public.snaptrade_sync_log
FOR INSERT
TO authenticated
WITH CHECK (user_id = auth.uid());

CREATE POLICY "snaptrade_sync_log_update_own"
ON public.snaptrade_sync_log
FOR UPDATE
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

COMMENT ON POLICY "snaptrade_sync_log_select_own" ON public.snaptrade_sync_log IS 
'v8.5.1: Users can only view their own SnapTrade sync logs';

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- üéØ TICKER SYMBOLS - PUBLIC READ ACCESS
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- All authenticated users can read ticker symbols
CREATE POLICY "ticker_symbols_public_read"
ON public.ticker_symbols
FOR SELECT
TO authenticated
USING (is_active = TRUE);

COMMENT ON POLICY "ticker_symbols_public_read" ON public.ticker_symbols IS 
'v8.5.1: All authenticated users can read active ticker symbols for autocomplete';

-- Anonymous users can also read (for landing pages)
CREATE POLICY "ticker_symbols_anon_read"
ON public.ticker_symbols
FOR SELECT
TO anon
USING (is_active = TRUE);

-- Only admins can modify (via SECURITY DEFINER functions)
CREATE POLICY "ticker_symbols_admin_only"
ON public.ticker_symbols
FOR ALL
TO authenticated
USING (false)
WITH CHECK (false);

COMMENT ON POLICY "ticker_symbols_admin_only" ON public.ticker_symbols IS 
'v8.5.1: Only admins can modify ticker symbols via SECURITY DEFINER functions';

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- STORAGE POLICIES
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

CREATE POLICY "Users can upload trade screenshots" ON storage.objects 
FOR INSERT TO authenticated
WITH CHECK (
  bucket_id = 'trade-screenshots' 
  AND (storage.foldername(name))[1] = auth.uid()::text
);

CREATE POLICY "Users can view own trade screenshots" ON storage.objects 
FOR SELECT TO authenticated
USING (
  bucket_id = 'trade-screenshots' 
  AND (storage.foldername(name))[1] = auth.uid()::text
);

CREATE POLICY "Users can update own trade screenshots" ON storage.objects 
FOR UPDATE TO authenticated
USING (
  bucket_id = 'trade-screenshots' 
  AND (storage.foldername(name))[1] = auth.uid()::text
)
WITH CHECK (
  bucket_id = 'trade-screenshots' 
  AND (storage.foldername(name))[1] = auth.uid()::text
);

CREATE POLICY "Users can delete own trade screenshots" ON storage.objects 
FOR DELETE TO authenticated
USING (
  bucket_id = 'trade-screenshots' 
  AND (storage.foldername(name))[1] = auth.uid()::text
);

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- GRANT PERMISSIONS
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

GRANT SELECT ON public.subscription_changes TO authenticated;
GRANT SELECT ON public.pricing_config TO authenticated;
GRANT SELECT, INSERT, UPDATE, DELETE ON public.snaptrade_users TO authenticated;
GRANT SELECT, INSERT, UPDATE ON public.snaptrade_sync_log TO authenticated;
GRANT SELECT ON public.ticker_symbols TO authenticated;
GRANT SELECT ON public.ticker_symbols TO anon;

-- Grant to service role (for Edge Functions)
GRANT ALL ON public.snaptrade_users TO service_role;
GRANT ALL ON public.snaptrade_sync_log TO service_role;
GRANT ALL ON public.ticker_symbols TO service_role;

COMMIT;

-- ===============================================
-- END OF PART 1/4 - v8.5.1-PRODUCTION-FINAL
-- ===============================================

DO $$
DECLARE 
  trade_policies_count INTEGER;
  profiles_policies_count INTEGER;
  ticker_symbols_count INTEGER;
  ticker_policies_count INTEGER;
  payment_provider_exists BOOLEAN;
  risk_columns_exist INTEGER;
  risk_mode_exists BOOLEAN;
  payment_enhancements_exist INTEGER;
  snaptrade_columns_exist INTEGER;
  snaptrade_users_exists BOOLEAN;
  snaptrade_sync_log_exists BOOLEAN;
  snaptrade_indexes_count INTEGER;
  snaptrade_policies_count INTEGER;
  ticker_table_exists BOOLEAN;
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó';
  RAISE NOTICE '‚ïë  ‚úÖ PART 1/4 COMPLETE! (v8.5.1)       ‚ïë';
  RAISE NOTICE '‚ïë     Tables + Indexes + RLS            ‚ïë';
  RAISE NOTICE '‚ïë     ‚ú® PRODUCTION FINAL - WORKING!    ‚ïë';
  RAISE NOTICE '‚ïë     üî• NO RECURSION IN RLS!           ‚ïë';
  RAISE NOTICE '‚ïë     üîí PAYMENT PROVIDER INCLUDED!     ‚ïë';
  RAISE NOTICE '‚ïë     üÜï RISK COLUMNS FIXED!            ‚ïë';
  RAISE NOTICE '‚ïë     üí≥ PAYMENT ENHANCEMENTS ADDED!    ‚ïë';
  RAISE NOTICE '‚ïë     üìä SNAPTRADE INTEGRATION ADDED!   ‚ïë';
  RAISE NOTICE '‚ïë     üéØ TICKER SYMBOLS MASTER TABLE!   ‚ïë';
  RAISE NOTICE '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù';
  RAISE NOTICE '';
  
  -- Count policies
  SELECT COUNT(*) INTO trade_policies_count
  FROM pg_policies
  WHERE schemaname = 'public' AND tablename = 'trades';
  
  SELECT COUNT(*) INTO profiles_policies_count
  FROM pg_policies
  WHERE schemaname = 'public' AND tablename = 'profiles';
  
  SELECT COUNT(*) INTO ticker_policies_count
  FROM pg_policies
  WHERE schemaname = 'public' AND tablename = 'ticker_symbols';
  
  -- Check ticker_symbols table
  SELECT EXISTS(SELECT 1 FROM pg_tables WHERE tablename = 'ticker_symbols') INTO ticker_table_exists;
  
  -- Count ticker symbols
  SELECT COUNT(*) INTO ticker_symbols_count FROM public.ticker_symbols;
  
  -- Check payment_provider column
  SELECT EXISTS (
    SELECT 1 
    FROM information_schema.columns 
    WHERE table_schema = 'public' 
      AND table_name = 'profiles' 
      AND column_name = 'payment_provider'
  ) INTO payment_provider_exists;
  
  -- Check risk_mode column (correct name)
  SELECT EXISTS (
    SELECT 1 
    FROM information_schema.columns 
    WHERE table_schema = 'public' 
      AND table_name = 'profiles' 
      AND column_name = 'risk_mode'
  ) INTO risk_mode_exists;
  
  -- Check all risk columns
  SELECT COUNT(*) INTO risk_columns_exist
  FROM information_schema.columns
  WHERE table_schema = 'public' 
    AND table_name = 'profiles'
    AND column_name IN ('portfolio_size', 'risk_percentage', 'risk_mode', 'fixed_risk_amount');
  
  -- Check payment enhancement columns
  SELECT COUNT(*) INTO payment_enhancements_exist
  FROM information_schema.columns
  WHERE table_schema = 'public' 
    AND table_name = 'profiles'
    AND column_name IN ('cancellation_reason', 'cancellation_requested_at', 'cancellation_effective_date', 
                        'previous_account_type', 'upgrade_date', 'prorated_credit');
  
  -- Check SnapTrade columns in trades
  SELECT COUNT(*) INTO snaptrade_columns_exist
  FROM information_schema.columns
  WHERE table_name = 'trades' 
  AND column_name IN ('snaptrade_activity_id', 'snaptrade_account_id', 'import_source', 'imported_at');
  
  -- Check SnapTrade tables
  SELECT EXISTS(SELECT 1 FROM pg_tables WHERE tablename = 'snaptrade_users') INTO snaptrade_users_exists;
  SELECT EXISTS(SELECT 1 FROM pg_tables WHERE tablename = 'snaptrade_sync_log') INTO snaptrade_sync_log_exists;
  
  -- Check SnapTrade indexes
  SELECT COUNT(*) INTO snaptrade_indexes_count
  FROM pg_indexes 
  WHERE tablename IN ('trades', 'snaptrade_users', 'snaptrade_sync_log')
  AND indexname LIKE '%snaptrade%';
  
  -- Check SnapTrade policies
  SELECT COUNT(*) INTO snaptrade_policies_count
  FROM pg_policies 
  WHERE tablename IN ('snaptrade_users', 'snaptrade_sync_log');
  
  RAISE NOTICE 'üìä RLS Policies Status:';
  RAISE NOTICE '   ‚Ä¢ Profiles policies: % (expected: 4)', profiles_policies_count;
  RAISE NOTICE '   ‚Ä¢ Trades policies: % (expected: 4)', trade_policies_count;
  RAISE NOTICE '   ‚Ä¢ Ticker symbols policies: % (expected: 3)', ticker_policies_count;
  
  IF profiles_policies_count = 4 AND trade_policies_count = 4 AND ticker_policies_count = 3 THEN
    RAISE NOTICE '   ‚úÖ All policies created - NO RECURSION!';
    RAISE NOTICE '      - Simple USING/WITH CHECK conditions';
    RAISE NOTICE '      - No subqueries to profiles table';
    RAISE NOTICE '      - Admin access via SECURITY DEFINER functions';
  ELSE
    RAISE WARNING '   ‚ö†Ô∏è  Expected profiles:4 trades:4 tickers:3, found profiles:% trades:% tickers:%', 
      profiles_policies_count, trade_policies_count, ticker_policies_count;
  END IF;
  
  RAISE NOTICE '';
  RAISE NOTICE 'üéØ Ticker Symbols Master Table:';
  RAISE NOTICE '   ‚Ä¢ Table exists: %', CASE WHEN ticker_table_exists THEN '‚úÖ YES' ELSE '‚ùå NO' END;
  RAISE NOTICE '   ‚Ä¢ Total tickers loaded: %', ticker_symbols_count;
  RAISE NOTICE '   ‚Ä¢ RLS policies: %', ticker_policies_count;
  
  IF ticker_symbols_count >= 400 THEN
    RAISE NOTICE '   ‚úÖ Comprehensive ticker database loaded!';
    RAISE NOTICE '      ‚úì US Stocks (Top 100)';
    RAISE NOTICE '      ‚úì Futures (CME, NYMEX, CBOT, ICE)';
    RAISE NOTICE '      ‚úì Cryptocurrency (Top 25)';
    RAISE NOTICE '      ‚úì Forex Pairs (Major & Cross)';
    RAISE NOTICE '      ‚úì Leveraged ETFs (3x, 2x)';
    RAISE NOTICE '      ‚úì Regular ETFs (SPY, QQQ, etc.)';
    RAISE NOTICE '      ‚úì Accurate multipliers for all assets';
  ELSE
    RAISE WARNING '   ‚ö†Ô∏è  Expected 400+ tickers, found %', ticker_symbols_count;
  END IF;
  
  RAISE NOTICE '';
  RAISE NOTICE 'üîí Payment Provider Status:';
  RAISE NOTICE '   ‚Ä¢ Column exists: %', CASE WHEN payment_provider_exists THEN '‚úÖ YES' ELSE '‚ùå NO' END;
  RAISE NOTICE '   ‚Ä¢ Allowed values: payplus, stripe, paypal, NULL';
  
  RAISE NOTICE '';
  RAISE NOTICE 'üÜï Risk Calculation Columns Status:';
  RAISE NOTICE '   ‚Ä¢ Columns found: % / 4', risk_columns_exist;
  RAISE NOTICE '   ‚Ä¢ risk_mode exists: %', CASE WHEN risk_mode_exists THEN '‚úÖ YES' ELSE '‚ùå NO' END;
  
  IF risk_columns_exist = 4 AND risk_mode_exists THEN
    RAISE NOTICE '   ‚úÖ All 4 risk columns created successfully!';
    RAISE NOTICE '      ‚úì portfolio_size (DECIMAL 15,2, default 10000)';
    RAISE NOTICE '      ‚úì risk_percentage (DECIMAL 5,2, default 1.0)';
    RAISE NOTICE '      ‚úì risk_mode (VARCHAR 20, default ''percentage'')';
    RAISE NOTICE '      ‚úì fixed_risk_amount (DECIMAL 15,2, nullable)';
  ELSE
    RAISE WARNING '   ‚ö†Ô∏è  Expected 4 columns, found %', risk_columns_exist;
  END IF;
  
  RAISE NOTICE '';
  RAISE NOTICE 'üí≥ Payment System Enhancements:';
  RAISE NOTICE '   ‚Ä¢ Cancellation/Upgrade columns: % / 6', payment_enhancements_exist;
  
  IF payment_enhancements_exist = 6 THEN
    RAISE NOTICE '   ‚úÖ All payment enhancement columns created!';
    RAISE NOTICE '      ‚úì Cancellation tracking';
    RAISE NOTICE '      ‚úì Upgrade/downgrade history';
    RAISE NOTICE '      ‚úì Proration support';
  ELSE
    RAISE WARNING '   ‚ö†Ô∏è  Expected 6 columns, found %', payment_enhancements_exist;
  END IF;
  
  RAISE NOTICE '';
  RAISE NOTICE 'üìä SnapTrade Integration Status:';
  RAISE NOTICE '   ‚îú‚îÄ Trades columns added: % / 4', snaptrade_columns_exist;
  RAISE NOTICE '   ‚îú‚îÄ snaptrade_users table: %', CASE WHEN snaptrade_users_exists THEN '‚úÖ EXISTS' ELSE '‚ùå MISSING' END;
  RAISE NOTICE '   ‚îú‚îÄ snaptrade_sync_log table: %', CASE WHEN snaptrade_sync_log_exists THEN '‚úÖ EXISTS' ELSE '‚ùå MISSING' END;
  RAISE NOTICE '   ‚îú‚îÄ SnapTrade indexes: %', snaptrade_indexes_count;
  RAISE NOTICE '   ‚îî‚îÄ RLS policies: %', snaptrade_policies_count;
  
  RAISE NOTICE '';
  RAISE NOTICE 'üìä Database Status:';
  RAISE NOTICE '   ‚Ä¢ Tables: 20 (including ticker_symbols)';
  RAISE NOTICE '   ‚Ä¢ Indexes: 95+';
  RAISE NOTICE '   ‚Ä¢ RLS Enabled: ‚úÖ';
  RAISE NOTICE '   ‚Ä¢ Storage Bucket: ‚úÖ';
  RAISE NOTICE '';
  RAISE NOTICE 'üîß Critical Features:';
  RAISE NOTICE '   ‚úÖ profiles_insert_own - Registration works';
  RAISE NOTICE '   ‚úÖ trades_insert_own - Trade creation works';
  RAISE NOTICE '   ‚úÖ NO RECURSION in policies (HOTFIX v8.4.9)';
  RAISE NOTICE '   ‚úÖ Admin access via SECURITY DEFINER functions';
  RAISE NOTICE '   ‚úÖ Soft delete support';
  RAISE NOTICE '   ‚úÖ Rate limiting';
  RAISE NOTICE '   ‚úÖ Generated columns';
  RAISE NOTICE '   ‚úÖ Payment provider tracking';
  RAISE NOTICE '   ‚úÖ Risk calculation columns';
  RAISE NOTICE '   ‚úÖ Subscription management enhancements';
  RAISE NOTICE '   ‚úÖ Proration tracking';
  RAISE NOTICE '   ‚úÖ Flexible pricing configuration';
  RAISE NOTICE '   ‚úÖ SnapTrade broker integration';
  RAISE NOTICE '   ‚úÖ Trade import deduplication';
  RAISE NOTICE '   ‚úÖ Sync logging and tracking';
  RAISE NOTICE '   ‚úÖ üéØ Ticker Symbols Master Table';
  RAISE NOTICE '   ‚úÖ üöÄ Fast autocomplete with multipliers';
  RAISE NOTICE '';
  RAISE NOTICE '‚è≠Ô∏è  Next Steps:';
  RAISE NOTICE '   1. Run Part 2/4 (Functions 1-6)';
  RAISE NOTICE '   2. Run Part 3/4 (Functions 7-14)';
  RAISE NOTICE '   3. Run Part 4/4 (Views + Data + Security)';
  RAISE NOTICE '';
END $$;