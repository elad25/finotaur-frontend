-- =============================================
-- NEWSLETTER COMPLETE SETUP - UNIFIED V3 (FIXED)
-- Includes: RPC Functions + Token Generation + Paid Subscribers
-- =============================================

-- ============================================
-- PART 1: DROP OLD FUNCTIONS
-- ============================================
DROP FUNCTION IF EXISTS get_newsletter_users();
DROP FUNCTION IF EXISTS get_newsletter_stats();
DROP FUNCTION IF EXISTS toggle_newsletter_status(UUID, BOOLEAN);

-- ============================================
-- PART 2: AUTO-GENERATE UNSUBSCRIBE TOKEN
-- ============================================

-- Function to generate unique token
CREATE OR REPLACE FUNCTION generate_newsletter_token()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.newsletter_unsubscribe_token IS NULL THEN
    NEW.newsletter_unsubscribe_token := encode(gen_random_bytes(32), 'hex');
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger on INSERT
DROP TRIGGER IF EXISTS set_newsletter_token_on_insert ON profiles;
CREATE TRIGGER set_newsletter_token_on_insert
  BEFORE INSERT ON profiles
  FOR EACH ROW
  EXECUTE FUNCTION generate_newsletter_token();

-- Fill existing NULL tokens
UPDATE profiles 
SET newsletter_unsubscribe_token = encode(gen_random_bytes(32), 'hex')
WHERE newsletter_unsubscribe_token IS NULL;

-- ============================================
-- PART 3: ADD PAID NEWSLETTER COLUMNS
-- ============================================

DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'profiles' AND column_name = 'newsletter_paid'
  ) THEN
    ALTER TABLE profiles ADD COLUMN newsletter_paid BOOLEAN DEFAULT false;
  END IF;
  
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'profiles' AND column_name = 'newsletter_paid_at'
  ) THEN
    ALTER TABLE profiles ADD COLUMN newsletter_paid_at TIMESTAMPTZ;
  END IF;
  
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'profiles' AND column_name = 'whop_newsletter_membership_id'
  ) THEN
    ALTER TABLE profiles ADD COLUMN whop_newsletter_membership_id TEXT;
  END IF;
END $$;

-- Index for faster queries
CREATE INDEX IF NOT EXISTS idx_profiles_newsletter_paid 
ON profiles(newsletter_paid) WHERE newsletter_paid = true;

-- ============================================
-- PART 4: RPC FUNCTIONS
-- ============================================

-- Function: Get all users for newsletter management
CREATE OR REPLACE FUNCTION get_newsletter_users()
RETURNS TABLE (
  id UUID,
  email TEXT,
  display_name TEXT,
  account_type TEXT,
  newsletter_enabled BOOLEAN,
  newsletter_paid BOOLEAN,
  created_at TIMESTAMPTZ
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  -- Check if caller is admin
  IF NOT EXISTS (
    SELECT 1 FROM profiles 
    WHERE profiles.id = auth.uid() 
    AND profiles.role IN ('admin', 'super_admin')
  ) THEN
    RAISE EXCEPTION 'Access denied: Admin only';
  END IF;

  RETURN QUERY
  SELECT 
    p.id,
    p.email,
    p.display_name,
    p.account_type,
    COALESCE(p.newsletter_enabled, true)::BOOLEAN as newsletter_enabled,
    COALESCE(p.newsletter_paid, false)::BOOLEAN as newsletter_paid,
    p.created_at
  FROM profiles p
  WHERE p.email IS NOT NULL
    AND p.deleted_at IS NULL
  ORDER BY 
    CASE p.account_type 
      WHEN 'premium' THEN 1 
      WHEN 'basic' THEN 2 
      ELSE 3 
    END,
    p.created_at DESC;
END;
$$;

-- Function: Get newsletter stats (UPDATED for paid subscribers)
CREATE OR REPLACE FUNCTION get_newsletter_stats()
RETURNS TABLE (
  premium_users BIGINT,
  paid_subscribers BIGINT,
  enabled_users BIGINT,
  total_users BIGINT
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  -- Check if caller is admin
  IF NOT EXISTS (
    SELECT 1 FROM profiles 
    WHERE profiles.id = auth.uid() 
    AND profiles.role IN ('admin', 'super_admin')
  ) THEN
    RAISE EXCEPTION 'Access denied: Admin only';
  END IF;

  RETURN QUERY
  SELECT 
    -- Premium users count
    (SELECT COUNT(*) FROM profiles 
     WHERE account_type = 'premium' 
     AND email IS NOT NULL 
     AND deleted_at IS NULL)::BIGINT,
    
    -- PAID newsletter subscribers (via Whop) - NOT premium+basic!
    (SELECT COUNT(*) FROM profiles 
     WHERE newsletter_paid = true
     AND COALESCE(newsletter_enabled, true) = true
     AND email IS NOT NULL 
     AND deleted_at IS NULL)::BIGINT,
    
    -- All enabled for newsletter
    (SELECT COUNT(*) FROM profiles 
     WHERE COALESCE(newsletter_enabled, true) = true 
     AND email IS NOT NULL 
     AND deleted_at IS NULL)::BIGINT,
    
    -- Total users with email
    (SELECT COUNT(*) FROM profiles 
     WHERE email IS NOT NULL 
     AND deleted_at IS NULL)::BIGINT;
END;
$$;

-- Function: Toggle newsletter status
CREATE OR REPLACE FUNCTION toggle_newsletter_status(
  p_user_id UUID,
  p_enabled BOOLEAN
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  -- Check if caller is admin
  IF NOT EXISTS (
    SELECT 1 FROM profiles 
    WHERE profiles.id = auth.uid() 
    AND profiles.role IN ('admin', 'super_admin')
  ) THEN
    RAISE EXCEPTION 'Access denied: Admin only';
  END IF;

  UPDATE profiles
  SET 
    newsletter_enabled = p_enabled,
    newsletter_unsubscribed_at = CASE WHEN p_enabled THEN NULL ELSE NOW() END
  WHERE id = p_user_id;

  RETURN true;
END;
$$;

-- ============================================
-- PART 5: WHOP WEBHOOK HANDLER
-- ============================================

CREATE OR REPLACE FUNCTION handle_whop_newsletter_subscription(
  p_user_email TEXT,
  p_membership_id TEXT,
  p_action TEXT -- 'subscribe' or 'unsubscribe'
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_user_id UUID;
  v_result JSONB;
BEGIN
  -- Find user by email
  SELECT id INTO v_user_id
  FROM profiles
  WHERE LOWER(email) = LOWER(p_user_email)
  LIMIT 1;
  
  IF v_user_id IS NULL THEN
    RETURN jsonb_build_object('success', false, 'error', 'User not found');
  END IF;
  
  IF p_action = 'subscribe' THEN
    UPDATE profiles
    SET 
      newsletter_paid = true,
      newsletter_paid_at = NOW(),
      newsletter_enabled = true,
      whop_newsletter_membership_id = p_membership_id
    WHERE id = v_user_id;
    
    v_result := jsonb_build_object('success', true, 'action', 'subscribed', 'user_id', v_user_id);
    
  ELSIF p_action = 'unsubscribe' THEN
    UPDATE profiles
    SET 
      newsletter_paid = false,
      whop_newsletter_membership_id = NULL
    WHERE id = v_user_id;
    
    v_result := jsonb_build_object('success', true, 'action', 'unsubscribed', 'user_id', v_user_id);
  ELSE
    v_result := jsonb_build_object('success', false, 'error', 'Invalid action');
  END IF;
  
  RETURN v_result;
END;
$$;

-- ============================================
-- PART 6: ADD TRACKING COLUMNS TO NEWSLETTERS
-- ============================================

DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'newsletters' AND column_name = 'opened_count'
  ) THEN
    ALTER TABLE newsletters ADD COLUMN opened_count INTEGER DEFAULT 0;
  END IF;
  
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'newsletters' AND column_name = 'clicked_count'
  ) THEN
    ALTER TABLE newsletters ADD COLUMN clicked_count INTEGER DEFAULT 0;
  END IF;
END $$;

-- ============================================
-- PART 7: GRANT PERMISSIONS
-- ============================================

GRANT EXECUTE ON FUNCTION get_newsletter_users() TO authenticated;
GRANT EXECUTE ON FUNCTION get_newsletter_stats() TO authenticated;
GRANT EXECUTE ON FUNCTION toggle_newsletter_status(UUID, BOOLEAN) TO authenticated;
GRANT EXECUTE ON FUNCTION handle_whop_newsletter_subscription(TEXT, TEXT, TEXT) TO service_role;


-- =====================================================
-- FINOTAUR NEWSLETTER CRON - SUPABASE SETUP
-- =====================================================

-- ============================================
-- ×©×œ×‘ 1: ×˜×‘×œ×ª ×œ×•×’×™×
-- ============================================

CREATE TABLE IF NOT EXISTS newsletter_cron_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  status TEXT NOT NULL CHECK (status IN ('success', 'failed', 'skipped')),
  newsletter_id UUID,
  recipient_count INTEGER,
  sent_count INTEGER,
  failed_count INTEGER,
  error_message TEXT,
  http_status INTEGER,
  response_body JSONB,
  triggered_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  duration_ms INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_newsletter_cron_logs_triggered 
ON newsletter_cron_logs(triggered_at DESC);

ALTER TABLE newsletter_cron_logs ENABLE ROW LEVEL SECURITY;

-- â¬‡ï¸ FIX: Drop policy first if exists, then create
DROP POLICY IF EXISTS "Service role full access" ON newsletter_cron_logs;
CREATE POLICY "Service role full access" ON newsletter_cron_logs
  FOR ALL USING (true);


-- ============================================
-- ×©×œ×‘ 2: ×¤×•× ×§×¦×™×” ×œ×”×¤×¢×œ×ª Edge Function
-- ============================================
-- âš ï¸ ×”×—×œ×£ YOUR_PROJECT_REF ×•-YOUR_CRON_SECRET

CREATE OR REPLACE FUNCTION invoke_newsletter_cron()
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_request_id BIGINT;
BEGIN
  -- ×§×¨×™××” ×œ-Edge Function
  SELECT net.http_post(
    url := 'https://YOUR_PROJECT_REF.supabase.co/functions/v1/newsletter-cron?secret=YOUR_CRON_SECRET',
    headers := '{"Content-Type": "application/json"}'::jsonb,
    body := '{}'::jsonb,
    timeout_milliseconds := 300000  -- 5 ×“×§×•×ª
  ) INTO v_request_id;

  RAISE NOTICE 'ğŸ“¨ Newsletter cron triggered, request_id: %', v_request_id;
END;
$$;


-- ============================================
-- ×©×œ×‘ 3: ×ª×–××•×Ÿ Cron Job
-- ============================================
-- 14:00 UTC = 9:00 AM EST (×—×•×¨×£) / 10:00 AM EDT (×§×™×¥)

-- ××—×§ job ×§×™×™× (×‘×¦×•×¨×” ×‘×˜×•×—×”)
DO $$
BEGIN
  PERFORM cron.unschedule('newsletter-daily-cron');
EXCEPTION WHEN OTHERS THEN
  -- Job doesn't exist, ignore
  NULL;
END $$;

-- ×¦×•×¨ job ×—×“×©
SELECT cron.schedule(
  'newsletter-daily-cron',
  '0 14 * * 1-5',  -- 14:00 UTC, ×¨××©×•×Ÿ ×¢×“ ×—××™×©×™ (×‘×™×©×¨××œ ×–×” ×™×•× ×-×”)
  $$SELECT invoke_newsletter_cron()$$
);


-- ============================================
-- ××™××•×ª
-- ============================================

SELECT 'âœ… Setup complete!' as status;

-- Show current state
SELECT 
  COUNT(*) as total_users,
  COUNT(newsletter_unsubscribe_token) as with_token,
  COUNT(*) FILTER (WHERE newsletter_paid = true) as paid_subscribers,
  COUNT(*) FILTER (WHERE newsletter_enabled = true) as enabled_users
FROM profiles
WHERE email IS NOT NULL AND deleted_at IS NULL;

-- ×‘×“×•×§ ×©×”-job × ×•×¦×¨
SELECT jobname, schedule, active 
FROM cron.job 
WHERE jobname = 'newsletter-daily-cron';