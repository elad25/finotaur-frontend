-- ===============================================
-- ğŸ”¥ FINOTAUR - COMPLETE UNIFIED MIGRATION
-- ===============================================
-- Version: v9.4.3-FIXED
-- Date: 2025-01-15
-- Part: 1/4 (Tables + Indexes + RLS)
-- ===============================================
-- âœ… Zero duplicates
-- âœ… Correct order
-- âœ… Production-optimized
-- âœ… 5000+ users ready
-- âœ… ALL RLS policies VERIFIED WORKING (NO RECURSION!)
-- âœ… Profiles INSERT policy
-- âœ… Trades INSERT policy (SIMPLIFIED - limits enforced via trigger)
-- âœ… Admin impersonation support
-- âœ… Soft deletes support
-- âœ… Rate limiting
-- âœ… Generated columns
-- ğŸ”’ Payment provider column INCLUDED
-- ğŸ†• Risk calculation columns (risk_mode NOT risk_calculation_mode)
-- ğŸ’³ Payment system enhancements INCLUDED
-- ğŸ”¥ HOTFIX v8.4.9: Fixed infinite recursion in RLS
-- ğŸ“Š NEW v8.5.0: SnapTrade broker integration INCLUDED
-- ğŸ¯ NEW v8.5.1: Comprehensive Ticker Symbols table with multipliers
-- ğŸ” NEW v8.5.2: Enhanced RLS with admin mode protection
-- ğŸ”¥ NEW v8.5.3: ULTRA-SECURE - Split SELECT policies for trades
-- âš¡ NEW v8.5.4: UNIFIED SELECT policy (1 policy instead of 2)
-- ğŸ› NEW v8.5.5: FIX empty string handling in admin_mode check
-- ğŸ”‘ NEW v8.5.6: GRANT service_role to enable_admin_mode()
-- ğŸŒ NEW v8.5.7: Timezone & Trading Sessions support
-- âŒ NEW v8.5.7: NO AFFILIATE functionality
-- ğŸ”§ FIX v8.5.7: Added STOCKS, ETFs, CRYPTO to ticker_symbols
-- ğŸ”¥ NEW v9.4.0: ANTI-RECURSION FIX - auth schema functions!
-- ğŸ”§ NEW v9.4.2: FIXED - Removed duplicates, added missing columns!
-- ğŸ”§ NEW v9.4.3: FIXED - subscription_changes columns added!
-- ğŸ”§ NEW v9.4.3: FIXED - payment_history columns added!
-- ğŸ”§ NEW v9.4.3: Helper functions INCLUDED (not moved to Part 2)!
-- ===============================================
-- ============================================
-- PART 0: EXTENSIONS & HELPERS
-- ============================================

-- Wrapper for gen_random_bytes (pgcrypto is in extensions schema)
CREATE OR REPLACE FUNCTION public.gen_random_bytes(length INTEGER)
RETURNS BYTEA
LANGUAGE sql
SECURITY DEFINER
AS $$
  SELECT extensions.gen_random_bytes(length);
$$;

-- Helper function for generating tokens
CREATE OR REPLACE FUNCTION public.generate_random_token(length INTEGER DEFAULT 32)
RETURNS TEXT
LANGUAGE sql
SECURITY DEFINER
AS $$
  SELECT encode(extensions.gen_random_bytes(length), 'hex');
$$;
-- ===============================================
-- SECTION 1: NUCLEAR CLEANUP
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—';
  RAISE NOTICE 'â•‘  ğŸ”¥ FINOTAUR MIGRATION v9.4.3-FIXED   â•‘';
  RAISE NOTICE 'â•‘     Part 1/2: Tables + Indexes + RLS  â•‘';
  RAISE NOTICE 'â•‘     âŒ NO AFFILIATE FUNCTIONALITY     â•‘';
  RAISE NOTICE 'â•‘     ğŸŒ TIMEZONE SUPPORT ADDED!        â•‘';
  RAISE NOTICE 'â•‘     ğŸ”§ TICKER SYMBOLS FIX!            â•‘';
  RAISE NOTICE 'â•‘     ğŸ“ˆ STOCKS + ETFs + CRYPTO ADDED!  â•‘';
  RAISE NOTICE 'â•‘     ğŸ”‘ ADMIN MODE GRANTS FIXED!       â•‘';
  RAISE NOTICE 'â•‘     ğŸ› EMPTY STRING FIX!              â•‘';
  RAISE NOTICE 'â•‘     âš¡ UNIFIED SELECT POLICY!         â•‘';
  RAISE NOTICE 'â•‘     ğŸ”§ NO RECURSION IN RLS!           â•‘';
  RAISE NOTICE 'â•‘     ğŸ”’ PAYMENT PROVIDER INCLUDED!     â•‘';
  RAISE NOTICE 'â•‘     ğŸ†• RISK COLUMNS FIXED!            â•‘';
  RAISE NOTICE 'â•‘     ğŸ’³ PAYMENT ENHANCEMENTS ADDED!    â•‘';
  RAISE NOTICE 'â•‘     ğŸ“Š SNAPTRADE INTEGRATION ADDED!   â•‘';
  RAISE NOTICE 'â•‘     ğŸ¯ TICKER SYMBOLS MASTER TABLE!   â•‘';
  RAISE NOTICE 'â•‘     ğŸ” ENHANCED SECURITY POLICIES!    â•‘';
  RAISE NOTICE 'â•‘     ğŸ”¥ ANTI-RECURSION FIX v9.4.3!     â•‘';
  RAISE NOTICE 'â•‘     âœ… HELPER FUNCTIONS INCLUDED!     â•‘';
  RAISE NOTICE 'â•‘     âœ… RLS ENFORCES TRADE LIMITS!     â•‘';
  RAISE NOTICE 'â•‘     âœ… subscription_changes FIXED!    â•‘';
  RAISE NOTICE 'â•‘     âœ… payment_history FIXED!         â•‘';
  RAISE NOTICE 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
  RAISE NOTICE '';
  RAISE NOTICE '[1/10] Starting nuclear cleanup...';
END $$;

-- Drop ALL views (in correct order)
DROP MATERIALIZED VIEW IF EXISTS public.user_daily_pnl CASCADE;
DROP MATERIALIZED VIEW IF EXISTS public.strategy_stats_view CASCADE;
DROP MATERIALIZED VIEW IF EXISTS public.webhook_stats CASCADE;
DROP VIEW IF EXISTS public.payment_analytics CASCADE;
DROP VIEW IF EXISTS public.active_subscriptions CASCADE;
DROP VIEW IF EXISTS public.admin_stats_view CASCADE;
DROP VIEW IF EXISTS public.pricing_info CASCADE;
DROP VIEW IF EXISTS public.trade_limits_overview CASCADE;
DROP VIEW IF EXISTS public.snaptrade_connection_stats CASCADE;
DROP VIEW IF EXISTS public.admin_users_list_view CASCADE;
DROP VIEW IF EXISTS public.user_referral_info CASCADE;
DROP VIEW IF EXISTS public.affiliate_stats_view CASCADE;

-- Drop ALL triggers
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users CASCADE;
DROP TRIGGER IF EXISTS increment_trade_count_trigger ON public.trades CASCADE;
DROP TRIGGER IF EXISTS calculate_trade_outcome_trigger ON public.trades CASCADE;
DROP TRIGGER IF EXISTS on_payment_completed ON public.payment_history CASCADE;
DROP TRIGGER IF EXISTS trigger_update_login_stats ON public.user_activity_log CASCADE;
DROP TRIGGER IF EXISTS trigger_broker_connection_updated_at ON public.broker_connections CASCADE;
DROP TRIGGER IF EXISTS trigger_user_settings_updated_at ON public.user_settings CASCADE;
DROP TRIGGER IF EXISTS set_updated_at ON public.profiles CASCADE;
DROP TRIGGER IF EXISTS set_updated_at ON public.strategies CASCADE;
DROP TRIGGER IF EXISTS set_updated_at ON public.trades CASCADE;
DROP TRIGGER IF EXISTS trades_search_vector_update ON public.trades CASCADE;
DROP TRIGGER IF EXISTS trigger_update_current_portfolio ON public.trades CASCADE;
DROP TRIGGER IF EXISTS trigger_initialize_risk_settings ON public.profiles CASCADE;
DROP TRIGGER IF EXISTS trigger_update_monthly_usage ON public.trades CASCADE;
DROP TRIGGER IF EXISTS trigger_increment_monthly_trade_count ON public.trades CASCADE;
DROP TRIGGER IF EXISTS update_snaptrade_activity_updated_at_trigger ON public.snaptrade_activity CASCADE;
DROP TRIGGER IF EXISTS handle_trade_changes_unified_trigger ON public.trades CASCADE;

-- Drop ALL functions (alphabetically)
DROP FUNCTION IF EXISTS public.admin_get_broker_stats() CASCADE;
DROP FUNCTION IF EXISTS public.admin_get_limits_overview() CASCADE;
DROP FUNCTION IF EXISTS public.admin_get_trade_limits_overview() CASCADE;
DROP FUNCTION IF EXISTS public.admin_grant_free_months(UUID, INTEGER) CASCADE;
DROP FUNCTION IF EXISTS public.admin_grant_free_access(UUID, INTEGER, TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.admin_reset_trade_count(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.admin_toggle_user_ban(UUID, TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.admin_update_subscription(UUID, TEXT, TEXT, TEXT, TIMESTAMPTZ) CASCADE;
DROP FUNCTION IF EXISTS public.calculate_trade_outcome() CASCADE;
DROP FUNCTION IF EXISTS public.check_expired_subscriptions() CASCADE;
DROP FUNCTION IF EXISTS public.check_usage_warning(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.close_tradingview_trade(UUID, TEXT, TEXT, NUMERIC) CASCADE;
DROP FUNCTION IF EXISTS public.complete_referral_and_grant_rewards(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.generate_affiliate_code() CASCADE;
DROP FUNCTION IF EXISTS public.generate_tradingview_webhook() CASCADE;
DROP FUNCTION IF EXISTS public.generate_unique_affiliate_code() CASCADE;
DROP FUNCTION IF EXISTS public.get_admin_referral_overview() CASCADE;
DROP FUNCTION IF EXISTS public.get_asset_multiplier(TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.get_broker_status(TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.get_platform_stats() CASCADE;
DROP FUNCTION IF EXISTS public.get_portfolio_stats(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_remaining_trades(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_revenue_analytics(INTEGER) CASCADE;
DROP FUNCTION IF EXISTS public.get_subscription_breakdown() CASCADE;
DROP FUNCTION IF EXISTS public.get_trade_details(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_trades_by_broker() CASCADE;
DROP FUNCTION IF EXISTS public.get_user_detailed_stats(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_user_referral_stats(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_user_role() CASCADE;
DROP FUNCTION IF EXISTS public.get_user_storage_usage(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.get_user_subscription_status(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.handle_new_user() CASCADE;
DROP FUNCTION IF EXISTS public.handle_updated_at() CASCADE;
DROP FUNCTION IF EXISTS public.increment_affiliate_conversions(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.increment_affiliate_signups(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.increment_free_months(UUID, INTEGER) CASCADE;
DROP FUNCTION IF EXISTS public.increment_monthly_trade_count() CASCADE;
DROP FUNCTION IF EXISTS public.increment_referral_count(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.increment_trade_count() CASCADE;
DROP FUNCTION IF EXISTS public.initialize_risk_settings() CASCADE;
DROP FUNCTION IF EXISTS public.is_admin() CASCADE;
DROP FUNCTION IF EXISTS public.is_super_admin() CASCADE;
DROP FUNCTION IF EXISTS public.log_admin_action(TEXT, UUID, TEXT, UUID, JSONB) CASCADE;
DROP FUNCTION IF EXISTS public.mark_warning_shown(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.process_referral_signup(UUID, TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.reset_monthly_trade_counts() CASCADE;
DROP FUNCTION IF EXISTS public.search_trades(TEXT, UUID) CASCADE;
DROP FUNCTION IF EXISTS public.update_account_type_on_payment() CASCADE;
DROP FUNCTION IF EXISTS public.update_current_portfolio() CASCADE;
DROP FUNCTION IF EXISTS public.update_monthly_usage() CASCADE;
DROP FUNCTION IF EXISTS public.update_timestamp() CASCADE;
DROP FUNCTION IF EXISTS public.update_trades_search_vector() CASCADE;
DROP FUNCTION IF EXISTS public.update_user_login_stats() CASCADE;
DROP FUNCTION IF EXISTS public.use_free_month(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.handle_trade_changes_unified() CASCADE;
DROP FUNCTION IF EXISTS public.verify_paid_access(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.check_rate_limit(TEXT, INTEGER, INTEGER) CASCADE;
DROP FUNCTION IF EXISTS public.soft_delete_trade(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.restore_trade(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.permanent_delete_trade(UUID) CASCADE;
DROP FUNCTION IF EXISTS public.grant_free_access(UUID, INTEGER, TEXT, UUID) CASCADE;
DROP FUNCTION IF EXISTS public.verify_and_activate_subscription(UUID, TEXT, TEXT, TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.search_ticker_symbols(TEXT, INTEGER) CASCADE;
DROP FUNCTION IF EXISTS public.get_ticker_multiplier(TEXT) CASCADE;
DROP FUNCTION IF EXISTS public.enable_admin_mode() CASCADE;

-- Drop auth schema functions (anti-recursion helpers)
DROP FUNCTION IF EXISTS auth.is_admin() CASCADE;
DROP FUNCTION IF EXISTS auth.is_admin_mode() CASCADE;

-- Drop ALL RLS policies
DO $$
DECLARE
  pol record;
BEGIN
  FOR pol IN 
    SELECT DISTINCT tablename, policyname
    FROM pg_policies 
    WHERE schemaname = 'public'
  LOOP
    BEGIN
      EXECUTE format('DROP POLICY IF EXISTS %I ON public.%I CASCADE', 
        pol.policyname, pol.tablename);
    EXCEPTION WHEN OTHERS THEN
      NULL;
    END;
  END LOOP;
END $$;

-- Drop storage policies
DROP POLICY IF EXISTS "Users can upload trade screenshots" ON storage.objects;
DROP POLICY IF EXISTS "Users can view own trade screenshots" ON storage.objects;
DROP POLICY IF EXISTS "Users can update own trade screenshots" ON storage.objects;
DROP POLICY IF EXISTS "Users can delete own trade screenshots" ON storage.objects;

-- Drop affiliate-related tables
DROP TABLE IF EXISTS public.affiliate_stats CASCADE;
DROP TABLE IF EXISTS public.referrals CASCADE;
DROP TABLE IF EXISTS public.free_months_credits CASCADE;

-- ===============================================
-- SECTION 2: PROFILES TABLE (COMPLETE + ENHANCED + RISK COLUMNS - NO AFFILIATE)
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[2/10] Setting up profiles table...';
  RAISE NOTICE '      âŒ NO affiliate columns';
  RAISE NOTICE '      ğŸ†• Adding risk calculation columns...';
  RAISE NOTICE '      ğŸ”§ Using risk_mode (NOT risk_calculation_mode)';
  RAISE NOTICE '      ğŸ’³ Adding payment system enhancements...';
  RAISE NOTICE '      âš¡ FIXED: Removed risk percentage limit constraint!';
  RAISE NOTICE '      ğŸ†• v9.4.3: Adding missing subscription columns!';
  RAISE NOTICE '      ğŸ’° v9.4.4: Updated payment_provider to use WHOP!';
END $$;

-- ğŸ”¥ CRITICAL: Add risk columns FIRST
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS portfolio_size DECIMAL(15, 2);
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS risk_percentage DECIMAL(5, 2);
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS risk_mode VARCHAR(20);
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS fixed_risk_amount DECIMAL(15, 2);

-- Add all other columns (IF NOT EXISTS pattern)
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS role TEXT DEFAULT 'user';
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS account_type TEXT DEFAULT 'basic';
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS subscription_interval TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS subscription_status TEXT DEFAULT 'active';
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS subscription_started_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS subscription_expires_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS subscription_paused_until TIMESTAMPTZ;

-- ğŸ†• v9.4.3: Added missing subscription cancellation columns
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS subscription_cancel_at_period_end BOOLEAN DEFAULT FALSE;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS cancellation_requested_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS cancellation_effective_date TIMESTAMPTZ;

-- Trial columns
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS trial_ends_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS trial_used BOOLEAN DEFAULT FALSE;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS trial_start_date TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS is_in_trial BOOLEAN DEFAULT FALSE;

ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS last_login_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS login_count INTEGER DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS is_banned BOOLEAN DEFAULT false;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS ban_reason TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS banned_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS banned_by UUID;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS current_month_trades_count INTEGER DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS current_month_active_days INTEGER DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS billing_cycle_start DATE DEFAULT CURRENT_DATE;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS last_warning_shown_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS current_portfolio DECIMAL;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS initial_portfolio DECIMAL DEFAULT 10000;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS total_pnl DECIMAL DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS trade_count INTEGER DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS max_trades INTEGER DEFAULT 10;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS payment_provider TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS deleted_by UUID;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS cancellation_reason TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS previous_account_type TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS upgrade_date TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS prorated_credit NUMERIC(10,2) DEFAULT 0;

-- âœ… Terms acceptance columns
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS terms_accepted_at TIMESTAMPTZ;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS terms_version TEXT;
-- ğŸ”¥ UPDATE existing users with default risk values
UPDATE public.profiles
SET 
  portfolio_size = COALESCE(portfolio_size, initial_portfolio, current_portfolio, 10000),
  risk_mode = COALESCE(risk_mode, 'percentage'),
  risk_percentage = COALESCE(risk_percentage, 1.0),
  fixed_risk_amount = COALESCE(fixed_risk_amount, NULL)
WHERE portfolio_size IS NULL OR risk_mode IS NULL OR risk_percentage IS NULL;

-- Now add DEFAULT constraints (after updating existing rows)
ALTER TABLE public.profiles ALTER COLUMN portfolio_size SET DEFAULT 10000;
ALTER TABLE public.profiles ALTER COLUMN risk_percentage SET DEFAULT 1.0;
ALTER TABLE public.profiles ALTER COLUMN risk_mode SET DEFAULT 'percentage';

-- âœ… ADD affiliate columns (needed for referral tracking)
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS affiliate_code TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS referred_by TEXT;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS free_months_available INTEGER DEFAULT 0;
ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS referral_count INTEGER DEFAULT 0;

-- Drop and recreate constraints
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_role_check;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_role_check 
  CHECK (role IN ('user', 'admin', 'super_admin'));

-- ğŸ”¥ FIX: Clean invalid account_type values BEFORE adding constraint
UPDATE public.profiles 
SET 
  account_type = 'basic',
  is_in_trial = TRUE,
  trial_used = TRUE,
  trial_start_date = NOW(),
  trial_ends_at = NOW() + INTERVAL '14 days',
  subscription_status = 'trial',
  max_trades = 25,
  current_month_trades_count = 0,
  billing_cycle_start = CURRENT_DATE
WHERE account_type = 'free';

-- Step 2: Migrate old 'trial' account_type to 'basic' with trial status
UPDATE public.profiles 
SET 
  account_type = 'basic',
  subscription_status = 'trial'
WHERE account_type = 'trial';

-- Step 3: Clean any remaining invalid values
UPDATE public.profiles 
SET 
  account_type = 'basic',
  subscription_status = 'expired'
WHERE account_type IS NULL 
   OR account_type NOT IN ('basic', 'premium', 'admin', 'vip');

-- âœ… ×–×” ×›×‘×¨ × ×›×•×Ÿ! ××™×Ÿ 'free' ×‘-constraint
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_account_type_check;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_account_type_check 
CHECK (account_type IS NULL OR account_type IN ('free', 'platform_free', 'basic', 'premium', 'trial', 'admin', 'vip', 'newsletter', 'top_secret', 'top_secret_bundle'));

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_subscription_interval_check;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_subscription_interval_check 
  CHECK (subscription_interval IN ('monthly', 'yearly') OR subscription_interval IS NULL);

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_subscription_status_check;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_subscription_status_check 
  CHECK (subscription_status IS NULL OR subscription_status IN ('trial', 'active', 'expired', 'cancelled', 'inactive', 'trialing', 'past_due'));

-- ğŸ”¥ FIX: Clean invalid subscription_interval values BEFORE adding constraint
-- Free users should have NULL interval
UPDATE public.profiles 
SET subscription_interval = NULL 
WHERE account_type = 'free' 
  AND subscription_interval IS NOT NULL;

-- Paid users (basic/premium) must have an interval - default to 'monthly'
UPDATE public.profiles 
SET subscription_interval = 'monthly' 
WHERE account_type IN ('basic', 'premium') 
  AND subscription_interval IS NULL;

-- ğŸ”¥ REMOVED: check_paid_has_interval causes webhook failures
-- The webhook correctly manages subscription_interval on its own
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_paid_has_interval;

-- ğŸ’° v9.4.4: FIX existing invalid payment_provider values BEFORE adding constraint
UPDATE public.profiles 
SET payment_provider = NULL 
WHERE payment_provider IS NOT NULL 
  AND payment_provider NOT IN ('whop', 'stripe', 'paypal');

-- ğŸ’° v9.4.4: Updated to use WHOP instead of payplus
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_payment_provider_check;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_payment_provider_check 
  CHECK (payment_provider IN ('whop', 'stripe', 'paypal') OR payment_provider IS NULL);

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_banned_by_fkey;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_banned_by_fkey 
  FOREIGN KEY (banned_by) REFERENCES public.profiles(id);

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS profiles_deleted_by_fkey;
ALTER TABLE public.profiles ADD CONSTRAINT profiles_deleted_by_fkey 
  FOREIGN KEY (deleted_by) REFERENCES public.profiles(id);

-- ğŸ”¥ FIX: Remove portfolio_size constraint (too restrictive)
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_portfolio_size_positive;
ALTER TABLE public.profiles ADD CONSTRAINT check_portfolio_size_positive 
  CHECK (portfolio_size > 0);

-- ğŸ”¥ FIX: Remove ALL risk_percentage constraints (no limits!)
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_risk_per_trade_range;
ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_risk_percentage_range;
-- âœ… NO NEW CONSTRAINT - users can enter ANY percentage they want!

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_risk_mode;
ALTER TABLE public.profiles ADD CONSTRAINT check_risk_mode 
  CHECK (risk_mode IN ('percentage', 'fixed'));

ALTER TABLE public.profiles DROP CONSTRAINT IF EXISTS check_fixed_risk_amount_positive;
ALTER TABLE public.profiles ADD CONSTRAINT check_fixed_risk_amount_positive 
  CHECK (fixed_risk_amount IS NULL OR fixed_risk_amount > 0);

CREATE INDEX IF NOT EXISTS idx_profiles_payment_provider 
ON public.profiles(payment_provider) 
WHERE payment_provider IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_profiles_risk_settings 
ON public.profiles(risk_mode, portfolio_size);

CREATE INDEX IF NOT EXISTS idx_profiles_subscription_expires 
ON public.profiles(subscription_expires_at) 
WHERE subscription_status IN ('active', 'cancelled');

CREATE INDEX IF NOT EXISTS idx_profiles_cancellation 
ON public.profiles(cancellation_effective_date) 
WHERE cancellation_effective_date IS NOT NULL;

-- ğŸ†• v9.4.3: Index for subscription_cancel_at_period_end
CREATE INDEX IF NOT EXISTS idx_profiles_cancel_at_period_end
ON public.profiles(subscription_cancel_at_period_end)
WHERE subscription_cancel_at_period_end = TRUE;

-- Affiliate indexes
CREATE INDEX IF NOT EXISTS idx_profiles_affiliate_code 
ON public.profiles(affiliate_code) 
WHERE affiliate_code IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_profiles_referred_by 
ON public.profiles(referred_by) 
WHERE referred_by IS NOT NULL;

CREATE UNIQUE INDEX IF NOT EXISTS profiles_affiliate_code_key 
ON public.profiles(affiliate_code) 
WHERE affiliate_code IS NOT NULL;

COMMENT ON COLUMN public.profiles.current_portfolio IS 'Current portfolio value - auto-calculated as initial_portfolio + total_pnl';
COMMENT ON COLUMN public.profiles.initial_portfolio IS 'Starting portfolio value for tracking growth';
COMMENT ON COLUMN public.profiles.total_pnl IS 'Cumulative P&L across all closed trades - auto-updated';
COMMENT ON COLUMN public.profiles.trade_count IS 'Total number of trades (closed + open)';
COMMENT ON COLUMN public.profiles.deleted_at IS 'Soft delete timestamp - NULL means active';
COMMENT ON COLUMN public.profiles.max_trades IS 'Maximum trades allowed per billing cycle - varies by account type';
COMMENT ON COLUMN public.profiles.payment_provider IS 'Payment provider: whop, stripe, paypal. NULL for free accounts.';
COMMENT ON COLUMN public.profiles.portfolio_size IS 'Total account value for risk calculations';
COMMENT ON COLUMN public.profiles.risk_percentage IS 'Risk percentage per trade - NO LIMITS! Users can risk any amount they choose.';
COMMENT ON COLUMN public.profiles.risk_mode IS 'Risk calculation mode: percentage of portfolio or fixed dollar amount';
COMMENT ON COLUMN public.profiles.fixed_risk_amount IS 'Fixed dollar amount per trade when using fixed amount risk calculation mode';
COMMENT ON COLUMN public.profiles.cancellation_reason IS 'Reason for cancellation - stored for analytics';
COMMENT ON COLUMN public.profiles.cancellation_requested_at IS 'When user requested cancellation';
COMMENT ON COLUMN public.profiles.cancellation_effective_date IS 'When cancellation takes effect (end of paid period)';
COMMENT ON COLUMN public.profiles.previous_account_type IS 'Previous plan before upgrade/downgrade';
COMMENT ON COLUMN public.profiles.upgrade_date IS 'Date of last plan change';
COMMENT ON COLUMN public.profiles.prorated_credit IS 'Credit from unused portion of previous plan (for upgrades)';
COMMENT ON COLUMN public.profiles.subscription_cancel_at_period_end IS 'v9.4.3: If TRUE, subscription will cancel at end of current period';
COMMENT ON COLUMN public.profiles.trial_used IS 'v9.4.3: TRUE if user has already used their free trial';
COMMENT ON COLUMN public.profiles.trial_start_date IS 'v9.4.3: When user started their trial period';
COMMENT ON COLUMN public.profiles.affiliate_code IS 'Unique affiliate code owned by this user (if they are an affiliate)';
COMMENT ON COLUMN public.profiles.referred_by IS 'Affiliate code used during registration - tracks who referred this user';
COMMENT ON COLUMN public.profiles.free_months_available IS 'Number of free subscription months available as referral reward';
COMMENT ON COLUMN public.profiles.referral_count IS 'Number of users this person has successfully referred';
DO $$
BEGIN
  RAISE NOTICE 'âœ… [2/10] Profiles table setup complete!';
  RAISE NOTICE '      âœ… Risk columns added and initialized';
  RAISE NOTICE '      âœ… Existing users updated with defaults';
  RAISE NOTICE '      âš¡ Risk percentage constraint REMOVED - no limits!';
  RAISE NOTICE '      ğŸ†• v9.4.3: subscription_cancel_at_period_end added';
  RAISE NOTICE '      ğŸ†• v9.4.3: trial_used added';
  RAISE NOTICE '      ğŸ†• v9.4.3: trial_start_date added';
  RAISE NOTICE '      ğŸ’° v9.4.4: payment_provider uses WHOP!';
END $$;
-- ===============================================
-- SECTION 3: STRATEGIES TABLE (ENHANCED)
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[3/10] Setting up strategies table...';
END $$;

ALTER TABLE public.strategies ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ;

COMMENT ON COLUMN public.strategies.deleted_at IS 'Soft delete timestamp - NULL means active';

-- ===============================================
-- SECTION 4: TRADES TABLE (COMPLETE + ENHANCED + SNAPTRADE + TIMEZONE)
-- ===============================================
-- ğŸ”§ v9.4.3: Removed actual_user_r column (Option A - recommended)
-- ğŸ”§ v9.4.5: Added partial_exits with index and documentation

DO $$
BEGIN
  RAISE NOTICE '[4/10] Setting up trades table...';
  RAISE NOTICE '      ğŸ“Š Adding SnapTrade integration columns...';
  RAISE NOTICE '      ğŸŒ Adding timezone support...';
  RAISE NOTICE '      ğŸ”§ v9.4.3: actual_user_r REMOVED (calculated in Part 2)';
  RAISE NOTICE '      ğŸ†• v9.4.5: partial_exits column for scaling out!';
END $$;

ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS open_at TIMESTAMPTZ DEFAULT NOW();
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS close_at TIMESTAMPTZ;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS asset_class TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS stop_price NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS take_profit_price NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS fees_mode TEXT DEFAULT 'auto';
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS strategy_id UUID;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS setup TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS mistake TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS next_time TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS tags TEXT[];
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS outcome TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS quality_tag TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS metrics JSONB;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS broker TEXT DEFAULT 'manual';
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS external_id TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS multiplier NUMERIC(10,2) DEFAULT 1;

-- ğŸ”¥ R-MULTIPLE COLUMNS (4 VARIANTS)
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS actual_r NUMERIC;           -- Contract R: PnL / Risk
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS user_risk_r NUMERIC;        -- User Rs risked
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS user_reward_r NUMERIC;      -- User Rs potential reward
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS actual_user_r NUMERIC;      -- User Rs achieved (PnL / 1R)

-- ğŸ”§ v9.4.4: actual_user_r RESTORED - needed for frontend
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS actual_user_r NUMERIC;
COMMENT ON COLUMN public.trades.actual_user_r IS 'User R-multiple achieved: Actual PnL / User 1R setting';

ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS risk_pts NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS reward_pts NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS rr NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS risk_usd NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS reward_usd NUMERIC;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS notes TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS screenshot_url TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS screenshots TEXT[] DEFAULT '{}';

-- ğŸ†• v9.4.6: Input mode for Risk-Only feature
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS input_mode TEXT DEFAULT 'summary';

-- Drop constraint first (if exists) to avoid errors on re-run
ALTER TABLE public.trades DROP CONSTRAINT IF EXISTS trades_input_mode_check;
ALTER TABLE public.trades ADD CONSTRAINT trades_input_mode_check 
  CHECK (input_mode IN ('summary', 'risk-only') OR input_mode IS NULL);

-- Migrate old screenshot_url to screenshots array
UPDATE public.trades 
SET screenshots = ARRAY[screenshot_url]
WHERE screenshot_url IS NOT NULL
  AND screenshot_url != '' 
  AND screenshots = '{}';

CREATE INDEX IF NOT EXISTS idx_trades_screenshots 
ON public.trades USING GIN (screenshots);

ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS notes_search_vector tsvector;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ†• v9.4.5: PARTIAL EXITS - For scaling out of positions
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Structure: [{price: number, quantity: number, date: string, pnl: number, fees?: number}]
-- Example: [{"price": 100.50, "quantity": 5, "date": "2024-01-15T10:30:00Z", "pnl": 250.00}]
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS partial_exits JSONB DEFAULT '[]'::jsonb;

-- Index for querying trades with partial exits
CREATE INDEX IF NOT EXISTS idx_trades_partial_exits 
ON public.trades USING GIN (partial_exits) 
WHERE partial_exits != '[]'::jsonb AND partial_exits IS NOT NULL;

-- Index for checking if trade has partial exits (for filtering)
CREATE INDEX IF NOT EXISTS idx_trades_has_partial_exits
ON public.trades ((partial_exits != '[]'::jsonb))
WHERE partial_exits IS NOT NULL;

COMMENT ON COLUMN public.trades.partial_exits IS 
'v9.4.5: Array of partial exit objects for scaling out of positions. 
Structure: [{price, quantity, date, pnl, fees?}]. 
Used when trader exits position in multiple parts rather than all at once.
Frontend can calculate weighted average exit price from this data.';

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- END OF PARTIAL EXITS SECTION
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS deleted_by UUID;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS snaptrade_activity_id TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS snaptrade_account_id TEXT;
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS import_source TEXT DEFAULT 'manual';
ALTER TABLE public.trades ADD COLUMN IF NOT EXISTS imported_at TIMESTAMPTZ;

ALTER TABLE public.trades DROP CONSTRAINT IF EXISTS trades_outcome_check;
ALTER TABLE public.trades ADD CONSTRAINT trades_outcome_check 
  CHECK (outcome IN ('WIN', 'LOSS', 'BE', 'OPEN') OR outcome IS NULL);

ALTER TABLE public.trades DROP CONSTRAINT IF EXISTS trades_broker_check;
ALTER TABLE public.trades ADD CONSTRAINT trades_broker_check 
  CHECK (broker IN ('manual', 'interactive_brokers', 'td_ameritrade', 'alpaca', 'tradingview', 'mt4', 'mt5', 'ninja_trader'));

ALTER TABLE public.trades DROP CONSTRAINT IF EXISTS trades_strategy_id_fkey;
ALTER TABLE public.trades ADD CONSTRAINT trades_strategy_id_fkey 
  FOREIGN KEY (strategy_id) REFERENCES public.strategies(id) ON DELETE SET NULL;

ALTER TABLE public.trades DROP CONSTRAINT IF EXISTS trades_deleted_by_fkey;
ALTER TABLE public.trades ADD CONSTRAINT trades_deleted_by_fkey 
  FOREIGN KEY (deleted_by) REFERENCES public.profiles(id);

ALTER TABLE public.trades DROP CONSTRAINT IF EXISTS check_import_source;
ALTER TABLE public.trades ADD CONSTRAINT check_import_source 
  CHECK (import_source IN ('manual', 'snaptrade', 'csv', 'api'));

UPDATE public.trades 
SET import_source = 'manual' 
WHERE import_source IS NULL;

-- ğŸ”¥ COMMENTS - Explain each column clearly
COMMENT ON COLUMN public.trades.multiplier IS 'Asset contract multiplier - verified against CME/ICE standards';
COMMENT ON COLUMN public.trades.actual_r IS 'Contract R-multiple: Actual PnL / Initial Risk (contract-based calculation)';
COMMENT ON COLUMN public.trades.user_risk_r IS 'User R-multiple RISKED: Risk USD / User''s 1R setting (how many Rs user is risking)';
COMMENT ON COLUMN public.trades.user_reward_r IS 'User R-multiple POTENTIAL REWARD: Reward USD / User''s 1R setting (potential gain in Rs)';
COMMENT ON COLUMN public.trades.notes IS 'Trade thesis, feelings, and what worked - supports full-text search';
COMMENT ON COLUMN public.trades.screenshot_url IS 'URL to compressed screenshot in Supabase Storage (legacy - use screenshots array)';
COMMENT ON COLUMN public.trades.screenshots IS 'Array of screenshot URLs - supports multiple screenshots per trade (1-4 recommended)';
COMMENT ON COLUMN public.trades.deleted_at IS 'Soft delete timestamp - NULL means active';
COMMENT ON COLUMN public.trades.snaptrade_activity_id IS 'SnapTrade activity ID - used for deduplication (unique per import)';
COMMENT ON COLUMN public.trades.snaptrade_account_id IS 'SnapTrade account ID - identifies which broker account this trade came from';
COMMENT ON COLUMN public.trades.import_source IS 'Source of the trade: manual (user entered), snaptrade (broker import), csv (CSV upload), api (API import)';
COMMENT ON COLUMN public.trades.imported_at IS 'Timestamp when this trade was imported from external source';

DO $$
BEGIN
  RAISE NOTICE 'âœ… [4/10] Trades table complete!';
  RAISE NOTICE '      âœ… actual_r - Contract R-multiple';
  RAISE NOTICE '      âœ… user_risk_r - User Rs risked';
  RAISE NOTICE '      âœ… user_reward_r - User Rs potential';
  RAISE NOTICE '      âœ… partial_exits - For scaling out of positions';
  RAISE NOTICE '      âœ… screenshots[] - Multiple screenshots support';
  RAISE NOTICE '      ğŸ”§ v9.4.5: partial_exits with GIN index added!';
END $$;
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸŒ SECTION 4.5: TIMEZONE & TRADING SESSIONS (v8.5.11-FINAL-FIX)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”¥ CRITICAL FIX: Constraint accepts NULL + case-insensitive!
-- âœ… Accepts: NULL, 'asia', 'Asia', 'ASIA', 'london', 'London', 'newyork', 'NewYork'
-- âœ… Uses LOWER() and TRIM() for validation
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
BEGIN
  RAISE NOTICE '[4.5/10] ğŸŒ Adding timezone and trading sessions support...';
  RAISE NOTICE '      âœ… Trading sessions NORMALIZED (lowercase preferred)';
  RAISE NOTICE '      âœ… Asia, London, New York sessions';
  RAISE NOTICE '      âœ… Based on NY timezone (EST/EDT)';
  RAISE NOTICE '      ğŸ”¥ CRITICAL FIX: Constraint accepts NULL + ANY case!';
END $$;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Add timezone-aware columns to trades
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_schema = 'public' 
      AND table_name = 'trades' 
      AND column_name = 'open_at_ny_time'
  ) THEN
    ALTER TABLE public.trades ADD COLUMN 
      open_at_ny_time TIMESTAMPTZ GENERATED ALWAYS AS (
        open_at AT TIME ZONE 'America/New_York'
      ) STORED;
    RAISE NOTICE '   âœ… Created open_at_ny_time column';
  ELSE
    RAISE NOTICE '   âœ“ open_at_ny_time column already exists';
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_schema = 'public' 
      AND table_name = 'trades' 
      AND column_name = 'close_at_ny_time'
  ) THEN
    ALTER TABLE public.trades ADD COLUMN 
      close_at_ny_time TIMESTAMPTZ GENERATED ALWAYS AS (
        close_at AT TIME ZONE 'America/New_York'
      ) STORED;
    RAISE NOTICE '   âœ… Created close_at_ny_time column';
  ELSE
    RAISE NOTICE '   âœ“ close_at_ny_time column already exists';
  END IF;
END $$;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Normalize existing session data
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
DECLARE
  updated_count INTEGER;
BEGIN
  -- Normalize to lowercase (preferred)
  UPDATE public.trades 
  SET session = LOWER(TRIM(session))
  WHERE session IS NOT NULL 
    AND session != LOWER(TRIM(session));
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  IF updated_count > 0 THEN
    RAISE NOTICE '   âœ… Normalized % existing session values to lowercase', updated_count;
  END IF;
  
  -- Map variations to standard values
  UPDATE public.trades 
  SET session = CASE 
    WHEN LOWER(session) IN ('tokyo', 'asian', 'asia session') THEN 'asia'
    WHEN LOWER(session) IN ('europe', 'european', 'london session') THEN 'london'
    WHEN LOWER(session) IN ('new york', 'us', 'usa', 'american', 'ny', 'new york session') THEN 'newyork'
    ELSE session
  END
  WHERE session IS NOT NULL;
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  IF updated_count > 0 THEN
    RAISE NOTICE '   âœ… Mapped % session variations to standard values', updated_count;
  END IF;
END $$;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”¥ CRITICAL FIX: Session Constraint (NULL + Case-Insensitive)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
DECLARE
  constraint_exists BOOLEAN;
BEGIN
  -- Check if constraint exists
  SELECT EXISTS (
    SELECT 1 FROM pg_constraint 
    WHERE conname = 'trades_session_check' 
      AND conrelid = 'public.trades'::regclass
  ) INTO constraint_exists;
  
  IF constraint_exists THEN
    ALTER TABLE public.trades DROP CONSTRAINT trades_session_check;
    RAISE NOTICE '   ğŸ”¥ Dropped old session constraint';
  END IF;
  
  -- ğŸ”¥ NEW: Accept NULL OR any case variation
  ALTER TABLE public.trades
  ADD CONSTRAINT trades_session_check 
  CHECK (
    session IS NULL 
    OR LOWER(TRIM(session)) IN ('asia', 'london', 'newyork')
  );
  
  RAISE NOTICE '   âœ… Created flexible session constraint (NULL + case-insensitive)';
END $$;

COMMENT ON CONSTRAINT trades_session_check ON public.trades IS
'v8.5.11-FINAL-FIX: Session accepts NULL OR any case (asia/Asia/ASIA). Uses LOWER() + TRIM() for validation.';

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Add indexes
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE INDEX IF NOT EXISTS idx_trades_session 
ON public.trades(session) 
WHERE session IS NOT NULL;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Add user timezone preference to profiles
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_schema = 'public' 
      AND table_name = 'profiles' 
      AND column_name = 'preferred_timezone'
  ) THEN
    ALTER TABLE public.profiles 
    ADD COLUMN preferred_timezone TEXT DEFAULT 'America/New_York';
    RAISE NOTICE '   âœ… Created preferred_timezone column';
  ELSE
    RAISE NOTICE '   âœ“ preferred_timezone column already exists';
  END IF;
END $$;

CREATE INDEX IF NOT EXISTS idx_profiles_timezone 
ON public.profiles(preferred_timezone);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Add column comments
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

COMMENT ON COLUMN public.trades.open_at_ny_time IS 
'Trade open time in NY timezone - used for session calculation';

COMMENT ON COLUMN public.trades.close_at_ny_time IS 
'Trade close time in NY timezone - used for session calculation';

COMMENT ON COLUMN public.trades.session IS 
'Trading session: asia/london/newyork (case-insensitive). Auto-detected based on NY time. CAN BE NULL.';

COMMENT ON COLUMN public.profiles.preferred_timezone IS 
'User preferred timezone for display purposes (trades stored in UTC, sessions calculated in NY time)';

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Verify the fix
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
DECLARE
  constraint_def TEXT;
  allows_null BOOLEAN;
  is_case_insensitive BOOLEAN;
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—';
  RAISE NOTICE 'â•‘  âœ… SECTION 4.5 COMPLETE!             â•‘';
  RAISE NOTICE 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
  RAISE NOTICE '';
  
  -- Get constraint definition
  SELECT pg_get_constraintdef(oid) INTO constraint_def
  FROM pg_constraint
  WHERE conname = 'trades_session_check'
    AND conrelid = 'public.trades'::regclass;
  
  -- Check properties
  allows_null := constraint_def ILIKE '%OR%session IS NULL%';
  is_case_insensitive := constraint_def ILIKE '%LOWER(%session%)%';
  
  IF allows_null THEN
    RAISE NOTICE 'âœ… Session constraint ALLOWS NULL';
  ELSE
    RAISE WARNING 'âš ï¸  Session constraint does NOT allow NULL!';
  END IF;
  
  IF is_case_insensitive THEN
    RAISE NOTICE 'âœ… Session constraint is CASE-INSENSITIVE';
  ELSE
    RAISE WARNING 'âš ï¸  Session constraint is case-sensitive!';
  END IF;
  
  RAISE NOTICE '';
  RAISE NOTICE 'ğŸ“Š Constraint Definition:';
  RAISE NOTICE '   %', constraint_def;
  RAISE NOTICE '';
  
  IF allows_null AND is_case_insensitive THEN
    RAISE NOTICE 'ğŸ‰ PERFECT! Session constraint is flexible and correct!';
    RAISE NOTICE '   ğŸ¯ Accepts: NULL, asia, Asia, ASIA, london, London, newyork, NewYork';
  ELSE
    RAISE WARNING 'âš ï¸  Constraint might cause issues!';
  END IF;
  
  RAISE NOTICE '';
  RAISE NOTICE 'âœ… Timezone & Trading Sessions support ready!';
  RAISE NOTICE '';
END $$;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- END OF SECTION 4.5
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- ===============================================
-- SECTION 5: ğŸ¯ TICKER SYMBOLS - MASTER TABLE (FIXED!)
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[5/10] Creating Ticker Symbols Master Table...';
  RAISE NOTICE '      ğŸ¯ Comprehensive list: Stocks, Futures, Crypto, Forex, ETFs';
  RAISE NOTICE '      ğŸ“Š Accurate multipliers for all asset classes';
  RAISE NOTICE '      ğŸš€ Fast autocomplete with popularity ranking';
  RAISE NOTICE '      ğŸ”§ FIXED: Added STOCKS, ETFs, CRYPTO!';
END $$;

CREATE TABLE IF NOT EXISTS public.ticker_symbols (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  symbol TEXT NOT NULL UNIQUE,
  name TEXT NOT NULL,
  asset_class TEXT NOT NULL CHECK (asset_class IN ('stock', 'futures', 'options', 'crypto', 'forex', 'etf')),
  multiplier NUMERIC(10,2) NOT NULL DEFAULT 1,
  exchange TEXT,
  popularity_rank INTEGER DEFAULT 999,
  is_active BOOLEAN DEFAULT TRUE,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_ticker_symbols_search 
ON public.ticker_symbols(symbol text_pattern_ops)
WHERE is_active = TRUE;

CREATE INDEX IF NOT EXISTS idx_ticker_symbols_popularity 
ON public.ticker_symbols(popularity_rank, symbol)
WHERE is_active = TRUE;

CREATE INDEX IF NOT EXISTS idx_ticker_symbols_asset_class 
ON public.ticker_symbols(asset_class, popularity_rank)
WHERE is_active = TRUE;

COMMENT ON TABLE public.ticker_symbols IS 'Master list of tradeable symbols with accurate multipliers and metadata for autocomplete';
COMMENT ON COLUMN public.ticker_symbols.symbol IS 'Ticker symbol (e.g., AAPL, ES, BTCUSDT)';
COMMENT ON COLUMN public.ticker_symbols.name IS 'Full name of the asset';
COMMENT ON COLUMN public.ticker_symbols.asset_class IS 'Type: stock, futures, options, crypto, forex, etf';
COMMENT ON COLUMN public.ticker_symbols.multiplier IS 'Contract multiplier - CRITICAL for P&L calculations (e.g., ES=50, NQ=20)';
COMMENT ON COLUMN public.ticker_symbols.exchange IS 'Exchange or broker (e.g., NASDAQ, CME, BINANCE)';
COMMENT ON COLUMN public.ticker_symbols.popularity_rank IS 'Lower = more popular (for autocomplete sorting)';
COMMENT ON COLUMN public.ticker_symbols.is_active IS 'FALSE if symbol is delisted/deprecated';

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“Š FUTURES (CME/ICE) - Already in original
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank, metadata) VALUES
-- CME E-mini Indices
('ES', 'E-mini S&P 500', 'futures', 50, 'CME', 1, '{"contract_size": "$50 x index", "tick_size": 0.25, "tick_value": 12.50}'::jsonb),
('NQ', 'E-mini NASDAQ-100', 'futures', 20, 'CME', 2, '{"contract_size": "$20 x index", "tick_size": 0.25, "tick_value": 5.00}'::jsonb),
('YM', 'E-mini Dow Jones', 'futures', 5, 'CBOT', 3, '{"contract_size": "$5 x index", "tick_size": 1, "tick_value": 5.00}'::jsonb),
('RTY', 'E-mini Russell 2000', 'futures', 50, 'CME', 4, '{"contract_size": "$50 x index", "tick_size": 0.10, "tick_value": 5.00}'::jsonb),

-- CME Micro E-mini Indices
('MES', 'Micro E-mini S&P 500', 'futures', 5, 'CME', 10, '{"contract_size": "$5 x index", "tick_size": 0.25, "tick_value": 1.25}'::jsonb),
('MNQ', 'Micro E-mini NASDAQ-100', 'futures', 2, 'CME', 11, '{"contract_size": "$2 x index", "tick_size": 0.25, "tick_value": 0.50}'::jsonb),
('MYM', 'Micro E-mini Dow Jones', 'futures', 0.5, 'CBOT', 12, '{"contract_size": "$0.50 x index", "tick_size": 1, "tick_value": 0.50}'::jsonb),
('M2K', 'Micro E-mini Russell 2000', 'futures', 5, 'CME', 13, '{"contract_size": "$5 x index", "tick_size": 0.10, "tick_value": 0.50}'::jsonb),

-- Energy
('CL', 'Crude Oil', 'futures', 1000, 'NYMEX', 20, '{"contract_size": "1,000 barrels", "tick_size": 0.01, "tick_value": 10.00}'::jsonb),
('NG', 'Natural Gas', 'futures', 10000, 'NYMEX', 21, '{"contract_size": "10,000 MMBtu", "tick_size": 0.001, "tick_value": 10.00}'::jsonb),
('MCL', 'Micro Crude Oil', 'futures', 100, 'NYMEX', 22, '{"contract_size": "100 barrels", "tick_size": 0.01, "tick_value": 1.00}'::jsonb),

-- Metals
('GC', 'Gold', 'futures', 100, 'COMEX', 30, '{"contract_size": "100 troy oz", "tick_size": 0.10, "tick_value": 10.00}'::jsonb),
('SI', 'Silver', 'futures', 5000, 'COMEX', 31, '{"contract_size": "5,000 troy oz", "tick_size": 0.005, "tick_value": 25.00}'::jsonb),
('HG', 'Copper', 'futures', 25000, 'COMEX', 32, '{"contract_size": "25,000 lbs", "tick_size": 0.0005, "tick_value": 12.50}'::jsonb),
('MGC', 'Micro Gold', 'futures', 10, 'COMEX', 33, '{"contract_size": "10 troy oz", "tick_size": 0.10, "tick_value": 1.00}'::jsonb),
('SIL', 'Micro Silver', 'futures', 1000, 'COMEX', 34, '{"contract_size": "1,000 troy oz", "tick_size": 0.005, "tick_value": 5.00}'::jsonb),

-- Currencies
('6E', 'Euro FX', 'futures', 125000, 'CME', 40, '{"contract_size": "â‚¬125,000", "tick_size": 0.00005, "tick_value": 6.25}'::jsonb),
('6B', 'British Pound', 'futures', 62500, 'CME', 41, '{"contract_size": "Â£62,500", "tick_size": 0.0001, "tick_value": 6.25}'::jsonb),
('6J', 'Japanese Yen', 'futures', 12500000, 'CME', 42, '{"contract_size": "Â¥12,500,000", "tick_size": 0.0000005, "tick_value": 6.25}'::jsonb),
('6A', 'Australian Dollar', 'futures', 100000, 'CME', 43, '{"contract_size": "A$100,000", "tick_size": 0.0001, "tick_value": 10.00}'::jsonb),

-- Agricultural
('ZC', 'Corn', 'futures', 50, 'CBOT', 50, '{"contract_size": "5,000 bushels", "tick_size": 0.25, "tick_value": 12.50}'::jsonb),
('ZW', 'Wheat', 'futures', 50, 'CBOT', 51, '{"contract_size": "5,000 bushels", "tick_size": 0.25, "tick_value": 12.50}'::jsonb),
('ZS', 'Soybeans', 'futures', 50, 'CBOT', 52, '{"contract_size": "5,000 bushels", "tick_size": 0.25, "tick_value": 12.50}'::jsonb)

ON CONFLICT (symbol) DO UPDATE SET
  name = EXCLUDED.name,
  multiplier = EXCLUDED.multiplier,
  exchange = EXCLUDED.exchange,
  popularity_rank = EXCLUDED.popularity_rank,
  metadata = EXCLUDED.metadata,
  updated_at = NOW();

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“ˆ STOCKS - POPULAR US STOCKS (NEW!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank, metadata) VALUES
-- Tech Giants (Magnificent 7)
('TSLA', 'Tesla Inc', 'stock', 1, 'NASDAQ', 100, '{"sector": "Automotive", "country": "USA", "market_cap": "mega"}'::jsonb),
('AAPL', 'Apple Inc', 'stock', 1, 'NASDAQ', 101, '{"sector": "Technology", "country": "USA", "market_cap": "mega"}'::jsonb),
('NVDA', 'NVIDIA Corporation', 'stock', 1, 'NASDAQ', 102, '{"sector": "Semiconductors", "country": "USA", "market_cap": "mega"}'::jsonb),
('GOOGL', 'Alphabet Inc Class A', 'stock', 1, 'NASDAQ', 103, '{"sector": "Technology", "country": "USA", "market_cap": "mega"}'::jsonb),
('GOOG', 'Alphabet Inc Class C', 'stock', 1, 'NASDAQ', 104, '{"sector": "Technology", "country": "USA", "market_cap": "mega"}'::jsonb),
('AMZN', 'Amazon.com Inc', 'stock', 1, 'NASDAQ', 105, '{"sector": "E-commerce", "country": "USA", "market_cap": "mega"}'::jsonb),
('META', 'Meta Platforms Inc', 'stock', 1, 'NASDAQ', 106, '{"sector": "Social Media", "country": "USA", "market_cap": "mega"}'::jsonb),
('MSFT', 'Microsoft Corporation', 'stock', 1, 'NASDAQ', 107, '{"sector": "Technology", "country": "USA", "market_cap": "mega"}'::jsonb),

-- Semiconductors
('AMD', 'Advanced Micro Devices', 'stock', 1, 'NASDAQ', 110, '{"sector": "Semiconductors", "country": "USA", "market_cap": "large"}'::jsonb),
('INTC', 'Intel Corporation', 'stock', 1, 'NASDAQ', 111, '{"sector": "Semiconductors", "country": "USA", "market_cap": "large"}'::jsonb),
('QCOM', 'Qualcomm Inc', 'stock', 1, 'NASDAQ', 112, '{"sector": "Semiconductors", "country": "USA", "market_cap": "large"}'::jsonb),
('AVGO', 'Broadcom Inc', 'stock', 1, 'NASDAQ', 113, '{"sector": "Semiconductors", "country": "USA", "market_cap": "large"}'::jsonb),
('TSM', 'Taiwan Semiconductor', 'stock', 1, 'NYSE', 114, '{"sector": "Semiconductors", "country": "Taiwan", "market_cap": "mega"}'::jsonb),

-- Financial
('JPM', 'JPMorgan Chase & Co', 'stock', 1, 'NYSE', 120, '{"sector": "Banking", "country": "USA", "market_cap": "large"}'::jsonb),
('BAC', 'Bank of America Corp', 'stock', 1, 'NYSE', 121, '{"sector": "Banking", "country": "USA", "market_cap": "large"}'::jsonb),
('WFC', 'Wells Fargo & Co', 'stock', 1, 'NYSE', 122, '{"sector": "Banking", "country": "USA", "market_cap": "large"}'::jsonb),
('GS', 'Goldman Sachs Group', 'stock', 1, 'NYSE', 123, '{"sector": "Investment Banking", "country": "USA", "market_cap": "large"}'::jsonb),
('MS', 'Morgan Stanley', 'stock', 1, 'NYSE', 124, '{"sector": "Investment Banking", "country": "USA", "market_cap": "large"}'::jsonb),
('V', 'Visa Inc', 'stock', 1, 'NYSE', 125, '{"sector": "Payment Processing", "country": "USA", "market_cap": "mega"}'::jsonb),
('MA', 'Mastercard Inc', 'stock', 1, 'NYSE', 126, '{"sector": "Payment Processing", "country": "USA", "market_cap": "mega"}'::jsonb),
('PYPL', 'PayPal Holdings Inc', 'stock', 1, 'NASDAQ', 127, '{"sector": "Payment Processing", "country": "USA", "market_cap": "large"}'::jsonb),

-- Retail & Consumer
('WMT', 'Walmart Inc', 'stock', 1, 'NYSE', 130, '{"sector": "Retail", "country": "USA", "market_cap": "large"}'::jsonb),
('COST', 'Costco Wholesale', 'stock', 1, 'NASDAQ', 131, '{"sector": "Retail", "country": "USA", "market_cap": "large"}'::jsonb),
('HD', 'Home Depot Inc', 'stock', 1, 'NYSE', 132, '{"sector": "Retail", "country": "USA", "market_cap": "large"}'::jsonb),
('TGT', 'Target Corporation', 'stock', 1, 'NYSE', 133, '{"sector": "Retail", "country": "USA", "market_cap": "large"}'::jsonb),
('NKE', 'Nike Inc', 'stock', 1, 'NYSE', 134, '{"sector": "Apparel", "country": "USA", "market_cap": "large"}'::jsonb),
('SBUX', 'Starbucks Corporation', 'stock', 1, 'NASDAQ', 135, '{"sector": "Restaurants", "country": "USA", "market_cap": "large"}'::jsonb),
('MCD', 'McDonald''s Corporation', 'stock', 1, 'NYSE', 136, '{"sector": "Restaurants", "country": "USA", "market_cap": "large"}'::jsonb),

-- Entertainment & Media
('DIS', 'Walt Disney Co', 'stock', 1, 'NYSE', 140, '{"sector": "Entertainment", "country": "USA", "market_cap": "large"}'::jsonb),
('NFLX', 'Netflix Inc', 'stock', 1, 'NASDAQ', 141, '{"sector": "Streaming", "country": "USA", "market_cap": "large"}'::jsonb),
('CMCSA', 'Comcast Corporation', 'stock', 1, 'NASDAQ', 142, '{"sector": "Telecom", "country": "USA", "market_cap": "large"}'::jsonb),

-- Healthcare & Pharma
('JNJ', 'Johnson & Johnson', 'stock', 1, 'NYSE', 150, '{"sector": "Healthcare", "country": "USA", "market_cap": "mega"}'::jsonb),
('UNH', 'UnitedHealth Group', 'stock', 1, 'NYSE', 151, '{"sector": "Healthcare", "country": "USA", "market_cap": "mega"}'::jsonb),
('PFE', 'Pfizer Inc', 'stock', 1, 'NYSE', 152, '{"sector": "Pharmaceuticals", "country": "USA", "market_cap": "large"}'::jsonb),
('ABBV', 'AbbVie Inc', 'stock', 1, 'NYSE', 153, '{"sector": "Pharmaceuticals", "country": "USA", "market_cap": "large"}'::jsonb),
('LLY', 'Eli Lilly and Co', 'stock', 1, 'NYSE', 154, '{"sector": "Pharmaceuticals", "country": "USA", "market_cap": "mega"}'::jsonb),
('MRNA', 'Moderna Inc', 'stock', 1, 'NASDAQ', 155, '{"sector": "Biotechnology", "country": "USA", "market_cap": "mid"}'::jsonb),

-- Energy
('XOM', 'Exxon Mobil Corp', 'stock', 1, 'NYSE', 160, '{"sector": "Oil & Gas", "country": "USA", "market_cap": "mega"}'::jsonb),
('CVX', 'Chevron Corporation', 'stock', 1, 'NYSE', 161, '{"sector": "Oil & Gas", "country": "USA", "market_cap": "large"}'::jsonb),
('COP', 'ConocoPhillips', 'stock', 1, 'NYSE', 162, '{"sector": "Oil & Gas", "country": "USA", "market_cap": "large"}'::jsonb),

-- Aerospace & Defense
('BA', 'Boeing Company', 'stock', 1, 'NYSE', 170, '{"sector": "Aerospace", "country": "USA", "market_cap": "large"}'::jsonb),
('LMT', 'Lockheed Martin', 'stock', 1, 'NYSE', 171, '{"sector": "Defense", "country": "USA", "market_cap": "large"}'::jsonb),
('RTX', 'Raytheon Technologies', 'stock', 1, 'NYSE', 172, '{"sector": "Defense", "country": "USA", "market_cap": "large"}'::jsonb),

-- Meme Stocks & High Volume
('GME', 'GameStop Corp', 'stock', 1, 'NYSE', 180, '{"sector": "Retail", "country": "USA", "market_cap": "small", "type": "meme_stock"}'::jsonb),
('AMC', 'AMC Entertainment', 'stock', 1, 'NYSE', 181, '{"sector": "Entertainment", "country": "USA", "market_cap": "small", "type": "meme_stock"}'::jsonb),
('BB', 'BlackBerry Limited', 'stock', 1, 'NYSE', 182, '{"sector": "Technology", "country": "Canada", "market_cap": "small"}'::jsonb),
('PLTR', 'Palantir Technologies', 'stock', 1, 'NYSE', 183, '{"sector": "Software", "country": "USA", "market_cap": "mid"}'::jsonb),
('COIN', 'Coinbase Global', 'stock', 1, 'NASDAQ', 184, '{"sector": "Cryptocurrency Exchange", "country": "USA", "market_cap": "mid"}'::jsonb),
('HOOD', 'Robinhood Markets', 'stock', 1, 'NASDAQ', 185, '{"sector": "Fintech", "country": "USA", "market_cap": "mid"}'::jsonb),

-- EV & Clean Energy
('RIVN', 'Rivian Automotive', 'stock', 1, 'NASDAQ', 190, '{"sector": "EV", "country": "USA", "market_cap": "mid"}'::jsonb),
('LCID', 'Lucid Group Inc', 'stock', 1, 'NASDAQ', 191, '{"sector": "EV", "country": "USA", "market_cap": "mid"}'::jsonb),
('NIO', 'NIO Inc', 'stock', 1, 'NYSE', 192, '{"sector": "EV", "country": "China", "market_cap": "mid"}'::jsonb),
('XPEV', 'XPeng Inc', 'stock', 1, 'NYSE', 193, '{"sector": "EV", "country": "China", "market_cap": "small"}'::jsonb),

-- AI & Cloud
('SNOW', 'Snowflake Inc', 'stock', 1, 'NYSE', 200, '{"sector": "Cloud Computing", "country": "USA", "market_cap": "large"}'::jsonb),
('CRM', 'Salesforce Inc', 'stock', 1, 'NYSE', 201, '{"sector": "CRM Software", "country": "USA", "market_cap": "large"}'::jsonb),
('ORCL', 'Oracle Corporation', 'stock', 1, 'NYSE', 202, '{"sector": "Database Software", "country": "USA", "market_cap": "large"}'::jsonb),
('IBM', 'IBM', 'stock', 1, 'NYSE', 203, '{"sector": "IT Services", "country": "USA", "market_cap": "large"}'::jsonb),
('ADBE', 'Adobe Inc', 'stock', 1, 'NASDAQ', 204, '{"sector": "Software", "country": "USA", "market_cap": "large"}'::jsonb)

ON CONFLICT (symbol) DO UPDATE SET
  name = EXCLUDED.name,
  multiplier = EXCLUDED.multiplier,
  exchange = EXCLUDED.exchange,
  popularity_rank = EXCLUDED.popularity_rank,
  metadata = EXCLUDED.metadata,
  updated_at = NOW();

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“Š ETFs - MOST POPULAR ETFs (NEW!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank, metadata) VALUES
-- Broad Market
('SPY', 'SPDR S&P 500 ETF', 'etf', 1, 'NYSE', 300, '{"type": "Equity ETF", "tracks": "S&P 500", "expense_ratio": "0.09%"}'::jsonb),
('QQQ', 'Invesco QQQ Trust', 'etf', 1, 'NASDAQ', 301, '{"type": "Equity ETF", "tracks": "NASDAQ-100", "expense_ratio": "0.20%"}'::jsonb),
('IWM', 'iShares Russell 2000 ETF', 'etf', 1, 'NYSE', 302, '{"type": "Equity ETF", "tracks": "Russell 2000", "expense_ratio": "0.19%"}'::jsonb),
('DIA', 'SPDR Dow Jones ETF', 'etf', 1, 'NYSE', 303, '{"type": "Equity ETF", "tracks": "Dow Jones", "expense_ratio": "0.16%"}'::jsonb),
('VOO', 'Vanguard S&P 500 ETF', 'etf', 1, 'NYSE', 304, '{"type": "Equity ETF", "tracks": "S&P 500", "expense_ratio": "0.03%"}'::jsonb),
('VTI', 'Vanguard Total Stock Market', 'etf', 1, 'NYSE', 305, '{"type": "Equity ETF", "tracks": "Total US Market", "expense_ratio": "0.03%"}'::jsonb),

-- Sector ETFs
('XLF', 'Financial Select Sector SPDR', 'etf', 1, 'NYSE', 310, '{"type": "Sector ETF", "sector": "Financial", "expense_ratio": "0.10%"}'::jsonb),
('XLK', 'Technology Select Sector SPDR', 'etf', 1, 'NYSE', 311, '{"type": "Sector ETF", "sector": "Technology", "expense_ratio": "0.10%"}'::jsonb),
('XLE', 'Energy Select Sector SPDR', 'etf', 1, 'NYSE', 312, '{"type": "Sector ETF", "sector": "Energy", "expense_ratio": "0.10%"}'::jsonb),
('XLV', 'Health Care Select Sector SPDR', 'etf', 1, 'NYSE', 313, '{"type": "Sector ETF", "sector": "Healthcare", "expense_ratio": "0.10%"}'::jsonb),
('XLI', 'Industrial Select Sector SPDR', 'etf', 1, 'NYSE', 314, '{"type": "Sector ETF", "sector": "Industrial", "expense_ratio": "0.10%"}'::jsonb),

-- Volatility & Inverse
('VXX', 'iPath Series B S&P 500 VIX', 'etf', 1, 'BATS', 320, '{"type": "Volatility ETF", "tracks": "VIX Futures"}'::jsonb),
('UVXY', 'ProShares Ultra VIX Short-Term', 'etf', 1, 'BATS', 321, '{"type": "Leveraged Volatility ETF", "leverage": "1.5x"}'::jsonb),
('SQQQ', 'ProShares UltraPro Short QQQ', 'etf', 1, 'NASDAQ', 322, '{"type": "Inverse Leveraged ETF", "leverage": "-3x", "tracks": "NASDAQ-100"}'::jsonb),
('TQQQ', 'ProShares UltraPro QQQ', 'etf', 1, 'NASDAQ', 323, '{"type": "Leveraged ETF", "leverage": "3x", "tracks": "NASDAQ-100"}'::jsonb),
('SPXU', 'ProShares UltraPro Short S&P500', 'etf', 1, 'NYSE', 324, '{"type": "Inverse Leveraged ETF", "leverage": "-3x", "tracks": "S&P 500"}'::jsonb),
('UPRO', 'ProShares UltraPro S&P500', 'etf', 1, 'NYSE', 325, '{"type": "Leveraged ETF", "leverage": "3x", "tracks": "S&P 500"}'::jsonb),

-- Bonds
('TLT', 'iShares 20+ Year Treasury Bond', 'etf', 1, 'NASDAQ', 330, '{"type": "Bond ETF", "tracks": "Long-term Treasuries"}'::jsonb),
('AGG', 'iShares Core US Aggregate Bond', 'etf', 1, 'NYSE', 331, '{"type": "Bond ETF", "tracks": "US Aggregate Bonds"}'::jsonb),
('HYG', 'iShares iBoxx High Yield Corporate', 'etf', 1, 'NYSE', 332, '{"type": "Bond ETF", "tracks": "High Yield Bonds"}'::jsonb),

-- Gold & Commodities
('GLD', 'SPDR Gold Shares', 'etf', 1, 'NYSE', 340, '{"type": "Commodity ETF", "tracks": "Gold"}'::jsonb),
('SLV', 'iShares Silver Trust', 'etf', 1, 'NYSE', 341, '{"type": "Commodity ETF", "tracks": "Silver"}'::jsonb),
('USO', 'United States Oil Fund', 'etf', 1, 'NYSE', 342, '{"type": "Commodity ETF", "tracks": "Crude Oil"}'::jsonb),
('UNG', 'United States Natural Gas Fund', 'etf', 1, 'NYSE', 343, '{"type": "Commodity ETF", "tracks": "Natural Gas"}'::jsonb),

-- Crypto ETFs
('BITO', 'ProShares Bitcoin Strategy', 'etf', 1, 'NYSE', 350, '{"type": "Crypto ETF", "tracks": "Bitcoin Futures"}'::jsonb)

ON CONFLICT (symbol) DO UPDATE SET
  name = EXCLUDED.name,
  multiplier = EXCLUDED.multiplier,
  exchange = EXCLUDED.exchange,
  popularity_rank = EXCLUDED.popularity_rank,
  metadata = EXCLUDED.metadata,
  updated_at = NOW();

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ’° CRYPTO - POPULAR CRYPTOCURRENCIES (NEW!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank, metadata) VALUES
-- Major Cryptocurrencies
('BTC', 'Bitcoin', 'crypto', 1, 'CRYPTO', 400, '{"type": "Cryptocurrency", "category": "Layer 1"}'::jsonb),
('BTCUSDT', 'Bitcoin/USDT', 'crypto', 1, 'BINANCE', 401, '{"type": "Cryptocurrency", "pair": "USDT", "category": "Layer 1"}'::jsonb),
('ETH', 'Ethereum', 'crypto', 1, 'CRYPTO', 402, '{"type": "Cryptocurrency", "category": "Smart Contract Platform"}'::jsonb),
('ETHUSDT', 'Ethereum/USDT', 'crypto', 1, 'BINANCE', 403, '{"type": "Cryptocurrency", "pair": "USDT", "category": "Smart Contract Platform"}'::jsonb),
('BNB', 'Binance Coin', 'crypto', 1, 'BINANCE', 404, '{"type": "Cryptocurrency", "category": "Exchange Token"}'::jsonb),
('SOL', 'Solana', 'crypto', 1, 'CRYPTO', 405, '{"type": "Cryptocurrency", "category": "Smart Contract Platform"}'::jsonb),
('ADA', 'Cardano', 'crypto', 1, 'CRYPTO', 406, '{"type": "Cryptocurrency", "category": "Smart Contract Platform"}'::jsonb),
('XRP', 'Ripple', 'crypto', 1, 'CRYPTO', 407, '{"type": "Cryptocurrency", "category": "Payment Network"}'::jsonb),
('DOGE', 'Dogecoin', 'crypto', 1, 'CRYPTO', 408, '{"type": "Cryptocurrency", "category": "Meme Coin"}'::jsonb),
('DOT', 'Polkadot', 'crypto', 1, 'CRYPTO', 409, '{"type": "Cryptocurrency", "category": "Layer 0"}'::jsonb),
('MATIC', 'Polygon', 'crypto', 1, 'CRYPTO', 410, '{"type": "Cryptocurrency", "category": "Layer 2"}'::jsonb),
('SHIB', 'Shiba Inu', 'crypto', 1, 'CRYPTO', 411, '{"type": "Cryptocurrency", "category": "Meme Coin"}'::jsonb),
('AVAX', 'Avalanche', 'crypto', 1, 'CRYPTO', 412, '{"type": "Cryptocurrency", "category": "Smart Contract Platform"}'::jsonb),
('UNI', 'Uniswap', 'crypto', 1, 'CRYPTO', 413, '{"type": "Cryptocurrency", "category": "DeFi"}'::jsonb),
('LINK', 'Chainlink', 'crypto', 1, 'CRYPTO', 414, '{"type": "Cryptocurrency", "category": "Oracle"}'::jsonb),
('LTC', 'Litecoin', 'crypto', 1, 'CRYPTO', 415, '{"type": "Cryptocurrency", "category": "Payment"}'::jsonb),
('ATOM', 'Cosmos', 'crypto', 1, 'CRYPTO', 416, '{"type": "Cryptocurrency", "category": "Layer 0"}'::jsonb),
('XLM', 'Stellar', 'crypto', 1, 'CRYPTO', 417, '{"type": "Cryptocurrency", "category": "Payment Network"}'::jsonb),
('BCH', 'Bitcoin Cash', 'crypto', 1, 'CRYPTO', 418, '{"type": "Cryptocurrency", "category": "Payment"}'::jsonb),
('ALGO', 'Algorand', 'crypto', 1, 'CRYPTO', 419, '{"type": "Cryptocurrency", "category": "Smart Contract Platform"}'::jsonb)

ON CONFLICT (symbol) DO UPDATE SET
  name = EXCLUDED.name,
  multiplier = EXCLUDED.multiplier,
  exchange = EXCLUDED.exchange,
  popularity_rank = EXCLUDED.popularity_rank,
  metadata = EXCLUDED.metadata,
  updated_at = NOW();

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ’± FOREX - MAJOR CURRENCY PAIRS (Already in original)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INSERT INTO public.ticker_symbols (symbol, name, asset_class, multiplier, exchange, popularity_rank, metadata) VALUES
('EURUSD', 'Euro/US Dollar', 'forex', 1, 'FOREX', 500, '{"type": "Major Pair", "pip_value": 10}'::jsonb),
('GBPUSD', 'British Pound/US Dollar', 'forex', 1, 'FOREX', 501, '{"type": "Major Pair", "pip_value": 10}'::jsonb),
('USDJPY', 'US Dollar/Japanese Yen', 'forex', 1, 'FOREX', 502, '{"type": "Major Pair", "pip_value": 10}'::jsonb),
('AUDUSD', 'Australian Dollar/US Dollar', 'forex', 1, 'FOREX', 503, '{"type": "Major Pair", "pip_value": 10}'::jsonb),
('USDCAD', 'US Dollar/Canadian Dollar', 'forex', 1, 'FOREX', 504, '{"type": "Major Pair", "pip_value": 10}'::jsonb),
('USDCHF', 'US Dollar/Swiss Franc', 'forex', 1, 'FOREX', 505, '{"type": "Major Pair", "pip_value": 10}'::jsonb),
('NZDUSD', 'New Zealand Dollar/US Dollar', 'forex', 1, 'FOREX', 506, '{"type": "Major Pair", "pip_value": 10}'::jsonb)

ON CONFLICT (symbol) DO UPDATE SET
  name = EXCLUDED.name,
  multiplier = EXCLUDED.multiplier,
  exchange = EXCLUDED.exchange,
  popularity_rank = EXCLUDED.popularity_rank,
  metadata = EXCLUDED.metadata,
  updated_at = NOW();

DO $$
DECLARE 
  ticker_count INTEGER;
  stock_count INTEGER;
  etf_count INTEGER;
  crypto_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO ticker_count FROM public.ticker_symbols;
  SELECT COUNT(*) INTO stock_count FROM public.ticker_symbols WHERE asset_class = 'stock';
  SELECT COUNT(*) INTO etf_count FROM public.ticker_symbols WHERE asset_class = 'etf';
  SELECT COUNT(*) INTO crypto_count FROM public.ticker_symbols WHERE asset_class = 'crypto';
  
  RAISE NOTICE '';
  RAISE NOTICE 'âœ… Ticker Symbols Table Created!';
  RAISE NOTICE '   ğŸ“Š Total symbols: %', ticker_count;
  RAISE NOTICE '   ğŸ“ˆ Stocks: %', stock_count;
  RAISE NOTICE '   ğŸ“Š ETFs: %', etf_count;
  RAISE NOTICE '   ğŸ’° Crypto: %', crypto_count;
  RAISE NOTICE '   ğŸ“Œ Futures: % (from original)', ticker_count - stock_count - etf_count - crypto_count;
  RAISE NOTICE '';
END $$;

GRANT SELECT ON public.ticker_symbols TO authenticated;
GRANT SELECT ON public.ticker_symbols TO anon;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- END OF SECTION 5 - Continue in next file
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ===============================================
-- CONTINUATION OF PART-1 (Sections 6-10 + RLS)
-- v9.4.3-FIXED
-- ===============================================

-- ===============================================
-- SECTION 6: ADDITIONAL TABLES (NO AFFILIATE)
-- ===============================================
-- ğŸ”§ v9.4.3: Fixed payment_history columns
-- ğŸ”§ v9.4.3: Fixed subscription_changes columns
-- ğŸ’° v9.4.4: Updated payment_provider to use WHOP!

DO $$
BEGIN
  RAISE NOTICE '[6/10] Creating additional tables (NO AFFILIATE)...';
  RAISE NOTICE '      ğŸ“Š Including SnapTrade tables...';
  RAISE NOTICE '      âŒ Skipping affiliate tables...';
  RAISE NOTICE '      ğŸ†• v9.4.3: Adding admin_actions table!';
  RAISE NOTICE '      ğŸ†• v9.4.3: Fixed payment_history columns!';
  RAISE NOTICE '      ğŸ†• v9.4.3: Fixed subscription_changes columns!';
  RAISE NOTICE '      ğŸ’° v9.4.4: Updated payment_provider to use WHOP!';
END $$;

CREATE TABLE IF NOT EXISTS public.payment_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  amount DECIMAL(10, 2) NOT NULL,
  currency TEXT NOT NULL DEFAULT 'USD',
  status TEXT NOT NULL CHECK (status IN ('pending', 'completed', 'failed', 'refunded')),
  plan TEXT NOT NULL CHECK (plan IN ('basic', 'premium', 'newsletter', 'top_secret', 'platform_core', 'platform_finotaur', 'platform_enterprise')),
  whop_transaction_id TEXT,
  invoice_url TEXT,
  payment_method TEXT,
  error_message TEXT,
  is_prorated BOOLEAN DEFAULT FALSE,
  prorated_days INTEGER,
  original_amount NUMERIC(10,2),
  discount_amount NUMERIC(10,2) DEFAULT 0,
  payment_type TEXT DEFAULT 'subscription',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ğŸ†• v9.4.3: Add missing columns to payment_history
ALTER TABLE public.payment_history ADD COLUMN IF NOT EXISTS payment_provider TEXT;
ALTER TABLE public.payment_history ADD COLUMN IF NOT EXISTS transaction_id TEXT;
ALTER TABLE public.payment_history ADD COLUMN IF NOT EXISTS metadata JSONB DEFAULT '{}'::jsonb;

-- ğŸ’° v9.4.4: Rename payplus_transaction_id to whop_transaction_id if exists
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_schema = 'public' 
      AND table_name = 'payment_history' 
      AND column_name = 'payplus_transaction_id'
  ) THEN
    ALTER TABLE public.payment_history RENAME COLUMN payplus_transaction_id TO whop_transaction_id;
    RAISE NOTICE '   âœ… Renamed payplus_transaction_id to whop_transaction_id';
  END IF;
END $$;

-- ğŸ’° v9.4.4: Make whop_transaction_id nullable (not all payments require it)
ALTER TABLE public.payment_history ALTER COLUMN whop_transaction_id DROP NOT NULL;

ALTER TABLE public.payment_history DROP CONSTRAINT IF EXISTS payment_type_check;
ALTER TABLE public.payment_history ADD CONSTRAINT payment_type_check 
CHECK (payment_type IN ('subscription', 'upgrade', 'renewal', 'refund'));

-- ğŸ’° v9.4.4: FIX existing invalid payment_provider values BEFORE adding constraint
UPDATE public.payment_history 
SET payment_provider = NULL 
WHERE payment_provider IS NOT NULL 
  AND payment_provider NOT IN ('whop', 'stripe', 'paypal');

-- ğŸ’° v9.4.4: Updated to use WHOP instead of payplus
ALTER TABLE public.payment_history DROP CONSTRAINT IF EXISTS payment_history_provider_check;
ALTER TABLE public.payment_history ADD CONSTRAINT payment_history_provider_check 
CHECK (payment_provider IN ('whop', 'stripe', 'paypal') OR payment_provider IS NULL);

COMMENT ON COLUMN public.payment_history.payment_provider IS 'v9.4.4: Payment provider used for this transaction (whop, stripe, paypal)';
COMMENT ON COLUMN public.payment_history.transaction_id IS 'v9.4.4: Generic transaction ID';
COMMENT ON COLUMN public.payment_history.whop_transaction_id IS 'v9.4.4: Whop-specific transaction ID';
COMMENT ON COLUMN public.payment_history.metadata IS 'v9.4.3: Additional payment metadata as JSON';

CREATE TABLE IF NOT EXISTS public.subscription_periods (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  plan TEXT NOT NULL CHECK (plan IN ('basic', 'premium', 'newsletter', 'top_secret', 'platform_core', 'platform_finotaur', 'platform_enterprise')),
  whop_transaction_id TEXT,
  period_start TIMESTAMPTZ NOT NULL,
  period_end TIMESTAMPTZ NOT NULL,
  auto_renew BOOLEAN DEFAULT TRUE,
  canceled_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ğŸ’° v9.4.4: Rename payplus_transaction_id to whop_transaction_id in subscription_periods
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_schema = 'public' 
      AND table_name = 'subscription_periods' 
      AND column_name = 'payplus_transaction_id'
  ) THEN
    ALTER TABLE public.subscription_periods RENAME COLUMN payplus_transaction_id TO whop_transaction_id;
    RAISE NOTICE '   âœ… Renamed payplus_transaction_id to whop_transaction_id in subscription_periods';
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS public.admin_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  action TEXT NOT NULL,
  target_user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
  target_type TEXT,
  target_id UUID,
  details JSONB DEFAULT '{}'::jsonb,
  ip_address TEXT,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.user_activity_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  action TEXT NOT NULL,
  details JSONB DEFAULT '{}'::jsonb,
  ip_address TEXT,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.broker_connections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  broker TEXT NOT NULL CHECK (broker IN (
    'interactive_brokers', 'td_ameritrade', 'alpaca', 'tradingview',
    'mt4', 'mt5', 'ninja_trader', 'manual'
  )),
  status TEXT NOT NULL DEFAULT 'disconnected' CHECK (status IN (
    'connected', 'disconnected', 'error', 'pending'
  )),
  account_id TEXT,
  account_name TEXT,
  connected_at TIMESTAMPTZ,
  last_sync_at TIMESTAMPTZ,
  error_message TEXT,
  access_token TEXT,
  refresh_token TEXT,
  expires_at TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, broker)
);

CREATE TABLE IF NOT EXISTS public.user_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID UNIQUE NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  tradingview_webhook_secret TEXT,
  alpaca_api_key TEXT,
  alpaca_api_secret TEXT,
  preferences JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.admin_impersonation_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  impersonated_user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  session_token TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '2 hours'),
  last_activity_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  is_active BOOLEAN NOT NULL DEFAULT true,
  ip_address TEXT,
  user_agent TEXT,
  impersonated_user_email TEXT,
  impersonated_user_name TEXT,
  admin_email TEXT,
  CONSTRAINT valid_session CHECK (expires_at > created_at),
  CONSTRAINT different_users CHECK (admin_id != impersonated_user_id)
);

CREATE TABLE IF NOT EXISTS public.snaptrade_activity (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  last_activity_at TIMESTAMPTZ DEFAULT NOW(),
  connection_status TEXT DEFAULT 'disconnected' CHECK (connection_status IN ('connected', 'disconnected')),
  brokerage_connection_id TEXT,
  brokerage_name TEXT,
  connected_at TIMESTAMPTZ,
  disconnected_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id)
);

CREATE TABLE IF NOT EXISTS public.api_rate_limits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  endpoint TEXT NOT NULL,
  requests_count INTEGER DEFAULT 1,
  window_start TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.subscription_changes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  change_type TEXT NOT NULL CHECK (change_type IN ('upgrade', 'downgrade', 'cancel', 'renew', 'expire', 'reactivate')),
  from_plan TEXT,
  to_plan TEXT,
  effective_date TIMESTAMPTZ NOT NULL,
  prorated_amount NUMERIC(10,2),
  prorated_days INTEGER,
  reason TEXT,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ğŸ†• v9.4.3: Add missing columns to subscription_changes
ALTER TABLE public.subscription_changes ADD COLUMN IF NOT EXISTS from_interval TEXT;
ALTER TABLE public.subscription_changes ADD COLUMN IF NOT EXISTS to_interval TEXT;

-- ğŸ†• v9.4.3: Add constraints for interval columns
ALTER TABLE public.subscription_changes DROP CONSTRAINT IF EXISTS subscription_changes_from_interval_check;
ALTER TABLE public.subscription_changes ADD CONSTRAINT subscription_changes_from_interval_check 
CHECK (from_interval IN ('monthly', 'yearly') OR from_interval IS NULL);

ALTER TABLE public.subscription_changes DROP CONSTRAINT IF EXISTS subscription_changes_to_interval_check;
ALTER TABLE public.subscription_changes ADD CONSTRAINT subscription_changes_to_interval_check 
CHECK (to_interval IN ('monthly', 'yearly') OR to_interval IS NULL);

COMMENT ON COLUMN public.subscription_changes.from_interval IS 'v9.4.3: Previous billing interval (monthly/yearly)';
COMMENT ON COLUMN public.subscription_changes.to_interval IS 'v9.4.3: New billing interval (monthly/yearly)';

CREATE TABLE IF NOT EXISTS public.pricing_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  plan TEXT NOT NULL,
  interval TEXT NOT NULL,
  price NUMERIC(10,2) NOT NULL,
  currency TEXT DEFAULT 'USD',
  features JSONB DEFAULT '{}'::jsonb,
  is_active BOOLEAN DEFAULT TRUE,
  valid_from TIMESTAMPTZ DEFAULT NOW(),
  valid_until TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(plan, interval, valid_from)
);

INSERT INTO public.pricing_config (plan, interval, price, features) VALUES
  ('basic', 'monthly', 15.99, '{"max_trades": 25, "support": "email"}'::jsonb),
  ('basic', 'yearly', 155.88, '{"max_trades": 25, "support": "email", "discount": "18%"}'::jsonb),
  ('premium', 'monthly', 24.99, '{"max_trades": "unlimited", "support": "priority", "advanced_analytics": true}'::jsonb),
  ('premium', 'yearly', 239.88, '{"max_trades": "unlimited", "support": "priority", "advanced_analytics": true, "discount": "20%"}'::jsonb)
ON CONFLICT DO NOTHING;

CREATE TABLE IF NOT EXISTS public.snaptrade_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  snaptrade_user_id TEXT NOT NULL,
  snaptrade_user_secret TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT unique_user_id UNIQUE(user_id),
  CONSTRAINT unique_snaptrade_user_id UNIQUE(snaptrade_user_id)
);

CREATE TABLE IF NOT EXISTS public.snaptrade_sync_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  sync_started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  sync_completed_at TIMESTAMPTZ,
  duration_seconds INT GENERATED ALWAYS AS (
    EXTRACT(EPOCH FROM (sync_completed_at - sync_started_at))::INT
  ) STORED,
  trades_imported INT DEFAULT 0,
  trades_skipped INT DEFAULT 0,
  trades_failed INT DEFAULT 0,
  sync_type TEXT DEFAULT 'manual',
  date_range_start DATE,
  date_range_end DATE,
  status TEXT NOT NULL DEFAULT 'running',
  error_message TEXT,
  error_details JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT check_sync_status CHECK (status IN ('running', 'completed', 'failed', 'cancelled')),
  CONSTRAINT check_sync_type CHECK (sync_type IN ('manual', 'automatic', 'scheduled')),
  CONSTRAINT check_completed_status CHECK (
    (status = 'running' AND sync_completed_at IS NULL) OR
    (status != 'running' AND sync_completed_at IS NOT NULL)
  )
);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ†• v9.4.3: Admin Actions Table (for Part 2 compatibility)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE TABLE IF NOT EXISTS public.admin_actions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  action_type TEXT NOT NULL,
  admin_id UUID REFERENCES public.profiles(id),
  resource_type TEXT,
  resource_id UUID,
  details JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_admin_actions_admin_id ON public.admin_actions(admin_id);
CREATE INDEX IF NOT EXISTS idx_admin_actions_created_at ON public.admin_actions(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_admin_actions_type ON public.admin_actions(action_type);

COMMENT ON TABLE public.admin_actions IS 'v9.4.3: Admin action audit log for Part 2 functions';

DO $$
BEGIN
  RAISE NOTICE 'âœ… [6/10] Additional tables created!';
  RAISE NOTICE '      ğŸ’° payment_provider uses WHOP!';
  RAISE NOTICE '      ğŸ’° Renamed payplus_transaction_id to whop_transaction_id';
END $$;
-- ===============================================
-- SECTION 7: STORAGE BUCKET
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[7/10] Setting up storage bucket...';
END $$;

INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'trade-screenshots',
  'trade-screenshots',
  false,
  5242880,
  ARRAY['image/jpeg', 'image/png', 'image/webp']::text[]
)
ON CONFLICT (id) DO UPDATE SET
  file_size_limit = 5242880,
  allowed_mime_types = ARRAY['image/jpeg', 'image/png', 'image/webp']::text[];

-- ===============================================
-- SECTION 8: PRODUCTION-OPTIMIZED INDEXES (NO AFFILIATE)
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[8/10] Creating production-grade indexes (NO AFFILIATE)...';
  RAISE NOTICE '      Optimized for 5000+ concurrent users';
  RAISE NOTICE '      Including payment system indexes...';
  RAISE NOTICE '      ğŸ“Š Including SnapTrade indexes...';
  RAISE NOTICE '      ğŸ¯ Including Ticker Symbols indexes...';
  RAISE NOTICE '      âŒ Skipping affiliate indexes...';
END $$;

-- Profiles indexes
CREATE INDEX IF NOT EXISTS idx_profiles_email ON public.profiles(email);
CREATE INDEX IF NOT EXISTS idx_profiles_role ON public.profiles(role);
CREATE INDEX IF NOT EXISTS idx_profiles_account_type ON public.profiles(account_type);
CREATE INDEX IF NOT EXISTS idx_profiles_subscription_status ON public.profiles(subscription_status);
CREATE INDEX IF NOT EXISTS idx_profiles_last_login ON public.profiles(last_login_at DESC);
CREATE INDEX IF NOT EXISTS idx_profiles_is_banned ON public.profiles(is_banned);
CREATE INDEX IF NOT EXISTS idx_profiles_created_recent ON public.profiles(created_at);
CREATE INDEX IF NOT EXISTS idx_profiles_total_pnl ON public.profiles(total_pnl) WHERE total_pnl IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_profiles_portfolio ON public.profiles(current_portfolio) WHERE current_portfolio IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_profiles_trade_limits ON public.profiles(account_type, current_month_trades_count, billing_cycle_start);
CREATE INDEX IF NOT EXISTS idx_profiles_not_deleted ON public.profiles(id) WHERE deleted_at IS NULL;

-- Strategies indexes
CREATE INDEX IF NOT EXISTS idx_strategies_user_id ON public.strategies(user_id);
CREATE INDEX IF NOT EXISTS idx_strategies_status ON public.strategies(status);
CREATE INDEX IF NOT EXISTS idx_strategies_not_deleted ON public.strategies(user_id) WHERE deleted_at IS NULL;

-- Trades indexes - ULTRA-OPTIMIZED
CREATE INDEX IF NOT EXISTS idx_trades_dashboard_ultimate 
ON public.trades(user_id, outcome, close_at DESC, id, symbol, pnl, rr, actual_r, open_at, stop_price, entry_price, exit_price, take_profit_price, quantity, risk_usd)
WHERE outcome IN ('WIN', 'LOSS', 'BE');

CREATE INDEX IF NOT EXISTS idx_trades_date_range_ultimate 
ON public.trades(user_id, close_at DESC, id, symbol, pnl, rr, actual_r, open_at, stop_price, entry_price, exit_price, take_profit_price, quantity, risk_usd)
WHERE outcome != 'OPEN';

CREATE INDEX IF NOT EXISTS idx_trades_user_open 
ON public.trades(user_id, open_at DESC, id, symbol, side, entry_price, stop_price, take_profit_price, quantity, risk_pts, reward_pts, rr, risk_usd, reward_usd)
WHERE outcome = 'OPEN';

CREATE INDEX IF NOT EXISTS idx_trades_user_symbol_date 
ON public.trades(user_id, symbol, close_at DESC)
WHERE outcome != 'OPEN';

CREATE INDEX IF NOT EXISTS idx_trades_user_strategy_outcome 
ON public.trades(user_id, strategy_id, outcome, close_at DESC)
WHERE strategy_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_user_r_analysis 
ON public.trades(user_id, actual_r, outcome, close_at)
WHERE actual_r IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_strategy_id ON public.trades(strategy_id);
CREATE INDEX IF NOT EXISTS idx_trades_broker ON public.trades(broker);
CREATE INDEX IF NOT EXISTS idx_trades_multiplier ON public.trades(multiplier);

CREATE UNIQUE INDEX IF NOT EXISTS idx_trades_external_id_not_null 
ON public.trades(user_id, broker, external_id) 
WHERE external_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_not_deleted 
ON public.trades(user_id, id) WHERE deleted_at IS NULL;

CREATE UNIQUE INDEX IF NOT EXISTS idx_trades_snaptrade_activity_id 
ON public.trades(snaptrade_activity_id) 
WHERE snaptrade_activity_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_snaptrade_account_id 
ON public.trades(snaptrade_account_id)
WHERE snaptrade_account_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_import_source 
ON public.trades(import_source);

CREATE INDEX IF NOT EXISTS idx_trades_imported_at 
ON public.trades(imported_at DESC)
WHERE imported_at IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_user_import_source 
ON public.trades(user_id, import_source, imported_at DESC);

CREATE INDEX IF NOT EXISTS idx_trades_notes_search 
ON public.trades USING GIN(notes_search_vector);

CREATE INDEX IF NOT EXISTS idx_trades_notes_not_null 
ON public.trades(user_id, id) 
WHERE notes IS NOT NULL AND notes != '';

CREATE INDEX IF NOT EXISTS idx_trades_screenshot_not_null 
ON public.trades(user_id, id) 
WHERE screenshot_url IS NOT NULL AND screenshot_url != '';

-- TradingView webhook indexes
CREATE INDEX IF NOT EXISTS idx_user_settings_webhook_lookup 
ON public.user_settings(user_id) 
INCLUDE (tradingview_webhook_secret)
WHERE tradingview_webhook_secret IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_trades_webhook_lookup 
ON public.trades(user_id, symbol, side, open_at DESC) 
WHERE close_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_trades_close_lookup 
ON public.trades(user_id, symbol, side, close_at, open_at DESC)
WHERE close_at IS NULL AND broker = 'tradingview';

CREATE INDEX IF NOT EXISTS idx_trades_user_exit_pnl 
ON public.trades(user_id, exit_price) 
WHERE exit_price IS NOT NULL;

-- Payment & Subscriptions indexes
CREATE INDEX IF NOT EXISTS idx_payment_history_user_id ON public.payment_history(user_id);
CREATE INDEX IF NOT EXISTS idx_payment_history_status ON public.payment_history(status);
CREATE INDEX IF NOT EXISTS idx_subscription_periods_user_id ON public.subscription_periods(user_id);
CREATE INDEX IF NOT EXISTS idx_subscription_periods_active ON public.subscription_periods(user_id, period_end);

CREATE INDEX IF NOT EXISTS idx_payment_history_type 
ON public.payment_history(payment_type, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_payment_history_prorated 
ON public.payment_history(is_prorated, created_at DESC) 
WHERE is_prorated = TRUE;

-- ğŸ†• v9.4.3: Index for payment_provider
CREATE INDEX IF NOT EXISTS idx_payment_history_provider
ON public.payment_history(payment_provider)
WHERE payment_provider IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_subscription_changes_user_id 
ON public.subscription_changes(user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_subscription_changes_type 
ON public.subscription_changes(change_type, created_at DESC);

-- ğŸ†• v9.4.3: Index for interval columns
CREATE INDEX IF NOT EXISTS idx_subscription_changes_intervals
ON public.subscription_changes(from_interval, to_interval);

CREATE INDEX IF NOT EXISTS idx_pricing_config_active 
ON public.pricing_config(plan, interval) WHERE is_active = TRUE;

-- Admin & Activity indexes
CREATE INDEX IF NOT EXISTS idx_admin_audit_admin_id ON public.admin_audit_log(admin_id);
CREATE INDEX IF NOT EXISTS idx_admin_audit_created_at ON public.admin_audit_log(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_user_activity_user_id ON public.user_activity_log(user_id);
CREATE INDEX IF NOT EXISTS idx_user_activity_created_at ON public.user_activity_log(created_at DESC);

-- Broker & Settings indexes
CREATE INDEX IF NOT EXISTS idx_broker_connections_user_id ON public.broker_connections(user_id);
CREATE INDEX IF NOT EXISTS idx_broker_connections_status ON public.broker_connections(status);
CREATE INDEX IF NOT EXISTS idx_user_settings_user_id ON public.user_settings(user_id);

-- Impersonation indexes
CREATE INDEX IF NOT EXISTS idx_impersonation_admin_id ON public.admin_impersonation_sessions(admin_id);
CREATE INDEX IF NOT EXISTS idx_impersonation_token ON public.admin_impersonation_sessions(session_token);
CREATE INDEX IF NOT EXISTS idx_impersonation_active ON public.admin_impersonation_sessions(is_active) WHERE is_active = true;

-- SnapTrade indexes
CREATE INDEX IF NOT EXISTS idx_snaptrade_activity_user_id ON public.snaptrade_activity(user_id);
CREATE INDEX IF NOT EXISTS idx_snaptrade_activity_status ON public.snaptrade_activity(connection_status);

CREATE INDEX IF NOT EXISTS idx_snaptrade_users_user_id ON public.snaptrade_users(user_id);
CREATE INDEX IF NOT EXISTS idx_snaptrade_users_snaptrade_user_id ON public.snaptrade_users(snaptrade_user_id);
CREATE INDEX IF NOT EXISTS idx_snaptrade_users_created_at ON public.snaptrade_users(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_user_id ON public.snaptrade_sync_log(user_id);
CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_status ON public.snaptrade_sync_log(status);
CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_created_at ON public.snaptrade_sync_log(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_completed_at ON public.snaptrade_sync_log(sync_completed_at DESC)
WHERE sync_completed_at IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_user_status ON public.snaptrade_sync_log(user_id, status, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_snaptrade_sync_log_user_sync_type ON public.snaptrade_sync_log(user_id, sync_type, created_at DESC);

-- Rate limiting indexes
CREATE INDEX IF NOT EXISTS idx_rate_limits_window 
ON public.api_rate_limits(user_id, endpoint, window_start);

CREATE INDEX IF NOT EXISTS idx_rate_limits_cleanup
ON public.api_rate_limits(window_start);

-- Analyze tables
ANALYZE public.profiles;
ANALYZE public.trades;
ANALYZE public.strategies;
ANALYZE public.broker_connections;
ANALYZE public.snaptrade_activity;
ANALYZE public.api_rate_limits;
ANALYZE public.payment_history;
ANALYZE public.subscription_changes;
ANALYZE public.pricing_config;
ANALYZE public.snaptrade_users;
ANALYZE public.snaptrade_sync_log;
ANALYZE public.ticker_symbols;
ANALYZE public.admin_actions;

-- ===============================================
-- SECTION 9: ENABLE RLS
-- ===============================================

DO $$
BEGIN
  RAISE NOTICE '[9/10] Enabling RLS...';
  RAISE NOTICE '      ğŸ“Š Including SnapTrade tables...';
  RAISE NOTICE '      ğŸ¯ Including Ticker Symbols...';
  RAISE NOTICE '      ğŸ†• v9.4.3: Including admin_actions table...';
  RAISE NOTICE '      âŒ No affiliate tables...';
END $$;

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.strategies ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.trades ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.payment_history ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.subscription_periods ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admin_audit_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_activity_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.broker_connections ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admin_impersonation_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.snaptrade_activity ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.api_rate_limits ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.subscription_changes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.pricing_config ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.snaptrade_users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.snaptrade_sync_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ticker_symbols ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admin_actions ENABLE ROW LEVEL SECURITY;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”§ SECTION 9.5: HELPER FUNCTIONS FOR RLS (REQUIRED!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- These functions are REQUIRED by RLS policies in Section 10
-- Part 2 uses CREATE OR REPLACE to safely update them if needed
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
BEGIN
  RAISE NOTICE '[9.5/10] Creating helper functions for RLS...';
  RAISE NOTICE '      ğŸ”§ get_trade_limit() - returns limit by plan';
  RAISE NOTICE '      ğŸ”§ can_create_trade() - checks if user can create trade';
  RAISE NOTICE '      ğŸ”§ get_remaining_trades() - returns remaining trades info';
END $$;
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“Š get_trade_limit - Returns trade limit based on account type
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- ğŸ”¥ FIX: Drop existing function first (parameter name conflict)
DROP FUNCTION IF EXISTS public.get_trade_limit(TEXT) CASCADE;

CREATE OR REPLACE FUNCTION public.get_trade_limit(plan_type TEXT)
RETURNS INTEGER
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
RETURN CASE LOWER(COALESCE(plan_type, 'basic'))
  WHEN 'basic' THEN 25
  WHEN 'premium' THEN 999999
  WHEN 'admin' THEN 999999
  WHEN 'vip' THEN 999999
  ELSE 25  -- Default = basic
  END;
END;
$$;

GRANT EXECUTE ON FUNCTION public.get_trade_limit(TEXT) TO authenticated;
GRANT EXECUTE ON FUNCTION public.get_trade_limit(TEXT) TO service_role;

COMMENT ON FUNCTION public.get_trade_limit IS 
'v9.4.3: Returns trade limit based on account type. FREE=10 lifetime, BASIC/TRIAL=25/month, PREMIUM=unlimited.';

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”’ can_create_trade - Checks if user is under their trade limit
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DROP FUNCTION IF EXISTS public.can_create_trade(UUID) CASCADE;


CREATE OR REPLACE FUNCTION public.can_create_trade(user_id_param UUID)
RETURNS BOOLEAN 
LANGUAGE plpgsql
SECURITY DEFINER
STABLE
SET search_path = public
AS $$
DECLARE
  v_profile RECORD;
  v_limit INTEGER;
  v_trades_used INTEGER;
BEGIN
  SELECT 
    account_type,
    role,
    subscription_status,
    COALESCE(is_in_trial, FALSE) as is_in_trial,
    trial_ends_at,
    subscription_expires_at,
    COALESCE(current_month_trades_count, 0) as monthly_trades
  INTO v_profile
  FROM public.profiles
  WHERE id = user_id_param;
  
  IF NOT FOUND THEN
    RETURN FALSE;
  END IF;
  
  -- Admins = unlimited (by role)
  IF v_profile.role IN ('admin', 'super_admin') THEN
    RETURN TRUE;
  END IF;
  
  -- Admin/VIP = unlimited (by account_type)
  IF v_profile.account_type IN ('admin', 'vip') THEN
    RETURN TRUE;
  END IF;
  
  -- Premium = unlimited (if subscription active)
  IF v_profile.account_type = 'premium' THEN
    IF v_profile.subscription_status IN ('active', 'trial') THEN
      RETURN TRUE;
    END IF;
    IF v_profile.subscription_status IN ('expired', 'cancelled') THEN
      IF v_profile.subscription_expires_at IS NOT NULL 
         AND v_profile.subscription_expires_at > NOW() THEN
        RETURN TRUE;
      END IF;
      RETURN FALSE;
    END IF;
    RETURN TRUE;
  END IF;
  
  -- Basic users - check subscription status AND limits
  IF v_profile.account_type = 'basic' THEN
    -- Check if subscription expired (must pay)
    IF v_profile.subscription_status = 'expired' THEN
      RETURN FALSE;
    END IF;
    
    -- Check if trial expired (must pay)
    IF v_profile.subscription_status = 'trial' OR v_profile.is_in_trial THEN
      IF v_profile.trial_ends_at IS NOT NULL AND v_profile.trial_ends_at < NOW() THEN
        RETURN FALSE;
      END IF;
    END IF;
    
    -- Check cancelled subscription
    IF v_profile.subscription_status = 'cancelled' THEN
      IF v_profile.subscription_expires_at IS NULL 
         OR v_profile.subscription_expires_at < NOW() THEN
        RETURN FALSE;
      END IF;
    END IF;
    
    -- Check monthly trade limit
    v_limit := 25;
    v_trades_used := v_profile.monthly_trades;
    RETURN v_trades_used < v_limit;
  END IF;
  
  -- Default: treat unknown as basic trial
  RETURN v_profile.monthly_trades < 25;
END;
$$;

GRANT EXECUTE ON FUNCTION public.can_create_trade(UUID) TO authenticated;
GRANT EXECUTE ON FUNCTION public.can_create_trade(UUID) TO service_role;

COMMENT ON FUNCTION public.can_create_trade IS 
'v9.4.3-SECURE: Checks if user can create a trade based on their plan limits. Used by RLS policy for INSERT enforcement.';

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“Š get_remaining_trades - Returns remaining trades info
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE OR REPLACE FUNCTION public.get_remaining_trades(user_id_param UUID)
RETURNS TABLE (
  remaining INTEGER,
  used INTEGER,
  max_limit INTEGER,
  can_create BOOLEAN,
  account_type TEXT,
  is_in_trial BOOLEAN,
  trial_days_remaining INTEGER,
  needs_subscription BOOLEAN
)
LANGUAGE plpgsql
SECURITY DEFINER
STABLE
SET search_path = public
AS $$
DECLARE
  v_profile RECORD;
  v_limit INTEGER;
  v_trades_used INTEGER;
  v_trial_days INTEGER;
  v_needs_sub BOOLEAN;
BEGIN
  SELECT 
    p.account_type,
    p.role,
    p.subscription_status,
    p.is_in_trial,
    p.trial_ends_at,
    COALESCE(p.current_month_trades_count, 0) as monthly_trades
  INTO v_profile
  FROM public.profiles p
  WHERE p.id = user_id_param;
  
  -- âœ… FIXED: User not found - return 'none', not 'free'
  -- User not found - return basic defaults
  IF NOT FOUND THEN
    RETURN QUERY SELECT 
      0::INTEGER,
      0::INTEGER,
      25::INTEGER,  -- Default to basic limit
      FALSE,
      'basic'::TEXT,
      FALSE,
      NULL::INTEGER,
      TRUE;  -- needs_subscription = true
    RETURN;
  END IF;
  v_limit := public.get_trade_limit(v_profile.account_type);
  
  -- âœ… FIXED: All plans use monthly trades
  v_trades_used := v_profile.monthly_trades;
  
  -- Calculate trial days
  IF v_profile.is_in_trial AND v_profile.trial_ends_at IS NOT NULL THEN
    v_trial_days := GREATEST(0, EXTRACT(DAY FROM v_profile.trial_ends_at - NOW())::INTEGER);
  ELSE
    v_trial_days := NULL;
  END IF;
  
  -- Check if needs subscription
  v_needs_sub := (
    v_profile.subscription_status IS NULL OR
    v_profile.subscription_status IN ('expired', 'cancelled') OR
    v_profile.account_type IS NULL
  );
  
  -- Premium/Admin = unlimited
  IF v_profile.role IN ('admin', 'super_admin') OR v_profile.account_type IN ('premium', 'admin', 'vip') THEN
    RETURN QUERY SELECT 
      999999::INTEGER,
      v_trades_used::INTEGER,
      999999::INTEGER,
      TRUE,
      v_profile.account_type::TEXT,
      COALESCE(v_profile.is_in_trial, FALSE),
      v_trial_days,
      FALSE;
    RETURN;
  END IF;
  
  -- Basic/Trial users
  RETURN QUERY SELECT 
    GREATEST(0, v_limit - v_trades_used)::INTEGER,
    v_trades_used::INTEGER,
    v_limit::INTEGER,
    (v_trades_used < v_limit AND NOT v_needs_sub),
    COALESCE(v_profile.account_type, 'none')::TEXT,
    COALESCE(v_profile.is_in_trial, FALSE),
    v_trial_days,
    v_needs_sub;
END;
$$;

GRANT EXECUTE ON FUNCTION public.get_remaining_trades(UUID) TO authenticated;
GRANT EXECUTE ON FUNCTION public.get_remaining_trades(UUID) TO service_role;

COMMENT ON FUNCTION public.get_remaining_trades IS 
'v9.4.3: Returns detailed trade limit info for a user including remaining, used, max, and can_create flag.';

DO $$
BEGIN
  RAISE NOTICE 'âœ… [9.5/10] Helper functions for RLS created!';
  RAISE NOTICE '      âœ… get_trade_limit()';
  RAISE NOTICE '      âœ… can_create_trade()';
  RAISE NOTICE '      âœ… get_remaining_trades()';
END $$;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”§ SECTION 9.6: ANTI-RECURSION HELPER FUNCTIONS (v9.4.3-FIX!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Uses PUBLIC schema with SECURITY DEFINER to bypass RLS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—';
  RAISE NOTICE 'â•‘  ğŸ”§ SECTION 9.6: ANTI-RECURSION FIX   â•‘';
  RAISE NOTICE 'â•‘     rls_check_admin() - bypasses RLS  â•‘';
  RAISE NOTICE 'â•‘     rls_check_admin_mode() - flag     â•‘';
  RAISE NOTICE 'â•‘     ğŸ“ Uses PUBLIC schema (not auth)  â•‘';
  RAISE NOTICE 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
  RAISE NOTICE '';
END $$;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ” rls_check_admin() - Bypasses RLS to check admin status
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- SECURITY DEFINER = runs as function creator (postgres superuser)
-- This bypasses RLS because superuser has BYPASSRLS privilege
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DROP FUNCTION IF EXISTS public.rls_check_admin() CASCADE;

CREATE OR REPLACE FUNCTION public.rls_check_admin()
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
STABLE
SET search_path = public
AS $$
DECLARE
  v_role TEXT;
  v_banned BOOLEAN;
BEGIN
  -- Direct query - SECURITY DEFINER means this runs as postgres user
  -- which bypasses RLS
  SELECT role, COALESCE(is_banned, false)
  INTO v_role, v_banned
  FROM public.profiles
  WHERE id = auth.uid();
  
  -- Not found = not admin
  IF NOT FOUND THEN
    RETURN FALSE;
  END IF;
  
  -- Banned = not admin
  IF v_banned THEN
    RETURN FALSE;
  END IF;
  
  -- Check role
  RETURN v_role IN ('admin', 'super_admin');
END;
$$;

-- Revoke from public, grant only to authenticated
REVOKE ALL ON FUNCTION public.rls_check_admin() FROM PUBLIC;
GRANT EXECUTE ON FUNCTION public.rls_check_admin() TO authenticated;
GRANT EXECUTE ON FUNCTION public.rls_check_admin() TO service_role;

COMMENT ON FUNCTION public.rls_check_admin() IS 
'v9.4.3: SECURITY DEFINER function that checks admin status. Bypasses RLS to prevent infinite recursion in policies.';

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ” rls_check_admin_mode() - Checks admin mode setting
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DROP FUNCTION IF EXISTS public.rls_check_admin_mode() CASCADE;

CREATE OR REPLACE FUNCTION public.rls_check_admin_mode()
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY INVOKER
AS $$
  SELECT COALESCE(current_setting('app.admin_mode', true), '') = 'true';
$$;

GRANT EXECUTE ON FUNCTION public.rls_check_admin_mode() TO authenticated;
GRANT EXECUTE ON FUNCTION public.rls_check_admin_mode() TO service_role;

COMMENT ON FUNCTION public.rls_check_admin_mode() IS 
'v9.4.3: Checks if admin_mode flag is set to true for current transaction.';

DO $$
BEGIN
  RAISE NOTICE 'âœ… [9.5/10] Anti-recursion helper functions created!';
  RAISE NOTICE '      âœ… public.rls_check_admin() - SECURITY DEFINER';
  RAISE NOTICE '      âœ… public.rls_check_admin_mode() - checks flag';
  RAISE NOTICE '      ğŸ”§ v9.4.3: get_trade_limit, can_create_trade -> Part 2';
END $$;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”¥ SECTION 10: RLS POLICIES (v9.4.3-SIMPLIFIED!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- Uses rls_check_admin() instead of auth.is_admin()
-- v9.4.3: Trade limits enforced via TRIGGER, not RLS policy!
-- v9.4.3: Simplified INSERT policy - just checks user_id
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—';
  RAISE NOTICE 'â•‘  ğŸ”¥ SECTION 10: RLS POLICIES v9.4.3  â•‘';
  RAISE NOTICE 'â•‘     NO RECURSION - FIXED!             â•‘';
  RAISE NOTICE 'â•‘     Uses rls_check_admin()            â•‘';
  RAISE NOTICE 'â•‘     ğŸ”§ SIMPLIFIED INSERT POLICY!      â•‘';
  RAISE NOTICE 'â•‘     ğŸ”§ Trade limits via TRIGGER!      â•‘';
  RAISE NOTICE 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
  RAISE NOTICE '';
END $$;

-- DROP ALL EXISTING POLICIES
DO $$
DECLARE
  pol record;
BEGIN
  RAISE NOTICE 'ğŸ”¥ Dropping all existing RLS policies...';
  FOR pol IN 
    SELECT DISTINCT tablename, policyname
    FROM pg_policies 
    WHERE schemaname = 'public'
  LOOP
    BEGIN
      EXECUTE format('DROP POLICY IF EXISTS %I ON public.%I CASCADE', 
        pol.policyname, pol.tablename);
    EXCEPTION WHEN OTHERS THEN
      NULL;
    END;
  END LOOP;
  RAISE NOTICE 'âœ… All policies dropped';
END $$;

-- Drop storage policies
DROP POLICY IF EXISTS "Users can upload trade screenshots" ON storage.objects;
DROP POLICY IF EXISTS "Users can view own trade screenshots" ON storage.objects;
DROP POLICY IF EXISTS "Users can update own trade screenshots" ON storage.objects;
DROP POLICY IF EXISTS "Users can delete own trade screenshots" ON storage.objects;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“‹ PROFILES POLICIES (NO RECURSION!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'ğŸ“‹ Creating PROFILES policies (NO RECURSION!)...';
  RAISE NOTICE '   ğŸ”¥ Using rls_check_admin() to prevent infinite loops';
END $$;

-- SELECT Policy - Uses rls_check_admin() to avoid recursion!
CREATE POLICY "profiles_select_policy"
ON public.profiles
FOR SELECT
TO authenticated
USING (
  id = auth.uid()
  OR (public.rls_check_admin() AND public.rls_check_admin_mode())
);

COMMENT ON POLICY "profiles_select_policy" ON public.profiles IS 
'v9.4.3-NO-RECURSION: Users see own profile. Admins see all via rls_check_admin() which bypasses RLS.';

-- INSERT Policy
CREATE POLICY "profiles_insert_policy"
ON public.profiles
FOR INSERT
TO authenticated
WITH CHECK (
  id = auth.uid()
  AND (account_type IS NULL OR account_type IN ('free', 'platform_free', 'basic', 'trial'))
);

-- UPDATE Policy for own profile
CREATE POLICY "profiles_update_own_policy"
ON public.profiles
FOR UPDATE
TO authenticated
USING (id = auth.uid())
WITH CHECK (id = auth.uid());

-- UPDATE Policy for admins
CREATE POLICY "profiles_admin_update_policy"
ON public.profiles
FOR UPDATE
TO authenticated
USING (public.rls_check_admin() AND public.rls_check_admin_mode())
WITH CHECK (public.rls_check_admin() AND public.rls_check_admin_mode());

-- DELETE Policy (forbidden)
CREATE POLICY "profiles_delete_policy"
ON public.profiles
FOR DELETE
TO authenticated
USING (false);

DO $$
BEGIN
  RAISE NOTICE 'âœ… Profiles policies created (5 policies - NO RECURSION!)';
END $$;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“Š TRADES POLICIES (v9.4.3-SIMPLIFIED!)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”§ v9.4.3: INSERT policy simplified - no function dependency!
-- ğŸ”§ v9.4.3: Trade limits will be enforced via TRIGGER in Part 2!
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'ğŸ“Š Creating TRADES policies...';
  RAISE NOTICE '   ğŸ”§ INSERT policy uses can_create_trade() for limits!';
END $$;

CREATE POLICY "trades_select_unified"
ON public.trades
FOR SELECT
TO authenticated
USING (
  user_id = auth.uid()
  OR (public.rls_check_admin() AND public.rls_check_admin_mode())
);

-- ğŸ”§ v9.4.3: Uses can_create_trade() which is defined in Section 9.5
CREATE POLICY "trades_insert_with_limits"
ON public.trades
FOR INSERT
TO authenticated
WITH CHECK (
  user_id = auth.uid()
  AND (SELECT public.can_create_trade(auth.uid())) = TRUE
);

COMMENT ON POLICY "trades_insert_with_limits" ON public.trades IS 
'v9.4.3: Enforces trade limits via can_create_trade() function. FREE=10 lifetime, BASIC=25/month, PREMIUM=unlimited.';

CREATE POLICY "trades_insert_service_role"
ON public.trades
FOR INSERT
TO service_role
WITH CHECK (true);

CREATE POLICY "trades_update_own"
ON public.trades
FOR UPDATE
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

CREATE POLICY "trades_delete_own"
ON public.trades
FOR DELETE
TO authenticated
USING (user_id = auth.uid());

DO $$
BEGIN
  RAISE NOTICE 'âœ… Trades policies created (SIMPLIFIED - no function dependency!)';
END $$;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ¯ STRATEGIES POLICIES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE POLICY "strategies_select_own"
ON public.strategies
FOR SELECT
TO authenticated
USING (
  user_id = auth.uid()
  OR (public.rls_check_admin() AND public.rls_check_admin_mode())
);

CREATE POLICY "strategies_insert_own"
ON public.strategies
FOR INSERT
TO authenticated
WITH CHECK (user_id = auth.uid());

CREATE POLICY "strategies_update_own"
ON public.strategies
FOR UPDATE
TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

CREATE POLICY "strategies_delete_own"
ON public.strategies
FOR DELETE
TO authenticated
USING (user_id = auth.uid());

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“¦ OTHER TABLES POLICIES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE POLICY "payment_own" ON public.payment_history 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

CREATE POLICY "subscription_own" ON public.subscription_periods 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

CREATE POLICY "audit_read_only" ON public.admin_audit_log 
FOR SELECT TO authenticated
USING (false);

CREATE POLICY "activity_own" ON public.user_activity_log 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

CREATE POLICY "broker_own" ON public.broker_connections 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

CREATE POLICY "settings_own" ON public.user_settings 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

CREATE POLICY "impersonation_own" ON public.admin_impersonation_sessions 
FOR SELECT TO authenticated
USING (admin_id = auth.uid());

CREATE POLICY "snaptrade_own" ON public.snaptrade_activity 
FOR ALL TO authenticated
USING (user_id = auth.uid()) 
WITH CHECK (user_id = auth.uid());

CREATE POLICY "rate_limits_own" ON public.api_rate_limits
FOR ALL TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

CREATE POLICY "subscription_changes_own"
ON public.subscription_changes 
FOR SELECT TO authenticated
USING (user_id = auth.uid());

CREATE POLICY "pricing_public"
ON public.pricing_config 
FOR SELECT TO authenticated
USING (is_active = TRUE);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“Š SNAPTRADE TABLES POLICIES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE POLICY "snaptrade_users_select_own"
ON public.snaptrade_users
FOR SELECT TO authenticated
USING (user_id = auth.uid());

CREATE POLICY "snaptrade_users_insert_own"
ON public.snaptrade_users
FOR INSERT TO authenticated
WITH CHECK (user_id = auth.uid());

CREATE POLICY "snaptrade_users_update_own"
ON public.snaptrade_users
FOR UPDATE TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

CREATE POLICY "snaptrade_users_delete_own"
ON public.snaptrade_users
FOR DELETE TO authenticated
USING (user_id = auth.uid());

CREATE POLICY "snaptrade_sync_log_select_own"
ON public.snaptrade_sync_log
FOR SELECT TO authenticated
USING (user_id = auth.uid());

CREATE POLICY "snaptrade_sync_log_insert_own"
ON public.snaptrade_sync_log
FOR INSERT TO authenticated
WITH CHECK (user_id = auth.uid());

CREATE POLICY "snaptrade_sync_log_update_own"
ON public.snaptrade_sync_log
FOR UPDATE TO authenticated
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ¯ TICKER SYMBOLS POLICIES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE POLICY "ticker_symbols_public_read"
ON public.ticker_symbols
FOR SELECT TO authenticated
USING (is_active = TRUE);

CREATE POLICY "ticker_symbols_anon_read"
ON public.ticker_symbols
FOR SELECT TO anon
USING (is_active = TRUE);

CREATE POLICY "ticker_symbols_admin_only"
ON public.ticker_symbols
FOR ALL TO authenticated
USING (false)
WITH CHECK (false);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ†• v9.4.3: ADMIN ACTIONS POLICIES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE POLICY "admin_actions_admin_only" ON public.admin_actions
FOR ALL TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.profiles 
    WHERE id = auth.uid() 
    AND role IN ('admin', 'super_admin')
  )
);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”’ v9.4.4: RLS FOR ADDITIONAL TABLES (Supabase Linter Fix)
-- user_subscriptions, monthly_usage_tracking,
-- user_notifications, usage_tracking
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- 1. user_subscriptions
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.tables
    WHERE table_schema = 'public' AND table_name = 'user_subscriptions'
  ) THEN
    ALTER TABLE public.user_subscriptions ENABLE ROW LEVEL SECURITY;
    
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'user_subscriptions' AND policyname = 'users_read_own_subscriptions') THEN
      CREATE POLICY "users_read_own_subscriptions"
        ON public.user_subscriptions FOR SELECT
        TO authenticated
        USING (user_id = auth.uid());
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'user_subscriptions' AND policyname = 'service_role_all_subscriptions') THEN
      CREATE POLICY "service_role_all_subscriptions"
        ON public.user_subscriptions FOR ALL
        TO service_role
        USING (true) WITH CHECK (true);
    END IF;
    
    RAISE NOTICE 'âœ… RLS enabled: user_subscriptions';
  ELSE
    RAISE NOTICE 'â­ï¸  Skipped: user_subscriptions (table not found)';
  END IF;
END $$;

-- 2. monthly_usage_tracking
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.tables
    WHERE table_schema = 'public' AND table_name = 'monthly_usage_tracking'
  ) THEN
    ALTER TABLE public.monthly_usage_tracking ENABLE ROW LEVEL SECURITY;
    
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'monthly_usage_tracking' AND policyname = 'users_read_own_monthly_usage') THEN
      CREATE POLICY "users_read_own_monthly_usage"
        ON public.monthly_usage_tracking FOR SELECT
        TO authenticated
        USING (user_id = auth.uid());
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'monthly_usage_tracking' AND policyname = 'service_role_all_monthly_usage') THEN
      CREATE POLICY "service_role_all_monthly_usage"
        ON public.monthly_usage_tracking FOR ALL
        TO service_role
        USING (true) WITH CHECK (true);
    END IF;
    
    RAISE NOTICE 'âœ… RLS enabled: monthly_usage_tracking';
  ELSE
    RAISE NOTICE 'â­ï¸  Skipped: monthly_usage_tracking (table not found)';
  END IF;
END $$;

-- 3. user_notifications
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.tables
    WHERE table_schema = 'public' AND table_name = 'user_notifications'
  ) THEN
    ALTER TABLE public.user_notifications ENABLE ROW LEVEL SECURITY;
    
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'user_notifications' AND policyname = 'users_read_own_notifications') THEN
      CREATE POLICY "users_read_own_notifications"
        ON public.user_notifications FOR SELECT
        TO authenticated
        USING (user_id = auth.uid());
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'user_notifications' AND policyname = 'users_update_own_notifications') THEN
      CREATE POLICY "users_update_own_notifications"
        ON public.user_notifications FOR UPDATE
        TO authenticated
        USING (user_id = auth.uid());
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'user_notifications' AND policyname = 'service_role_all_notifications') THEN
      CREATE POLICY "service_role_all_notifications"
        ON public.user_notifications FOR ALL
        TO service_role
        USING (true) WITH CHECK (true);
    END IF;
    
    RAISE NOTICE 'âœ… RLS enabled: user_notifications';
  ELSE
    RAISE NOTICE 'â­ï¸  Skipped: user_notifications (table not found)';
  END IF;
END $$;

-- 4. usage_tracking
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.tables
    WHERE table_schema = 'public' AND table_name = 'usage_tracking'
  ) THEN
    ALTER TABLE public.usage_tracking ENABLE ROW LEVEL SECURITY;
    
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'usage_tracking' AND policyname = 'users_read_own_tracking') THEN
      CREATE POLICY "users_read_own_tracking"
        ON public.usage_tracking FOR SELECT
        TO authenticated
        USING (user_id = auth.uid());
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'usage_tracking' AND policyname = 'service_role_all_tracking') THEN
      CREATE POLICY "service_role_all_tracking"
        ON public.usage_tracking FOR ALL
        TO service_role
        USING (true) WITH CHECK (true);
    END IF;
    
    RAISE NOTICE 'âœ… RLS enabled: usage_tracking';
  ELSE
    RAISE NOTICE 'â­ï¸  Skipped: usage_tracking (table not found)';
  END IF;
END $$;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ“¸ STORAGE POLICIES
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE POLICY "Users can upload trade screenshots" ON storage.objects 
FOR INSERT TO authenticated
WITH CHECK (
  bucket_id = 'trade-screenshots' 
  AND (storage.foldername(name))[1] = auth.uid()::text
);

CREATE POLICY "Users can view own trade screenshots" ON storage.objects 
FOR SELECT TO authenticated
USING (
  bucket_id = 'trade-screenshots' 
  AND (storage.foldername(name))[1] = auth.uid()::text
);

CREATE POLICY "Users can update own trade screenshots" ON storage.objects 
FOR UPDATE TO authenticated
USING (
  bucket_id = 'trade-screenshots' 
  AND (storage.foldername(name))[1] = auth.uid()::text
)
WITH CHECK (
  bucket_id = 'trade-screenshots' 
  AND (storage.foldername(name))[1] = auth.uid()::text
);

CREATE POLICY "Users can delete own trade screenshots" ON storage.objects 
FOR DELETE TO authenticated
USING (
  bucket_id = 'trade-screenshots' 
  AND (storage.foldername(name))[1] = auth.uid()::text
);

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ” enable_admin_mode() - Required for admin impersonation
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE OR REPLACE FUNCTION public.enable_admin_mode()
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  IF NOT public.rls_check_admin() THEN
    RAISE EXCEPTION 'Admin access required';
  END IF;
  
  PERFORM set_config('app.admin_mode', 'true', true);
END;
$$;

GRANT EXECUTE ON FUNCTION public.enable_admin_mode() TO authenticated;
GRANT EXECUTE ON FUNCTION public.enable_admin_mode() TO service_role;

COMMENT ON FUNCTION public.enable_admin_mode() IS 
'v9.4.3: Enables admin mode for the current transaction. Required for admin impersonation.';

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ” VERIFICATION
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
DECLARE 
  profiles_count INTEGER;
  trades_count INTEGER;
  rls_check_admin_exists BOOLEAN;
BEGIN
  SELECT COUNT(*) INTO profiles_count
  FROM pg_policies WHERE schemaname = 'public' AND tablename = 'profiles';
  
  SELECT COUNT(*) INTO trades_count
  FROM pg_policies WHERE schemaname = 'public' AND tablename = 'trades';
  
  SELECT EXISTS (
    SELECT 1 FROM pg_proc WHERE proname = 'rls_check_admin'
  ) INTO rls_check_admin_exists;
  
  RAISE NOTICE '';
  RAISE NOTICE 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—';
  RAISE NOTICE 'â•‘  âœ… SECTION 10 COMPLETE! (v9.4.3)     â•‘';
  RAISE NOTICE 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
  RAISE NOTICE '';
  RAISE NOTICE 'ğŸ“Š Profiles policies: %', profiles_count;
  RAISE NOTICE 'ğŸ“Š Trades policies: %', trades_count;
  RAISE NOTICE 'ğŸ” rls_check_admin(): %', CASE WHEN rls_check_admin_exists THEN 'âœ…' ELSE 'âŒ' END;
  RAISE NOTICE '';
END $$;
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- ğŸ”¥ ADMIN SETUP - Set specific user as Super Admin
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DO $$
DECLARE
  v_admin_email TEXT := 'elad2550@gmail.com';  -- ğŸ‘ˆ ×©× ×” ×œ××™××™×™×œ ×©×œ×š!
  v_admin_id UUID;
BEGIN
  -- Find user by email
  SELECT id INTO v_admin_id
  FROM public.profiles
  WHERE email = v_admin_email;
  
  IF v_admin_id IS NOT NULL THEN
    UPDATE public.profiles
    SET 
      role = 'super_admin',
      account_type = 'admin',
      subscription_status = 'active',
      subscription_expires_at = '2099-12-31'::TIMESTAMPTZ,
      max_trades = 999999,
      is_banned = FALSE,
      updated_at = NOW()
    WHERE id = v_admin_id;
    
    RAISE NOTICE 'âœ… Admin setup complete for: %', v_admin_email;
  ELSE
    RAISE NOTICE 'âš ï¸  User not found: %. Admin will need to be set manually after registration.', v_admin_email;
  END IF;
END $$;
-- ===============================================
-- END OF PART 1/2 - v9.4.3-FIXED
-- ===============================================

COMMIT;

DO $$
DECLARE 
  profiles_count INTEGER;
  trades_count INTEGER;
  rls_check_admin_exists BOOLEAN;
  ticker_count INTEGER;
  admin_actions_exists BOOLEAN;
  payment_provider_col BOOLEAN;
  subscription_intervals BOOLEAN;
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—';
  RAISE NOTICE 'â•‘  âœ… PART 1/2 COMPLETE! (v9.4.3)       â•‘';
  RAISE NOTICE 'â•‘     ğŸ”’ TRADE LIMITS ENFORCED VIA RLS! â•‘';
  RAISE NOTICE 'â•‘     ğŸ”¥ NO RECURSION IN RLS!           â•‘';
  RAISE NOTICE 'â•‘     ğŸ“ Uses PUBLIC schema functions   â•‘';
  RAISE NOTICE 'â•‘     ğŸ†• FIXED: payment_history cols!   â•‘';
  RAISE NOTICE 'â•‘     ğŸ†• FIXED: subscription_changes!   â•‘';
  RAISE NOTICE 'â•‘     âœ… Helper functions INCLUDED!     â•‘';
  RAISE NOTICE 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
  RAISE NOTICE '';
  
  SELECT COUNT(*) INTO profiles_count
  FROM pg_policies WHERE schemaname = 'public' AND tablename = 'profiles';
  
  SELECT COUNT(*) INTO trades_count
  FROM pg_policies WHERE schemaname = 'public' AND tablename = 'trades';
  
  SELECT EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'rls_check_admin') 
  INTO rls_check_admin_exists;
  
  SELECT COUNT(*) INTO ticker_count FROM public.ticker_symbols;
  
  SELECT EXISTS (
    SELECT 1 FROM information_schema.tables 
    WHERE table_schema = 'public' AND table_name = 'admin_actions'
  ) INTO admin_actions_exists;
  
  SELECT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema = 'public' AND table_name = 'payment_history' AND column_name = 'payment_provider'
  ) INTO payment_provider_col;
  
  SELECT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema = 'public' AND table_name = 'subscription_changes' AND column_name = 'from_interval'
  ) INTO subscription_intervals;
  
  RAISE NOTICE 'ğŸ” Anti-Recursion: rls_check_admin() = %', 
    CASE WHEN rls_check_admin_exists THEN 'âœ… EXISTS' ELSE 'âŒ MISSING' END;
  RAISE NOTICE 'ğŸ“Š Profiles policies: %', profiles_count;
  RAISE NOTICE 'ğŸ“Š Trades policies: %', trades_count;
  RAISE NOTICE 'ğŸ¯ Ticker symbols: %', ticker_count;
  RAISE NOTICE 'ğŸ†• admin_actions table: %',
    CASE WHEN admin_actions_exists THEN 'âœ… EXISTS' ELSE 'âŒ MISSING' END;
  RAISE NOTICE 'ğŸ†• payment_history.payment_provider: %',
    CASE WHEN payment_provider_col THEN 'âœ… EXISTS' ELSE 'âŒ MISSING' END;
  RAISE NOTICE 'ğŸ†• subscription_changes intervals: %',
    CASE WHEN subscription_intervals THEN 'âœ… EXISTS' ELSE 'âŒ MISSING' END;
  RAISE NOTICE '';
  RAISE NOTICE 'âœ… All functions included - Part 1 is self-contained!';
  RAISE NOTICE 'âœ… Part 2 uses CREATE OR REPLACE (safe to run)';
  RAISE NOTICE '';
  RAISE NOTICE 'Next: Run Part 2/2 (Functions, Triggers, Views)';
  RAISE NOTICE '';
END $$;