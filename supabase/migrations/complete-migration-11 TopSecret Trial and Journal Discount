-- =====================================================
-- MIGRATION 11: Top Secret 14-Day Trial & Journal Discount
-- =====================================================
-- Added: 2024
--
-- Changes:
-- 1. Add Top Secret trial tracking columns
-- 2. Add Journal discount for newsletter/top_secret subscribers
-- 3. Update functions to handle trial period
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE '========================================';
  RAISE NOTICE 'ðŸš€ MIGRATION 11: Top Secret Trial & Journal Discount';
  RAISE NOTICE '========================================';
END $$;

-- =====================================================
-- PART 1: TOP SECRET TRIAL COLUMNS
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE 'ðŸ“¦ Adding Top Secret trial columns...';
END $$;

-- Add trial tracking columns for Top Secret
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS top_secret_trial_used BOOLEAN DEFAULT FALSE;
COMMENT ON COLUMN profiles.top_secret_trial_used IS 'Whether user has used their Top Secret 14-day trial';

ALTER TABLE profiles ADD COLUMN IF NOT EXISTS top_secret_trial_start_date TIMESTAMPTZ;
COMMENT ON COLUMN profiles.top_secret_trial_start_date IS 'When Top Secret trial started';

ALTER TABLE profiles ADD COLUMN IF NOT EXISTS top_secret_trial_ends_at TIMESTAMPTZ;
COMMENT ON COLUMN profiles.top_secret_trial_ends_at IS 'When Top Secret trial ends';

ALTER TABLE profiles ADD COLUMN IF NOT EXISTS top_secret_is_in_trial BOOLEAN DEFAULT FALSE;
COMMENT ON COLUMN profiles.top_secret_is_in_trial IS 'Whether user is currently in Top Secret trial period';

-- =====================================================
-- PART 2: JOURNAL DISCOUNT COLUMNS
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE 'ðŸ“¦ Adding Journal discount columns...';
END $$;

-- Add Journal discount tracking for newsletter/top_secret subscribers
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS journal_discount_available BOOLEAN DEFAULT FALSE;
COMMENT ON COLUMN profiles.journal_discount_available IS '25% one-time Journal discount available (for newsletter/top_secret subscribers)';

ALTER TABLE profiles ADD COLUMN IF NOT EXISTS journal_discount_percent INTEGER DEFAULT 25;
COMMENT ON COLUMN profiles.journal_discount_percent IS 'Discount percentage for Journal (default 25%)';

ALTER TABLE profiles ADD COLUMN IF NOT EXISTS journal_discount_used BOOLEAN DEFAULT FALSE;
COMMENT ON COLUMN profiles.journal_discount_used IS 'Whether user has used their Journal discount';

ALTER TABLE profiles ADD COLUMN IF NOT EXISTS journal_discount_used_at TIMESTAMPTZ;
COMMENT ON COLUMN profiles.journal_discount_used_at IS 'When Journal discount was used';

ALTER TABLE profiles ADD COLUMN IF NOT EXISTS journal_discount_source TEXT;
COMMENT ON COLUMN profiles.journal_discount_source IS 'Source of discount: top_secret, newsletter, promo';

-- =====================================================
-- PART 3: INDEXES
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE 'ðŸ“¦ Creating indexes...';
END $$;

CREATE INDEX IF NOT EXISTS idx_profiles_top_secret_trial
ON profiles(top_secret_is_in_trial) WHERE top_secret_is_in_trial = TRUE;

CREATE INDEX IF NOT EXISTS idx_profiles_journal_discount_available
ON profiles(journal_discount_available) WHERE journal_discount_available = TRUE;

-- =====================================================
-- PART 4: FUNCTION - Start Top Secret Trial
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE 'ðŸ“¦ Creating trial functions...';
END $$;

DROP FUNCTION IF EXISTS start_top_secret_trial(UUID);

CREATE OR REPLACE FUNCTION start_top_secret_trial(p_user_id UUID)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_profile RECORD;
  v_trial_end TIMESTAMPTZ;
BEGIN
  -- Get current profile
  SELECT
    top_secret_trial_used,
    top_secret_is_in_trial,
    top_secret_enabled
  INTO v_profile
  FROM profiles
  WHERE id = p_user_id;

  IF NOT FOUND THEN
    RETURN jsonb_build_object('success', false, 'error', 'User not found');
  END IF;

  -- Check if trial already used
  IF v_profile.top_secret_trial_used THEN
    RETURN jsonb_build_object('success', false, 'error', 'Trial already used');
  END IF;

  -- Check if already subscribed
  IF v_profile.top_secret_enabled THEN
    RETURN jsonb_build_object('success', false, 'error', 'Already subscribed to Top Secret');
  END IF;

  -- Calculate trial end (14 days from now)
  v_trial_end := NOW() + INTERVAL '14 days';

  -- Update profile with trial info
  UPDATE profiles SET
    top_secret_is_in_trial = TRUE,
    top_secret_trial_used = TRUE,
    top_secret_trial_start_date = NOW(),
    top_secret_trial_ends_at = v_trial_end,
    top_secret_enabled = TRUE,
    top_secret_status = 'active',
    top_secret_started_at = NOW(),
    top_secret_expires_at = v_trial_end,
    -- Also enable Journal discount for trial users
    journal_discount_available = TRUE,
    journal_discount_source = 'top_secret',
    updated_at = NOW()
  WHERE id = p_user_id;

  -- Log the event
  INSERT INTO subscription_events (
    user_id,
    event_type,
    new_plan,
    metadata
  ) VALUES (
    p_user_id,
    'trial_started',
    'top_secret',
    jsonb_build_object(
      'trial_days', 14,
      'trial_ends_at', v_trial_end,
      'source', 'post_signup'
    )
  );

  RETURN jsonb_build_object(
    'success', true,
    'trial_ends_at', v_trial_end,
    'journal_discount_enabled', true
  );
END;
$$;

-- =====================================================
-- PART 5: FUNCTION - Check and Expire Trials
-- =====================================================

DROP FUNCTION IF EXISTS check_expired_top_secret_trials();

CREATE OR REPLACE FUNCTION check_expired_top_secret_trials()
RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_expired_count INTEGER := 0;
  v_user RECORD;
BEGIN
  -- Find users whose trial has expired and no active subscription
  FOR v_user IN
    SELECT id, email, top_secret_trial_ends_at
    FROM profiles
    WHERE top_secret_is_in_trial = TRUE
      AND top_secret_trial_ends_at < NOW()
      AND top_secret_whop_membership_id IS NULL  -- No actual subscription
  LOOP
    -- Deactivate trial
    UPDATE profiles SET
      top_secret_is_in_trial = FALSE,
      top_secret_enabled = FALSE,
      top_secret_status = 'inactive',
      updated_at = NOW()
    WHERE id = v_user.id;

    -- Log the event
    INSERT INTO subscription_events (
      user_id,
      event_type,
      old_plan,
      metadata
    ) VALUES (
      v_user.id,
      'trial_expired',
      'top_secret',
      jsonb_build_object(
        'trial_ended_at', v_user.top_secret_trial_ends_at
      )
    );

    v_expired_count := v_expired_count + 1;
  END LOOP;

  RETURN v_expired_count;
END;
$$;

-- =====================================================
-- PART 6: FUNCTION - Grant Journal Discount
-- =====================================================

DROP FUNCTION IF EXISTS grant_journal_discount(UUID, TEXT, INTEGER);

CREATE OR REPLACE FUNCTION grant_journal_discount(
  p_user_id UUID,
  p_source TEXT DEFAULT 'top_secret',
  p_percent INTEGER DEFAULT 25
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_profile RECORD;
BEGIN
  -- Get current profile
  SELECT
    journal_discount_available,
    journal_discount_used
  INTO v_profile
  FROM profiles
  WHERE id = p_user_id;

  IF NOT FOUND THEN
    RETURN jsonb_build_object('success', false, 'error', 'User not found');
  END IF;

  -- Check if discount already used
  IF v_profile.journal_discount_used THEN
    RETURN jsonb_build_object('success', false, 'error', 'Discount already used');
  END IF;

  -- Grant discount
  UPDATE profiles SET
    journal_discount_available = TRUE,
    journal_discount_percent = p_percent,
    journal_discount_source = p_source,
    updated_at = NOW()
  WHERE id = p_user_id;

  RETURN jsonb_build_object(
    'success', true,
    'discount_percent', p_percent,
    'source', p_source
  );
END;
$$;

-- =====================================================
-- PART 7: FUNCTION - Use Journal Discount
-- =====================================================

DROP FUNCTION IF EXISTS use_journal_discount(UUID);

CREATE OR REPLACE FUNCTION use_journal_discount(p_user_id UUID)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_profile RECORD;
BEGIN
  -- Get current profile
  SELECT
    journal_discount_available,
    journal_discount_used,
    journal_discount_percent
  INTO v_profile
  FROM profiles
  WHERE id = p_user_id;

  IF NOT FOUND THEN
    RETURN jsonb_build_object('success', false, 'error', 'User not found');
  END IF;

  -- Check if discount available
  IF NOT v_profile.journal_discount_available THEN
    RETURN jsonb_build_object('success', false, 'error', 'No discount available');
  END IF;

  -- Check if already used
  IF v_profile.journal_discount_used THEN
    RETURN jsonb_build_object('success', false, 'error', 'Discount already used');
  END IF;

  -- Mark discount as used
  UPDATE profiles SET
    journal_discount_used = TRUE,
    journal_discount_used_at = NOW(),
    updated_at = NOW()
  WHERE id = p_user_id;

  RETURN jsonb_build_object(
    'success', true,
    'discount_percent', v_profile.journal_discount_percent,
    'used_at', NOW()
  );
END;
$$;

-- =====================================================
-- PART 8: GRANT DISCOUNT TO EXISTING NEWSLETTER SUBSCRIBERS
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE 'ðŸ“¦ Granting discount to existing newsletter subscribers...';
END $$;

-- Grant Journal discount to all existing newsletter subscribers who haven't used it
UPDATE profiles SET
  journal_discount_available = TRUE,
  journal_discount_percent = 25,
  journal_discount_source = 'newsletter'
WHERE newsletter_enabled = TRUE
  AND (journal_discount_used IS NULL OR journal_discount_used = FALSE)
  AND (journal_discount_available IS NULL OR journal_discount_available = FALSE);

-- Grant Journal discount to all existing Top Secret subscribers
UPDATE profiles SET
  journal_discount_available = TRUE,
  journal_discount_percent = 25,
  journal_discount_source = 'top_secret'
WHERE top_secret_enabled = TRUE
  AND (journal_discount_used IS NULL OR journal_discount_used = FALSE)
  AND (journal_discount_available IS NULL OR journal_discount_available = FALSE);

-- =====================================================
-- PART 9: TRIGGER - Auto-grant discount on newsletter subscribe
-- =====================================================

DROP FUNCTION IF EXISTS auto_grant_journal_discount() CASCADE;

CREATE OR REPLACE FUNCTION auto_grant_journal_discount()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- When user subscribes to newsletter, grant Journal discount
  IF NEW.newsletter_enabled = TRUE AND
     (OLD.newsletter_enabled IS NULL OR OLD.newsletter_enabled = FALSE) AND
     (NEW.journal_discount_used IS NULL OR NEW.journal_discount_used = FALSE) THEN
    NEW.journal_discount_available := TRUE;
    NEW.journal_discount_percent := 25;
    NEW.journal_discount_source := 'newsletter';
  END IF;

  -- When user gets Top Secret, grant Journal discount
  IF NEW.top_secret_enabled = TRUE AND
     (OLD.top_secret_enabled IS NULL OR OLD.top_secret_enabled = FALSE) AND
     (NEW.journal_discount_used IS NULL OR NEW.journal_discount_used = FALSE) THEN
    NEW.journal_discount_available := TRUE;
    NEW.journal_discount_percent := 25;
    NEW.journal_discount_source := 'top_secret';
  END IF;

  RETURN NEW;
END;
$$;

DROP TRIGGER IF EXISTS trigger_auto_grant_journal_discount ON profiles;

CREATE TRIGGER trigger_auto_grant_journal_discount
  BEFORE UPDATE ON profiles
  FOR EACH ROW
  EXECUTE FUNCTION auto_grant_journal_discount();

-- =====================================================
-- PART 10: PERMISSIONS
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE 'ðŸ“¦ Granting permissions...';
END $$;

GRANT EXECUTE ON FUNCTION start_top_secret_trial(UUID) TO service_role, authenticated;
GRANT EXECUTE ON FUNCTION check_expired_top_secret_trials() TO service_role;
GRANT EXECUTE ON FUNCTION grant_journal_discount(UUID, TEXT, INTEGER) TO service_role, authenticated;
GRANT EXECUTE ON FUNCTION use_journal_discount(UUID) TO service_role, authenticated;

-- =====================================================
-- PART 11: CREATE COUPON FOR JOURNAL DISCOUNT
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE 'ðŸ“¦ Creating Journal discount coupon...';
END $$;

-- Insert coupon for 25% Journal discount (if admin_coupons table exists)
INSERT INTO admin_coupons (
  code,
  name,
  description,
  discount_type,
  discount_percent,
  duration_type,
  is_active,
  applicable_plans,
  first_time_only,
  stackable_with_affiliate,
  priority
) VALUES (
  'TOPSECRET25',
  'Top Secret Subscriber Discount',
  '25% off first month of Trading Journal for Top Secret/Newsletter subscribers',
  'percentage',
  25,
  'one_time',
  TRUE,
  ARRAY['basic_monthly', 'basic_yearly', 'premium_monthly', 'premium_yearly'],
  TRUE,
  FALSE,
  100
) ON CONFLICT (code) DO UPDATE SET
  is_active = TRUE,
  discount_percent = 25,
  updated_at = NOW();

-- =====================================================
-- VERIFICATION
-- =====================================================

DO $$
BEGIN
  RAISE NOTICE '========================================';
  RAISE NOTICE 'âœ… Migration 11 Complete!';
  RAISE NOTICE '========================================';
  RAISE NOTICE '';
  RAISE NOTICE 'New columns added:';
  RAISE NOTICE '  â€¢ top_secret_trial_used';
  RAISE NOTICE '  â€¢ top_secret_trial_start_date';
  RAISE NOTICE '  â€¢ top_secret_trial_ends_at';
  RAISE NOTICE '  â€¢ top_secret_is_in_trial';
  RAISE NOTICE '  â€¢ journal_discount_available';
  RAISE NOTICE '  â€¢ journal_discount_percent';
  RAISE NOTICE '  â€¢ journal_discount_used';
  RAISE NOTICE '  â€¢ journal_discount_used_at';
  RAISE NOTICE '  â€¢ journal_discount_source';
  RAISE NOTICE '';
  RAISE NOTICE 'New functions:';
  RAISE NOTICE '  â€¢ start_top_secret_trial(user_id)';
  RAISE NOTICE '  â€¢ check_expired_top_secret_trials()';
  RAISE NOTICE '  â€¢ grant_journal_discount(user_id, source, percent)';
  RAISE NOTICE '  â€¢ use_journal_discount(user_id)';
  RAISE NOTICE '';
  RAISE NOTICE 'Coupon created: TOPSECRET25 (25% off Journal)';
END $$;

-- Show verification
SELECT
  CASE WHEN EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'profiles' AND column_name = 'top_secret_trial_used') THEN 'âœ…' ELSE 'âŒ' END as trial_used,
  CASE WHEN EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'profiles' AND column_name = 'top_secret_is_in_trial') THEN 'âœ…' ELSE 'âŒ' END as is_in_trial,
  CASE WHEN EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'profiles' AND column_name = 'journal_discount_available') THEN 'âœ…' ELSE 'âŒ' END as discount_available,
  CASE WHEN EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'profiles' AND column_name = 'journal_discount_used') THEN 'âœ…' ELSE 'âŒ' END as discount_used;
