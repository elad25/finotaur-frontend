-- Macro cache table
CREATE TABLE IF NOT EXISTS macro_cache (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  symbol TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  category TEXT NOT NULL,
  price DECIMAL,
  daily_change DECIMAL,
  daily_change_percent DECIMAL,
  weekly_change DECIMAL,
  weekly_change_percent DECIMAL,
  volume TEXT,
  risk_sentiment TEXT DEFAULT 'Neutral',
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for faster lookups
CREATE INDEX IF NOT EXISTS idx_macro_cache_symbol ON macro_cache(symbol);

-- Allow public read, service role write
ALTER TABLE macro_cache ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public read access" ON macro_cache
  FOR SELECT USING (true);

CREATE POLICY "Service role write access" ON macro_cache
  FOR ALL USING (auth.role() = 'service_role');
  -- Migration: Create macro_cache table for storing market data during market closures
-- This table is used by the /api/macro/snapshot endpoint

CREATE TABLE IF NOT EXISTS macro_cache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  symbol TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  category TEXT NOT NULL,
  price DECIMAL(20, 6),
  daily_change DECIMAL(20, 6),
  daily_change_percent DECIMAL(10, 4),
  weekly_change DECIMAL(20, 6),
  weekly_change_percent DECIMAL(10, 4),
  volume TEXT,
  risk_sentiment TEXT DEFAULT 'Neutral',
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create index for faster lookups
CREATE INDEX IF NOT EXISTS idx_macro_cache_symbol ON macro_cache(symbol);
CREATE INDEX IF NOT EXISTS idx_macro_cache_category ON macro_cache(category);
CREATE INDEX IF NOT EXISTS idx_macro_cache_updated ON macro_cache(updated_at DESC);

-- Insert initial data if empty
INSERT INTO macro_cache (symbol, name, category, risk_sentiment)
SELECT * FROM (VALUES
  ('SPX', 'S&P 500', 'index', 'Neutral'),
  ('NDX', 'Nasdaq 100', 'index', 'Neutral'),
  ('DJI', 'Dow Jones', 'index', 'Neutral'),
  ('RUT', 'Russell 2000', 'index', 'Neutral'),
  ('VIX', 'Volatility Index', 'volatility', 'Neutral'),
  ('TNX', 'US 10Y Yield', 'bond', 'Neutral'),
  ('DXY', 'US Dollar Index', 'currency', 'Neutral'),
  ('CL', 'Crude Oil (WTI)', 'commodity', 'Neutral'),
  ('GC', 'Gold', 'commodity', 'Neutral'),
  ('BTC', 'Bitcoin', 'crypto', 'Neutral')
) AS t(symbol, name, category, risk_sentiment)
WHERE NOT EXISTS (SELECT 1 FROM macro_cache LIMIT 1);

-- RLS Policies (optional - enable if needed)
-- ALTER TABLE macro_cache ENABLE ROW LEVEL SECURITY;
-- CREATE POLICY "Allow public read" ON macro_cache FOR SELECT USING (true);
-- CREATE POLICY "Allow service write" ON macro_cache FOR ALL USING (auth.role() = 'service_role');

COMMENT ON TABLE macro_cache IS 'Cache for macro market data during market closures';
-- ============================================================
-- RATES CACHE TABLE
-- For storing interest rate data when APIs are unavailable
-- ============================================================

-- Create rates_cache table
CREATE TABLE IF NOT EXISTS rates_cache (
  id TEXT PRIMARY KEY,
  data JSONB NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create index for faster lookups
CREATE INDEX IF NOT EXISTS idx_rates_cache_updated_at ON rates_cache(updated_at DESC);

-- Add comment
COMMENT ON TABLE rates_cache IS 'Cache for central bank interest rate data';

-- ============================================================
-- OPTIONAL: Historical rate decisions table
-- For storing historical rate decision data
-- ============================================================

CREATE TABLE IF NOT EXISTS rate_decisions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bank_id TEXT NOT NULL,
  decision_date DATE NOT NULL,
  previous_rate DECIMAL(5,2),
  new_rate DECIMAL(5,2) NOT NULL,
  change_amount DECIMAL(5,2) NOT NULL,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Prevent duplicate entries for same bank on same date
  UNIQUE(bank_id, decision_date)
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_rate_decisions_bank_id ON rate_decisions(bank_id);
CREATE INDEX IF NOT EXISTS idx_rate_decisions_date ON rate_decisions(decision_date DESC);

-- Add comment
COMMENT ON TABLE rate_decisions IS 'Historical central bank rate decision records';

-- ============================================================
-- OPTIONAL: Yield history table
-- For storing treasury yield snapshots
-- ============================================================

CREATE TABLE IF NOT EXISTS yield_snapshots (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  symbol TEXT NOT NULL,
  name TEXT NOT NULL,
  maturity TEXT NOT NULL,
  yield_value DECIMAL(6,3) NOT NULL,
  change_value DECIMAL(6,3),
  snapshot_date DATE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Prevent duplicate entries
  UNIQUE(symbol, snapshot_date)
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_yield_snapshots_symbol ON yield_snapshots(symbol);
CREATE INDEX IF NOT EXISTS idx_yield_snapshots_date ON yield_snapshots(snapshot_date DESC);

-- Add comment
COMMENT ON TABLE yield_snapshots IS 'Daily treasury yield snapshots';

-- ============================================================
-- RLS POLICIES (Optional - if you want public read access)
-- ============================================================

-- Enable RLS
ALTER TABLE rates_cache ENABLE ROW LEVEL SECURITY;
ALTER TABLE rate_decisions ENABLE ROW LEVEL SECURITY;
ALTER TABLE yield_snapshots ENABLE ROW LEVEL SECURITY;

-- Public read access for all authenticated users
CREATE POLICY "rates_cache_select_all" ON rates_cache
  FOR SELECT USING (true);

CREATE POLICY "rate_decisions_select_all" ON rate_decisions
  FOR SELECT USING (true);

CREATE POLICY "yield_snapshots_select_all" ON yield_snapshots
  FOR SELECT USING (true);

-- Only service role can insert/update
CREATE POLICY "rates_cache_insert_service" ON rates_cache
  FOR INSERT WITH CHECK (auth.role() = 'service_role');

CREATE POLICY "rates_cache_update_service" ON rates_cache
  FOR UPDATE USING (auth.role() = 'service_role');

CREATE POLICY "rate_decisions_insert_service" ON rate_decisions
  FOR INSERT WITH CHECK (auth.role() = 'service_role');

CREATE POLICY "yield_snapshots_insert_service" ON yield_snapshots
  FOR INSERT WITH CHECK (auth.role() = 'service_role');
  -- ============================================================
-- RATES CACHE TABLE
-- For storing interest rate data when APIs are unavailable
-- ============================================================

-- Create rates_cache table
CREATE TABLE IF NOT EXISTS rates_cache (
  id TEXT PRIMARY KEY,
  data JSONB NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create index for faster lookups
CREATE INDEX IF NOT EXISTS idx_rates_cache_updated_at ON rates_cache(updated_at DESC);

-- Add comment
COMMENT ON TABLE rates_cache IS 'Cache for central bank interest rate data';

-- ============================================================
-- OPTIONAL: Historical rate decisions table
-- For storing historical rate decision data
-- ============================================================

CREATE TABLE IF NOT EXISTS rate_decisions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bank_id TEXT NOT NULL,
  decision_date DATE NOT NULL,
  previous_rate DECIMAL(5,2),
  new_rate DECIMAL(5,2) NOT NULL,
  change_amount DECIMAL(5,2) NOT NULL,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Prevent duplicate entries for same bank on same date
  UNIQUE(bank_id, decision_date)
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_rate_decisions_bank_id ON rate_decisions(bank_id);
CREATE INDEX IF NOT EXISTS idx_rate_decisions_date ON rate_decisions(decision_date DESC);

-- Add comment
COMMENT ON TABLE rate_decisions IS 'Historical central bank rate decision records';

-- ============================================================
-- OPTIONAL: Yield history table
-- For storing treasury yield snapshots
-- ============================================================

CREATE TABLE IF NOT EXISTS yield_snapshots (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  symbol TEXT NOT NULL,
  name TEXT NOT NULL,
  maturity TEXT NOT NULL,
  yield_value DECIMAL(6,3) NOT NULL,
  change_value DECIMAL(6,3),
  snapshot_date DATE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Prevent duplicate entries
  UNIQUE(symbol, snapshot_date)
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_yield_snapshots_symbol ON yield_snapshots(symbol);
CREATE INDEX IF NOT EXISTS idx_yield_snapshots_date ON yield_snapshots(snapshot_date DESC);

-- Add comment
COMMENT ON TABLE yield_snapshots IS 'Daily treasury yield snapshots';

-- ============================================================
-- RLS POLICIES (Optional - if you want public read access)
-- ============================================================

-- Enable RLS
ALTER TABLE rates_cache ENABLE ROW LEVEL SECURITY;
ALTER TABLE rate_decisions ENABLE ROW LEVEL SECURITY;
ALTER TABLE yield_snapshots ENABLE ROW LEVEL SECURITY;

-- Public read access for all authenticated users
CREATE POLICY "rates_cache_select_all" ON rates_cache
  FOR SELECT USING (true);

CREATE POLICY "rate_decisions_select_all" ON rate_decisions
  FOR SELECT USING (true);

CREATE POLICY "yield_snapshots_select_all" ON yield_snapshots
  FOR SELECT USING (true);

-- Only service role can insert/update
CREATE POLICY "rates_cache_insert_service" ON rates_cache
  FOR INSERT WITH CHECK (auth.role() = 'service_role');

CREATE POLICY "rates_cache_update_service" ON rates_cache
  FOR UPDATE USING (auth.role() = 'service_role');

CREATE POLICY "rate_decisions_insert_service" ON rate_decisions
  FOR INSERT WITH CHECK (auth.role() = 'service_role');

CREATE POLICY "yield_snapshots_insert_service" ON yield_snapshots
  FOR INSERT WITH CHECK (auth.role() = 'service_role');